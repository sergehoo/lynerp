# docker-compose.yml
networks:
  web:
    driver: bridge
  proxy:
    external: true   # docker network ls | grep proxy || docker network create proxy

volumes:
  pg_data:
  redis_data:
  minio_data:
  rh_media:
  static_volume:

services:
  # === Base de données Postgres ===
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks: [web]
    restart: unless-stopped

  # === Redis (cache / broker) ===
  redis:
    image: redis:7-alpine
    command: ["redis-server","--save","","--appendonly","no"]
    healthcheck:
      test: ["CMD", "redis-cli", "PING"]
      interval: 10s
      timeout: 5s
      retries: 20
    volumes:
      - redis_data:/data
    networks: [web]
    restart: unless-stopped

  # === MinIO (S3) ===
  minio:
    image: minio/minio:RELEASE.2025-02-18T16-25-55Z
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - web
      - proxy
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy

      # API S3
      - traefik.http.routers.minio-api.rule=Host(`${MINIO_API_HOST}`)
      - traefik.http.routers.minio-api.entrypoints=websecure
      - traefik.http.routers.minio-api.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.routers.minio-api.service=minio-api
      - traefik.http.services.minio-api.loadbalancer.server.port=9000

      # Console
      - traefik.http.routers.minio-console.rule=Host(`${MINIO_CONSOLE_HOST}`)
      - traefik.http.routers.minio-console.entrypoints=websecure
      - traefik.http.routers.minio-console.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.routers.minio-console.service=minio-console
      - traefik.http.services.minio-console.loadbalancer.server.port=9001

  # === Keycloak (SSO) ===
  keycloak:
    image: quay.io/keycloak/keycloak:26.3.1-0
    command:
      - start-dev
      - --hostname=${KEYCLOAK_HOST}                # ex: https://sso.example.com
      - --proxy-headers=xforwarded
      - --hostname-strict=false
      - --http-enabled=true
      - --http-relative-path=/
    env_file: .env

    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - web
      - proxy
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.keycloak.rule=Host(`${KEYCLOAK_HOST}`)
      - traefik.http.routers.keycloak.entrypoints=websecure
      - traefik.http.routers.keycloak.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.services.keycloak-svc.loadbalancer.server.port=8080
      - traefik.http.routers.keycloak.service=keycloak-svc

  # === Kong (API Gateway) — optionnel, derrière Traefik ===
  kong:
    image: kong:3
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong.yml
      KONG_PROXY_LISTEN: 0.0.0.0:8000
      KONG_ADMIN_LISTEN: 0.0.0.0:8001
    volumes:
      - ./ops/kong/kong.yml:/kong.yml:ro
    depends_on:
      - rh
      - keycloak
      - minio
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - web
      - proxy
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      # Proxy public (clients) -> Kong :8000
      - traefik.http.routers.kong.rule=Host(`${KONG_HOST}`)
      - traefik.http.routers.kong.entrypoints=websecure
      - traefik.http.routers.kong.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.services.kong-svc.loadbalancer.server.port=8000
      - traefik.http.routers.kong.service=kong-svc

      # Admin (à restreindre en prod)
      - traefik.http.routers.kong-admin.rule=Host(`${KONG_ADMIN_HOST}`)
      - traefik.http.routers.kong-admin.entrypoints=websecure
      - traefik.http.routers.kong-admin.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.services.kong-admin-svc.loadbalancer.server.port=8001
      - traefik.http.routers.kong-admin.service=kong-admin-svc

  # === Application Django (Gunicorn/ASGI) ===
  rh:
    build:
      context: .
      dockerfile: ./Dockerfile
    env_file: .env
    command: ["/entrypoint.sh", "gunicorn", "-k", "uvicorn.workers.UvicornWorker", "-b", "0.0.0.0:8000", "lyneerp.asgi:application"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
    volumes:
      - ./:/app:cached
      - rh_media:/app/media
      - static_volume:/app/staticfiles
    networks:
      - web
      - proxy
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy

      - traefik.http.routers.rh.rule=Host(`${RH_HOST}`)
      - traefik.http.routers.rh.entrypoints=websecure
      - traefik.http.routers.rh.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.middlewares.rh-sec-headers.headers.stsSeconds=31536000
#      - traefik.http.middlewares.rh-sec-headers.headers.stsIncludeSubdomains=true
#      - traefik.http.middlewares.rh-sec-headers.headers.stsPreload=true
#      - traefik.http.middlewares.rh-sec-headers.headers.contentTypeNosniff=true
#      - traefik.http.middlewares.rh-sec-headers.headers.frameDeny=true
      - traefik.http.middlewares.rh-sec-headers.headers.referrerPolicy=strict-origin-when-cross-origin
      - traefik.http.middlewares.rh-compress.compress=true
      - traefik.http.routers.rh.middlewares=rh-sec-headers@docker,rh-compress@docker
      - traefik.http.services.rh-svc.loadbalancer.server.port=8000
      - traefik.http.routers.rh.service=rh-svc

  # === Mailpit (emails de dev) ===
  mailpit:
    image: axllent/mailpit:latest
    environment:
      MP_MAX_MESSAGES: 10000
    networks:
      - web
      - proxy
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.mailpit.rule=Host(`${MAILPIT_HOST}`)
      - traefik.http.routers.mailpit.entrypoints=websecure
      - traefik.http.routers.mailpit.tls.certresolver=${TRAEFIK_CERTRESOLVER}
      - traefik.http.services.mailpit-svc.loadbalancer.server.port=8025