<!-- Lyneerp/hr/templates/registration/login.html -->
<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connexion • LyneERP</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    * { font-family: ui-sans-serif, system-ui, -apple-system, "Inter", Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(79,70,229,.15); }
    .btn-gradient { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .btn-gradient:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .floating-label { transform: translateY(-50%); transition: all .15s ease; }
    .input-filled + .floating-label, .input-focused + .floating-label {
      top: 0; font-size: .75rem; color: #4f46e5; background: white; padding: 0 .4rem; margin-left: .4rem;
    }
  </style>
</head>
<body class="h-full bg-gray-50">
<div class="min-h-full flex">
  <!-- Bandeau gauche (identique à avant) -->
  <aside class="hidden lg:flex lg:flex-1 lg:flex-col gradient-bg text-white">
    <!-- … contenu inchangé … -->
  </aside>

  <!-- Formulaire -->
  <main class="flex-1 flex flex-col justify-center py-12 px-4 sm:px-6 lg:px-16 xl:px-24">
    <div class="mx-auto w-full max-w-md">

      <!-- Logo mobile (identique) -->

      <section class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
        <div class="text-center mb-7">
          <h2 class="text-3xl font-bold text-gray-900">Connexion</h2>
          <p class="text-gray-600 mt-1">Authentification via Keycloak</p>
        </div>

        <div id="errorBox" class="hidden mb-5 p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm"></div>

        <form id="kcLoginForm" class="space-y-6" novalidate>
          {% csrf_token %}

          <!-- PLUS DE CHAMP TENANT ICI -->

          <div class="relative">
            <input type="text" id="username" name="username" required autocomplete="username"
                   class="w-full px-4 py-4 border border-gray-300 rounded-xl input-focus transition duration-200 peer input-filled"
                   placeholder=" ">
            <label for="username" class="floating-label absolute left-4 top-1/2 text-gray-500 pointer-events-none">
              Nom d’utilisateur
            </label>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-user"></i></div>
          </div>

          <div class="relative">
            <input type="password" id="password" name="password" required autocomplete="current-password"
                   class="w-full px-4 py-4 border border-gray-300 rounded-xl input-focus transition duration-200 peer input-filled pr-12"
                   placeholder=" ">
            <label for="password" class="floating-label absolute left-4 top-1/2 text-gray-500 pointer-events-none">
              Mot de passe
            </label>
            <button type="button" onclick="togglePassword()"
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-eye" id="password-toggle"></i>
            </button>
          </div>

          <div class="flex items-center justify-between">
            <label class="flex items-center gap-2 text-sm text-gray-700">
              <input type="checkbox" id="remember_me" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
              Se souvenir de moi
            </label>
            <a class="text-sm text-indigo-600 hover:text-indigo-700" href="#">Mot de passe oublié ?</a>
          </div>

          <button id="submitBtn" type="submit"
                  class="w-full btn-gradient text-white py-4 rounded-xl font-semibold shadow-lg transition duration-200 disabled:opacity-60 disabled:cursor-not-allowed">
            <span class="inline-flex items-center gap-2">
              <i class="fas fa-sign-in-alt"></i><span>Se connecter</span>
            </span>
          </button>

          <input type="hidden" id="next" value="{{ next|default:'/' }}">
        </form>

        <!-- SSO boutons (optionnels) -->
        <div class="relative my-6">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
          <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">SSO</span></div>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <button type="button" class="py-3 px-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition">
            <i class="fab fa-microsoft text-indigo-600 mr-2"></i><span class="text-sm font-medium text-gray-700">Azure AD</span>
          </button>
         <button type="button" class="py-3 px-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition"
        onclick="window.location.href='/oidc/authenticate/?next=' + encodeURIComponent(document.getElementById('next')?.value || '/')">
  <i class="fas fa-key text-green-600 mr-2"></i><span class="text-sm font-medium text-gray-700">Keycloak</span>
</button>
        </div>
      </section>

      <p class="mt-8 text-center text-gray-500 text-sm">
        Nouveau sur LyneERP ?
        <a href="#" class="text-indigo-600 font-medium hover:text-indigo-700">Créer un compte</a>
      </p>
    </div>
  </main>
</div>

<script>
  // ====== CONFIG OIDC ======
  const KC_CONFIG = {
    issuer: "https://sso.lyneerp.com/realms/lyneerp",
    clientId: "rh-core",            // Public client avec Direct Access Grants = ON
    clientSecret: null
  };
  const TOKEN_URL = KC_CONFIG.issuer + "/protocol/openid-connect/token";

  const errorBox = document.getElementById("errorBox");
  const submitBtn = document.getElementById("submitBtn");

  function showError(msg){ errorBox.textContent = msg; errorBox.classList.remove("hidden"); }
  function clearError(){ errorBox.classList.add("hidden"); errorBox.textContent = ""; }
  function togglePassword(){
    const i = document.getElementById('password'); const ic = document.getElementById('password-toggle');
    if (i.type === 'password'){ i.type = 'text'; ic.classList.replace('fa-eye','fa-eye-slash'); }
    else { i.type = 'password'; ic.classList.replace('fa-eye-slash','fa-eye'); }
  }

  // === Résolution tenant ===
  function tenantFromSubdomain(){
    // ex: acme.rh.lyneerp.com -> "acme"
    const host = window.location.hostname; // ex acme.rh.lyneerp.com
    const parts = host.split('.');
    // adapte selon ta topo de domaines : <tenant>.rh.lyneerp.com ou <tenant>.lyneerp.com
    // Ici on prend le premier label si plus de 2 labels
    if (parts.length > 2) return parts[0];
    return null;
  }

  // Décoder JWT (sans validation) pour lire un éventuel claim 'tenant'
  function parseJwt(t){
    try{
      const b64 = t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
      return JSON.parse(decodeURIComponent(escape(window.atob(b64))));
    }catch{ return {}; }
  }

  async function establishAppSession(accessToken, tenant){
    try{
       await fetch("/auth/exchange/", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "X-Tenant-Id": tenant || "",
          "X-CSRFToken": getCookie("csrftoken") || ""
        },
        body: JSON.stringify({ access_token: accessToken, remember: document.getElementById("remember_me")?.checked || false })
      });
      return true;
    }catch{ return false; }
  }

  function storeTokens(payload, remember){
    const s = (remember ? localStorage : sessionStorage);
    s.setItem("kc_access_token", payload.access_token);
    if (payload.refresh_token) s.setItem("kc_refresh_token", payload.refresh_token);
    s.setItem("kc_token_type", payload.token_type || "Bearer");
    s.setItem("kc_expires_in", String(payload.expires_in || 0));
  }

  async function loginWithKeycloak({username, password}){
    // 1) On tente d’abord par sous-domaine
    let tenant = tenantFromSubdomain();

    const form = new URLSearchParams();
    form.append("grant_type", "password");
    form.append("client_id", KC_CONFIG.clientId);
    if (KC_CONFIG.clientSecret) form.append("client_secret", KC_CONFIG.clientSecret);
    form.append("username", username);
    form.append("password", password);

    const res = await fetch(TOKEN_URL, {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded"},
      body: form
    });

    if (!res.ok){
      const text = await res.text();
      throw new Error(text || "Erreur Keycloak");
    }

    const payload = await res.json();          // contient access_token
    storeTokens(payload, document.getElementById("remember_me")?.checked);

    // 2) Si pas de sous-domaine, on lit un claim 'tenant' (configuré dans Keycloak)
    if (!tenant){
      const jwt = parseJwt(payload.access_token);
      tenant = jwt?.tenant || jwt?.['realm_access']?.['roles']?.find(r => r.startsWith('tenant:'))?.split(':')[1] || null;
    }

    // 3) Mémoriser le tenant pour les prochains appels API
    if (tenant) localStorage.setItem("current_tenant", tenant);

    // 4) (optionnel) Créer une session locale
    await establishAppSession(payload.access_token, tenant);

    // 5) Redirection
    const nextUrl = document.getElementById("next")?.value || "/";
    window.location.assign(nextUrl);
  }

  document.getElementById("kcLoginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    clearError();
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<span class="inline-flex items-center gap-2"><i class="fa-solid fa-spinner animate-spin"></i> Connexion…</span>`;
    try{
      const username = document.getElementById("username")?.value?.trim();
      const password = document.getElementById("password")?.value || "";
      if (!username || !password) throw new Error("Tous les champs sont requis.");
      await loginWithKeycloak({username, password});
    }catch(err){
      console.error(err);
      showError("Échec de connexion. Vérifie les identifiants ou la config Keycloak (CORS / Direct Access Grants).");
    }finally{
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<span class="inline-flex items-center gap-2"><i class="fas fa-sign-in-alt"></i><span>Se connecter</span></span>`;
    }
  });

  // Effets labels
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('input[type=\"text\"], input[type=\"password\"]').forEach(input=>{
      if (input.value) input.classList.add('input-filled');
      input.addEventListener('focus', ()=> input.classList.add('input-focused'));
      input.addEventListener('blur', ()=> { input.classList.remove('input-focused'); if (!input.value) input.classList.remove('input-filled'); });
      input.addEventListener('input', ()=> input.classList.toggle('input-filled', !!input.value));
    });
  });
</script>
</body>
</html>