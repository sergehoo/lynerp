<!-- Lyneerp/hr/templates/registration/login.html -->
<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Connexion • LyneERP</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    * { font-family: ui-sans-serif, system-ui, -apple-system, "Inter", Segoe UI, Roboto, "Helvetica Neue", Arial; }
    .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(79,70,229,.15); }
    .btn-gradient { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
    .btn-gradient:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .floating-label { transform: translateY(-50%); transition: all .15s ease; }
    .input-filled + .floating-label, .input-focused + .floating-label {
      top: 0; font-size: .75rem; color: #4f46e5; background: white; padding: 0 .4rem; margin-left: .4rem;
    }
  </style>
</head>
<body class="h-full bg-gray-50">
<div class="min-h-full flex">
  <!-- Bandeau gauche -->
  <aside class="hidden lg:flex lg:flex-1 lg:flex-col gradient-bg text-white">
    <div class="flex-1 flex flex-col justify-center py-12 px-12 xl:px-20 2xl:px-28">
      <div class="flex items-center space-x-3 mb-12">
        <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
          <i class="fas fa-users text-white text-xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold">LyneERP</h1>
          <p class="text-white/80 text-sm">Suite RH intelligente</p>
        </div>
      </div>

      <h2 class="text-4xl font-bold leading-tight mb-5">Connectez-vous sans friction</h2>
      <p class="text-white/90 text-lg mb-10">Recrutement, employés, pointage, congés — en un seul endroit.</p>

      <ul class="space-y-3 text-white/90">
        <li class="flex items-center gap-3"><i class="fa-solid fa-check w-6 h-6 grid place-items-center rounded-full bg-white/20 text-xs"></i> SSO Keycloak prêt</li>
        <li class="flex items-center gap-3"><i class="fa-solid fa-check w-6 h-6 grid place-items-center rounded-full bg-white/20 text-xs"></i> Tableaux en temps réel</li>
        <li class="flex items-center gap-3"><i class="fa-solid fa-check w-6 h-6 grid place-items-center rounded-full bg-white/20 text-xs"></i> Gouvernance multi-tenant</li>
      </ul>
    </div>
    <footer class="border-t border-white/20 py-6 px-10 text-white/70 text-sm flex items-center justify-between">
      <span>&copy; 2025 LyneERP</span>
      <nav class="flex gap-5">
        <a href="#" class="hover:text-white">Confidentialité</a>
        <a href="#" class="hover:text-white">Conditions</a>
        <a href="#" class="hover:text-white">Support</a>
      </nav>
    </footer>
  </aside>

  <!-- Formulaire -->
  <main class="flex-1 flex flex-col justify-center py-12 px-4 sm:px-6 lg:px-16 xl:px-24">
    <div class="mx-auto w-full max-w-md">
      <div class="lg:hidden flex justify-center mb-8">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 gradient-bg rounded-xl grid place-items-center">
            <i class="fas fa-users text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-gray-900">LyneERP</h1>
            <p class="text-gray-600 text-sm">Espace RH</p>
          </div>
        </div>
      </div>

      <section class="bg-white rounded-2xl shadow-xl border border-gray-200 p-8">
        <div class="text-center mb-7">
          <h2 class="text-3xl font-bold text-gray-900">Connexion</h2>
          <p class="text-gray-600 mt-1">Authentification via Keycloak</p>
        </div>

        <!-- Zone erreurs -->
        <div id="errorBox" class="hidden mb-5 p-4 rounded-xl border border-red-200 bg-red-50 text-red-700 text-sm"></div>

        <!-- Form -->
        <form id="kcLoginForm" class="space-y-6" novalidate>
          {% csrf_token %}

          <!-- Tenant (stocké côté app; Keycloak ne l’utilise pas) -->
          <div class="relative">
            <input type="text" id="tenant_id" name="tenant_id" required
                   class="w-full px-4 py-4 border border-gray-300 rounded-xl input-focus transition duration-200 peer input-filled"
                   placeholder=" " value="{{ request.GET.tenant|default:'' }}">
            <label for="tenant_id" class="floating-label absolute left-4 top-1/2 text-gray-500 pointer-events-none">
              Identifiant Tenant
            </label>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400">
              <i class="fas fa-building"></i>
            </div>
          </div>

          <div class="relative">
            <input type="text" id="username" name="username" required autocomplete="username"
                   class="w-full px-4 py-4 border border-gray-300 rounded-xl input-focus transition duration-200 peer input-filled"
                   placeholder=" ">
            <label for="username" class="floating-label absolute left-4 top-1/2 text-gray-500 pointer-events-none">
              Nom d’utilisateur
            </label>
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-user"></i></div>
          </div>

          <div class="relative">
            <input type="password" id="password" name="password" required autocomplete="current-password"
                   class="w-full px-4 py-4 border border-gray-300 rounded-xl input-focus transition duration-200 peer input-filled pr-12"
                   placeholder=" ">
            <label for="password" class="floating-label absolute left-4 top-1/2 text-gray-500 pointer-events-none">
              Mot de passe
            </label>
            <button type="button" onclick="togglePassword()"
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-eye" id="password-toggle"></i>
            </button>
          </div>

          <div class="flex items-center justify-between">
            <label class="flex items-center gap-2 text-sm text-gray-700">
              <input type="checkbox" id="remember_me" class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
              Se souvenir de moi
            </label>
            <a class="text-sm text-indigo-600 hover:text-indigo-700" href="#">Mot de passe oublié ?</a>
          </div>

          <button id="submitBtn" type="submit"
                  class="w-full btn-gradient text-white py-4 rounded-xl font-semibold shadow-lg transition duration-200 disabled:opacity-60 disabled:cursor-not-allowed">
            <span class="inline-flex items-center gap-2">
              <i class="fas fa-sign-in-alt"></i><span>Se connecter</span>
            </span>
          </button>

          <input type="hidden" id="next" value="{{ next|default:'/' }}">
        </form>

        <!-- Séparateur -->
        <div class="relative my-6">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
          <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">SSO</span></div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <button type="button" class="py-3 px-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition">
            <i class="fab fa-microsoft text-indigo-600 mr-2"></i><span class="text-sm font-medium text-gray-700">Azure AD</span>
          </button>
          <button type="button" class="py-3 px-4 border border-gray-300 rounded-xl hover:bg-gray-50 transition"
                  onclick="document.getElementById('kcLoginForm').dispatchEvent(new Event('submit'))">
            <i class="fas fa-key text-green-600 mr-2"></i><span class="text-sm font-medium text-gray-700">Keycloak</span>
          </button>
        </div>
      </section>

      <p class="mt-8 text-center text-gray-500 text-sm">
        Nouveau sur LyneERP ?
        <a href="#" class="text-indigo-600 font-medium hover:text-indigo-700">Créer un compte</a>
      </p>
    </div>
  </main>
</div>

<script>
  // ====== CONFIG (adapter si besoin) ======
  const KC_CONFIG = {
    issuer: "https://sso.lyneerp.com/realms/lyneerp",   // ton realm public
    clientId: "rh-core",                                 // client PUBLIC avec "Direct Access Grants" = ON
    // Si tu dois utiliser un client CONFIDENTIAL (déconseillé en front) : set clientSecret et activer Service Accounts
    clientSecret: null,                                  // ne pas mettre de secret dans le front !
    // Fallback proxy backend (si CORS bloque l’appel direct):
    // proxyTokenUrl: "/auth/keycloak/token/"
  };
  // ========================================

  const TOKEN_URL = KC_CONFIG.issuer + "/protocol/openid-connect/token";
  const errorBox = document.getElementById("errorBox");
  const submitBtn = document.getElementById("submitBtn");

  function showError(msg) {
    errorBox.textContent = msg;
    errorBox.classList.remove("hidden");
  }
  function clearError() {
    errorBox.classList.add("hidden");
    errorBox.textContent = "";
  }
  function togglePassword() {
    const input = document.getElementById('password');
    const icon = document.getElementById('password-toggle');
    if (input.type === 'password') { input.type = 'text'; icon.classList.replace('fa-eye','fa-eye-slash'); }
    else { input.type = 'password'; icon.classList.replace('fa-eye-slash','fa-eye'); }
  }

  // Util: stocker les tokens (sessionStorage par défaut)
  function storeTokens(payload, remember) {
    const storage = remember ? localStorage : sessionStorage;
    storage.setItem("kc_access_token", payload.access_token);
    if (payload.refresh_token) storage.setItem("kc_refresh_token", payload.refresh_token);
    storage.setItem("kc_token_type", payload.token_type || "Bearer");
    storage.setItem("kc_expires_in", String(payload.expires_in || 0));
  }

  // Après obtention du token Keycloak, tu peux:
  // 1) Appeler l’API Django avec Authorization: Bearer <token>
  // 2) OU créer une session locale: POST /auth/exchange/ avec le token (backend vérifie la JWKS & crée session)
  async function establishAppSession(accessToken, tenantId) {
    try {
      // Exemple côté backend (à créer) :
      // const r = await fetch("/auth/exchange/", {
      //   method: "POST",
      //   headers: {"Content-Type":"application/json","X-Tenant-Id": tenantId},
      //   body: JSON.stringify({ access_token: accessToken })
      // });
      // if (!r.ok) throw new Error("Exchange failed");
      return true;
    } catch (e) { console.warn(e); return false; }
  }

  async function loginWithKeycloak({username, password, tenantId, remember}) {
    const form = new URLSearchParams();
    form.append("grant_type", "password");
    form.append("client_id", KC_CONFIG.clientId);
    // public client => pas de secret
    if (KC_CONFIG.clientSecret) form.append("client_secret", KC_CONFIG.clientSecret);
    form.append("username", username);
    form.append("password", password);

    // Appel direct ➜ peut être bloqué par CORS selon config Keycloak
    try {
      const res = await fetch(TOKEN_URL, {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: form,
      });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || "Erreur Keycloak");
      }
      const payload = await res.json();
      if (!payload.access_token) throw new Error("Pas de access_token reçu");

      storeTokens(payload, remember);
      // Optionnel: session locale
      await establishAppSession(payload.access_token, tenantId);

      // Garde le tenant pour les prochains appels
      if (tenantId) localStorage.setItem("current_tenant", tenantId);

      // Redirige
      const nextUrl = document.getElementById("next")?.value || "/";
      window.location.assign(nextUrl);
    } catch (err) {
      // Si CORS bloque, proposer le fallback proxy
      console.error(err);
      showError("Échec de connexion. Vérifie tes identifiants ou la config Keycloak (CORS/Direct Grants).");
      // === Fallback proxy (décommente si tu exposes un endpoint applicatif) ===
      // if (KC_CONFIG.proxyTokenUrl) {
      //   try {
      //     const prox = await fetch(KC_CONFIG.proxyTokenUrl, {
      //       method: "POST",
      //       headers: {"Content-Type": "application/json", "X-Tenant-Id": tenantId},
      //       body: JSON.stringify({ grant_type: "password", client_id: KC_CONFIG.clientId, username, password })
      //     });
      //     if (!prox.ok) throw new Error("Proxy token error");
      //     const payload = await prox.json();
      //     storeTokens(payload, remember);
      //     await establishAppSession(payload.access_token, tenantId);
      //     const nextUrl = document.getElementById("next")?.value || "/";
      //     window.location.assign(nextUrl);
      //   } catch (e2) {
      //     console.error(e2);
      //   }
      // }
    }
  }

  document.getElementById("kcLoginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearError();
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<span class="inline-flex items-center gap-2"><i class="fa-solid fa-spinner animate-spin"></i> Connexion…</span>`;

    const tenantId = document.getElementById("tenant_id")?.value?.trim();
    const username = document.getElementById("username")?.value?.trim();
    const password = document.getElementById("password")?.value || "";
    const remember = document.getElementById("remember_me")?.checked || false;

    if (!tenantId || !username || !password) {
      showError("Tous les champs sont requis.");
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<span class="inline-flex items-center gap-2"><i class="fas fa-sign-in-alt"></i><span>Se connecter</span></span>`;
      return;
    }

    await loginWithKeycloak({username, password, tenantId, remember});

    submitBtn.disabled = false;
    submitBtn.innerHTML = `<span class="inline-flex items-center gap-2"><i class="fas fa-sign-in-alt"></i><span>Se connecter</span></span>`;
  });

  // Effet labels
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="text"], input[type="password"]').forEach(input => {
      if (input.value) input.classList.add('input-filled');
      input.addEventListener('focus', () => input.classList.add('input-focused'));
      input.addEventListener('blur', () => { input.classList.remove('input-focused'); if (!input.value) input.classList.remove('input-filled'); });
      input.addEventListener('input', () => input.classList.toggle('input-filled', !!input.value));
    });
  });
</script>
</body>
</html>