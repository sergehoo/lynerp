<!-- Lyneerp/hr/templates/hr/base.html -->
<!DOCTYPE html>
<html lang="fr" class="h-full" x-data="hrApp()" x-init="init()" :class="{'dark': dark}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>LyneERP - Plateforme RH Intelligente</title>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Alpine Plugins -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {sans: ['Inter', 'ui-sans-serif', 'system-ui']},
          colors: {
            brand: {
              50: '#fff7ed',
              100: '#ffedd5',
              200: '#fed7aa',
              300: '#fdba74',
              400: '#fb923c',
              500: '#f97316',
              600: '#ea580c',
              700: '#c2410c',
              800: '#9a3412',
              900: '#7c2d12'
            }
          },
          boxShadow: {
            card: '0 18px 45px rgba(15,23,42,0.08)',
            soft: '0 10px 30px rgba(15,23,42,0.06)'
          },
          borderRadius: {'3xl': '1.5rem'}
        }
      }
    }
  </script>

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    [x-cloak] { display: none }

    .scroll-slim::-webkit-scrollbar { height: 8px; width: 8px }
    .scroll-slim::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 9999px }
    .dark .scroll-slim::-webkit-scrollbar-thumb { background-color: #475569 }

    .skeleton {
      background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 37%, #e5e7eb 63%);
      background-size: 400% 100%;
      animation: shimmer 1.2s ease-in-out infinite
    }
    .dark .skeleton {
      background: linear-gradient(90deg, #334155 25%, #1f2937 37%, #334155 63%)
    }
    @keyframes shimmer {
      0% { background-position: 100% 0 }
      100% { background-position: -100% 0 }
    }

    .kbd {
      font-variant: all-small-caps;
      font-size: 10px;
      border: 1px solid #e2e8f0;
      border-bottom-width: 2px;
      padding: .15rem .35rem;
      border-radius: .4rem
    }
    .dark .kbd { border-color: #334155 }
  </style>
</head>

<body
  class="h-full bg-gray-50 text-slate-600 dark:bg-slate-900 dark:text-slate-100 antialiased selection:bg-brand-100 selection:text-brand-700"
  @keydown.window.prevent.cmd.k="openCmd=true"
  @keydown.window.prevent.ctrl.k="openCmd=true"
  @keydown.window.prevent.cmd.j="toggleDark()"
  @keydown.window.prevent.ctrl.j="toggleDark()"
>
<div class="flex min-h-screen relative">

  <!-- Sidebar -->
  <aside
    class="flex flex-col shrink-0 overflow-hidden bg-white dark:bg-slate-900 border-r border-gray-200 dark:border-slate-800 shadow-sm transition-all duration-300"
    :class="sidebarCollapsed ? 'w-16' : 'w-72'">

    <!-- Logo (FIX: toggle button always visible) -->
    <div class="h-16 flex items-center border-b border-gray-100 dark:border-slate-800"
         :class="sidebarCollapsed ? 'px-2' : 'px-6'">

      <div class="flex items-center gap-3 min-w-0">
        <div class="bg-brand-600 text-white p-2.5 rounded-xl shadow-md shadow-brand-200">
          <i class="fa-solid fa-users-gear"></i>
        </div>

        <div class="min-w-0" x-show="!sidebarCollapsed" x-cloak>
          <div class="text-lg font-semibold text-slate-900 dark:text-white tracking-tight">LyneERP</div>
          <div class="text-xs text-slate-400 dark:text-slate-500 -mt-0.5">Plateforme RH</div>
        </div>
      </div>

      <div class="ml-auto flex items-center">
        <button
          @click="sidebarCollapsed = !sidebarCollapsed"
          class="p-2 rounded-xl hover:bg-gray-50 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-300
                 border border-transparent hover:border-gray-200/70 dark:hover:border-slate-700/70 transition"
          aria-label="R√©duire/√©tendre la barre lat√©rale">
          <i class="fa-solid fa-chevron-left transition-transform"
             :class="sidebarCollapsed ? 'rotate-180' : ''"></i>
        </button>
      </div>
    </div>

    <!-- FAVORIS -->
    <div x-show="favoriteItems.length && !sidebarCollapsed" x-cloak class="px-3 pt-3">
      <div class="rounded-2xl overflow-hidden border border-gray-200/70 dark:border-slate-800/80 bg-white dark:bg-slate-900">
        <div class="px-4 py-2.5 flex items-center justify-between">
          <div class="text-xs font-semibold text-slate-700 dark:text-slate-200 flex items-center gap-2">
            <i class="fa-solid fa-thumbtack text-slate-400"></i>
            <span>Favoris</span>
          </div>
          <span class="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300"
                x-text="favoriteItems.length"></span>
        </div>

        <div class="px-2 pb-2">
          <template x-for="fav in favoriteItems" :key="'fav:'+fav.id">
            <a href="#"
               @click.prevent="switchView(fav)"
               class="group relative flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium transition mb-1 hover:bg-gray-50 dark:hover:bg-slate-800">
              <div class="w-9 h-9 rounded-xl flex items-center justify-center border bg-gray-100 text-slate-700 border-gray-200 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700">
                <i :class="fav.icon"></i>
              </div>
              <div class="min-w-0">
                <div class="truncate" x-text="fav.name"></div>
                <div class="text-[11px] text-slate-400 truncate" x-text="fav._group?.name || ''"></div>
              </div>
              <button class="ml-auto p-2 rounded-lg opacity-70 hover:opacity-100"
                      @click.stop="toggleFav(fav.id)"
                      title="Retirer des favoris">
                <i class="fa-solid fa-thumbtack"></i>
              </button>
            </a>
          </template>
        </div>
      </div>
    </div>

    <!-- Nav -->
    <nav class="flex-1 overflow-auto scroll-slim py-4 space-y-3"
         :class="sidebarCollapsed ? 'px-2' : 'px-3'">

      <!-- Search (FIX: collapsed -> button) -->
      <div class="px-1">
        <div class="relative" x-show="!sidebarCollapsed" x-cloak>
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
          <input type="text"
                 x-model="navQuery"
                 placeholder="Rechercher‚Ä¶"
                 class="w-full pl-9 pr-3 py-2 rounded-2xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm outline-none focus:ring-2 focus:ring-brand-200">
        </div>

        <button x-show="sidebarCollapsed" x-cloak
                @click="openCmd=true"
                class="w-full h-10 grid place-items-center rounded-2xl border border-gray-200 dark:border-slate-700
                       bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200
                       hover:bg-gray-50 dark:hover:bg-slate-700 transition">
          <i class="fa-solid fa-magnifying-glass text-sm"></i>
        </button>
      </div>

      <template x-for="group in filteredNavigation" :key="group.id">
        <div class="rounded-2xl overflow-hidden border border-gray-200/70 dark:border-slate-800/80"
             :class="(group.theme?.panelGlow || 'bg-white dark:bg-slate-900') + ' ' + (group.theme?.panelRing || '')">

          <!-- Group Header -->
          <button
            class="w-full flex items-center justify-between text-left transition"
            :class="(sidebarCollapsed ? 'px-2 py-2.5' : 'px-4 py-3') + ' ' + (openGroupId===group.id
              ? (group.theme?.headerActive || 'bg-gray-50 dark:bg-slate-800')
              : (group.theme?.header || 'hover:bg-gray-50 dark:hover:bg-slate-800'))"
            @click="toggleGroup(group.id)">

            <div class="flex items-center gap-3 min-w-0">
              <!-- FIX: icons stronger in collapsed -->
              <div class="w-10 h-10 rounded-2xl flex items-center justify-center border transition"
                   :class="openGroupId===group.id
                      ? (group.theme?.iconOpen || 'bg-gray-900 text-white border-transparent')
                      : (sidebarCollapsed
                          ? 'bg-slate-900 text-white border-slate-700 dark:bg-white dark:text-slate-900 dark:border-slate-700'
                          : (group.theme?.icon || 'bg-gray-100 text-slate-700 border-gray-200 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700')
                        )">
                <i :class="group.icon + ' text-[15px]'"></i>
              </div>

              <div class="min-w-0" x-show="!sidebarCollapsed" x-cloak>
                <div class="font-semibold truncate"
                     :class="openGroupId===group.id ? (group.theme?.titleOpen || 'text-slate-900 dark:text-white') : 'text-slate-900 dark:text-white'"
                     x-text="group.name"></div>

                <div class="text-xs truncate"
                     :class="group.theme?.desc || 'text-slate-500 dark:text-slate-400'"
                     x-text="group.desc || ''"></div>
              </div>
            </div>

            <div class="flex items-center gap-2" x-show="!sidebarCollapsed" x-cloak>
              <span class="text-[10px] px-2 py-0.5 rounded-full"
                    :class="group.theme?.chip || 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300'"
                    x-text="group.items.length"></span>

              <i class="fa-solid fa-chevron-down text-slate-400 transition-transform"
                 :class="openGroupId===group.id ? 'rotate-180' : ''"></i>
            </div>
          </button>

          <!-- Dropdown Items -->
          <div x-show="openGroupId===group.id && !sidebarCollapsed" x-collapse x-cloak class="px-2 pb-2">
            <template x-for="item in group.items" :key="item.id">
              <a href="#"
                 @click.prevent="switchView(item)"
                 class="group relative flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium transition mb-1"
                 :class="activeNav===item.id
                      ? (group.theme?.itemActive || 'bg-gray-900 text-white')
                      : (group.theme?.item || 'text-slate-600 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-800')">

                <span class="absolute left-1 top-1/2 -translate-y-1/2 h-6 w-1 rounded-full"
                      x-show="activeNav===item.id" x-cloak
                      :class="group.theme?.accent || 'bg-white/80'"></span>

                <div class="w-9 h-9 rounded-xl flex items-center justify-center border transition"
                     :class="activeNav===item.id
                        ? (group.theme?.itemIconActive || 'bg-white/10 text-white border-white/10')
                        : (group.theme?.itemIcon || 'bg-gray-100 text-slate-700 border-gray-200 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700 group-hover:shadow-sm')">
                  <i :class="item.icon + ' text-[14px]'"></i>
                </div>

                <span class="truncate" x-text="item.name"></span>

                <span x-show="item.badge" x-cloak
                      class="ml-auto text-[10px] rounded-full px-2 py-0.5"
                      :class="group.theme?.badge || 'bg-brand-100 text-brand-700'"
                      x-text="item.badge"></span>

                <button class="ml-2 p-2 rounded-lg opacity-60 hover:opacity-100"
                        @click.stop="toggleFav(item.id)"
                        :title="isFav(item.id) ? 'Retirer des favoris' : 'Ajouter aux favoris'">
                  <i class="fa-solid fa-thumbtack" :class="isFav(item.id) ? 'text-white' : 'text-slate-400'"></i>
                </button>
              </a>
            </template>
          </div>

          <!-- Collapsed quick items (icons only) -->
          <div x-show="openGroupId===group.id && sidebarCollapsed" x-collapse x-cloak class="px-2 pb-2">
            <div class="grid grid-cols-1 gap-2">
              <template x-for="item in group.items" :key="'c:'+item.id">
                <button
                  @click.prevent="switchView(item)"
                  class="h-10 rounded-2xl border transition grid place-items-center"
                  :class="activeNav===item.id
                    ? (group.theme?.itemActive || 'bg-gray-900 text-white border-transparent')
                    : 'bg-white text-slate-800 border-gray-200 hover:bg-gray-50 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700 dark:hover:bg-slate-700'">
                  <i :class="item.icon + ' text-[15px]'"></i>
                </button>
              </template>
            </div>
          </div>

        </div>
      </template>

    </nav>

    <!-- Bottom status -->
    <div class="p-4 border-t border-gray-100 dark:border-slate-800">
      <div class="flex items-center justify-between text-xs">
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full"
              :class="online
                ? 'bg-emerald-50 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200'
                : 'bg-rose-50 text-rose-700 dark:bg-rose-900/30 dark:text-rose-200'">
          <span class="w-2 h-2 rounded-full" :class="online ? 'bg-emerald-500' : 'bg-rose-500'"></span>
          <span x-show="!sidebarCollapsed" x-cloak x-text="online ? 'En ligne' : 'Hors ligne'"></span>
        </span>

        <button class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-slate-800 text-slate-400"
                @click="openSettings = true" aria-label="Ouvrir la configuration">
          <i class="fa-solid fa-gear"></i>
        </button>
      </div>
    </div>

  </aside>

  <!-- Main -->
  <section class="flex-1 flex flex-col min-w-0">

    <!-- Topbar (teint√©e par module) -->
    <header class="sticky top-0 z-20 backdrop-blur-md border-b transition-colors duration-300"
            :class="topbarTheme.tint + ' ' + topbarTheme.border">
      <div class="max-w-7xl mx-auto px-4 sm:px-8">
        <div class="h-20 flex items-center justify-between gap-4">
          <div class="min-w-0">
            <h1 class="text-2xl font-semibold text-slate-900 dark:text-white tracking-tight truncate"
                x-text="viewTitle"></h1>

            <div class="mt-2 flex items-center gap-2 flex-wrap">
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold shadow-sm border border-white/60 dark:border-slate-700/70"
                    :class="topbarTheme.pill">
                <i class="fa-solid fa-layer-group text-[11px] opacity-90"></i>
                <span x-text="activeGroup?.name || 'Module'"></span>
              </span>

              <p class="text-xs text-slate-500 dark:text-slate-400" x-text="viewDesc"></p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-2 text-xs bg-white/80 dark:bg-slate-800/70 px-3 py-1.5 rounded-full border border-gray-200/70 dark:border-slate-700 shadow-sm">
              <i class="fa-solid fa-building text-slate-400"></i>
              <span class="text-slate-700 dark:text-slate-200" x-text="tenantId || '-'"></span>
            </div>
            <div class="hidden md:flex items-center gap-2 text-xs bg-white/80 dark:bg-slate-800/70 px-3 py-1.5 rounded-full border border-gray-200/70 dark:border-slate-700 shadow-sm">
              <i class="fa-solid fa-user text-slate-400"></i>
              <span class="text-slate-700 dark:text-slate-200"
                    x-text="user?.username || user?.preferred_username || 'Utilisateur'"></span>
            </div>

            <button @click="toggleDark()"
                    class="p-2.5 rounded-full bg-white/80 dark:bg-slate-800/70 border border-gray-200/70 dark:border-slate-700 text-slate-600 hover:bg-white dark:hover:bg-slate-700 shadow-sm">
              <i class="fa-solid" :class="dark?'fa-moon':'fa-sun'"></i>
            </button>

            <button @click="logout()"
                    class="h-10 px-4 rounded-full text-sm font-medium shadow-soft flex items-center gap-2 transition hover:opacity-95"
                    :class="topbarTheme.pill">
              <i class="fa-solid fa-right-from-bracket text-xs"></i>
              <span>Quitter</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Hint 401/403 -->
      <div x-show="authHint && !licenseBlocker.visible" x-cloak
           class="border-t border-amber-200/60 bg-amber-50 dark:bg-amber-900/20 text-amber-800 dark:text-amber-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-8 py-2 text-sm flex items-center gap-2">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <div>Acc√®s non authentifi√©/autoris√©. Redirection vers la page de connexion‚Ä¶</div>
        </div>
      </div>
    </header>

    <!-- Content -->
    <main class="flex-1 overflow-auto scroll-slim">
      <div class="max-w-7xl mx-auto px-4 sm:px-8 py-6 space-y-6">

        <!-- Global overlay loader -->
        <div x-show="loading" x-cloak class="fixed inset-0 z-30 bg-slate-900/20 backdrop-blur-sm grid place-content-center">
          <div class="rounded-2xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 px-6 py-4 shadow-2xl flex items-center gap-3">
            <span class="animate-spin h-5 w-5 rounded-full border-2 border-gray-300 border-t-brand-600"></span>
            <span class="text-sm">Chargement‚Ä¶</span>
          </div>
        </div>

        <!-- Skeleton -->
        <div x-show="currentView==='dashboard' && !Object.keys(dashboardStats).length && !authHint && !licenseBlocker.visible"
             x-cloak class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <template x-for="i in 4" :key="i">
            <div class="bg-white dark:bg-slate-900 rounded-3xl p-6 shadow-sm border border-gray-100 dark:border-slate-800">
              <div class="skeleton h-3 w-24 mb-3 rounded-full"></div>
              <div class="skeleton h-7 w-16 rounded-full"></div>
            </div>
          </template>
        </div>

        <!-- Views -->
        <div x-show="currentView === 'dashboard' && !authHint && !licenseBlocker.visible" x-cloak>
          {% include "hr/partials/dashboard.html" %}
          <div x-show="!Object.keys(dashboardStats).length"
               class="mt-6 rounded-3xl border border-dashed border-gray-300 dark:border-slate-700 p-8 text-center bg-white dark:bg-slate-900">
            <div class="text-3xl mb-2">üß≠</div>
            <p class="font-semibold text-slate-900 dark:text-white">Aucune donn√©e √† afficher pour le moment.</p>
            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
              Ajoutez des employ√©s, cr√©ez des campagnes de recrutement, puis revenez ici.
            </p>
          </div>
        </div>

        <div x-show="currentView === 'employees' && !authHint && !licenseBlocker.visible" x-cloak>
          {% include "hr/partials/employees.html" %}
        </div>

        <div x-show="currentView === 'recruitment' && !authHint && !licenseBlocker.visible" x-cloak>
          {% include "hr/partials/recruitment.html" %}
        </div>

        <div x-show="currentView === 'leaves' && !authHint && !licenseBlocker.visible" x-cloak>
          {% include "hr/partials/leaves.html" %}
        </div>

        <div x-show="currentView === 'attendance' && !authHint && !licenseBlocker.visible" x-cloak>
          {% include "hr/partials/attendance.html" %}
        </div>

        <!-- Blocage licence -->
        <div x-show="licenseBlocker.visible" x-cloak class="max-w-xl mx-auto">
          <div class="rounded-3xl border border-rose-200 dark:border-rose-900/50 bg-white dark:bg-slate-900 p-6 text-center shadow-soft">
            <div class="text-4xl mb-2">‚õî</div>
            <h3 class="text-lg font-semibold mb-2 text-slate-900 dark:text-white">
              403 ‚Äî Licence RH invalide ou expir√©e
            </h3>
            <p class="text-sm text-slate-600 dark:text-slate-400"
               x-text="licenseBlocker.detail || 'Votre abonnement RH ne permet pas d‚Äôacc√©der √† cette ressource.'"></p>
            <div class="mt-5 flex flex-wrap items-center justify-center gap-3">
              <button @click="refreshLicense"
                      class="px-4 py-2 rounded-full bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium">
                Rafra√Æchir la licence
              </button>
              <button @click="openBillingPortal"
                      class="px-4 py-2 rounded-full border border-gray-300 dark:border-slate-700 text-sm">
                G√©rer la facturation
              </button>
              <button @click="openSettings=true"
                      class="px-4 py-2 rounded-full border border-gray-300 dark:border-slate-700 text-sm">
                Changer de tenant
              </button>
            </div>
          </div>
        </div>

      </div>
    </main>
  </section>
</div>

<!-- Command Palette -->
<div x-show="openCmd" x-cloak class="fixed inset-0 z-40 flex items-start justify-center pt-24 px-4 bg-slate-900/50"
     @keydown.escape.window="openCmd=false" @click.self="openCmd=false">
  <div class="w-full max-w-2xl rounded-3xl overflow-hidden shadow-2xl bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800">
    <div class="flex items-center gap-3 px-4 py-3 border-b border-gray-200 dark:border-slate-800">
      <i class="fa-solid fa-magnifying-glass text-slate-400"></i>
      <input type="text" x-model="cmdQuery" placeholder="Rechercher une page ou une action‚Ä¶"
             class="w-full bg-transparent outline-none placeholder-slate-400 text-sm"/>
      <kbd class="kbd">ESC</kbd>
    </div>
    <div class="max-h-80 overflow-auto scroll-slim divide-y divide-gray-100 dark:divide-slate-800">
      <template x-for="it in cmdResults" :key="it.key">
        <button @click="it.action(); openCmd=false"
                class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-slate-800 flex items-center gap-3 text-sm">
          <i :class="it.icon + ' text-slate-400'"></i>
          <div>
            <div class="font-medium text-slate-900 dark:text-white" x-text="it.label"></div>
            <div class="text-xs text-slate-500" x-text="it.desc"></div>
          </div>
        </button>
      </template>
      <div x-show="cmdResults.length===0" class="px-4 py-6 text-sm text-slate-500">Aucun r√©sultat.</div>
    </div>
  </div>
</div>

<!-- Settings Drawer -->
<div x-show="openSettings" x-cloak class="fixed inset-0 z-40 bg-slate-900/40" @click.self="openSettings=false"
     @keydown.escape.window="openSettings=false">
  <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white dark:bg-slate-900 border-l border-gray-200 dark:border-slate-800 shadow-2xl">
    <div class="flex items-center justify-between px-5 h-14 border-b border-gray-200 dark:border-slate-800">
      <div class="font-semibold text-slate-900 dark:text-white">Configuration</div>
      <button class="p-2 rounded-full hover:bg-gray-50 dark:hover:bg-slate-800 text-slate-400" @click="openSettings=false">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    <div class="p-5 space-y-5 text-sm">
      <div>
        <label class="text-xs font-medium text-slate-500">API Base</label>
        <input type="text" x-model="apiBase"
               class="mt-1 w-full rounded-xl border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2"/>
        <p class="text-xs text-slate-400 mt-1">Ex: /api/rh ou https://rh.lyneerp.com/api/rh</p>
      </div>
      <div>
        <label class="text-xs font-medium text-slate-500">Tenant ID</label>
        <input type="text" x-model="tenantId"
               class="mt-1 w-full rounded-xl border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2"/>
      </div>
      <div>
        <label class="text-xs font-medium text-slate-500">Bearer Token</label>
        <textarea x-model="token" rows="4"
                  class="mt-1 w-full rounded-xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2"></textarea>
        <p class="text-xs text-slate-400 mt-1">Collez le JWT Keycloak ici si n√©cessaire.</p>
      </div>
      <div class="flex items-center justify-between pt-2">
        <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 dark:text-slate-200">
          <input type="checkbox" class="rounded border-gray-300 dark:border-slate-600" x-model="dark">
          <span>Mode sombre</span>
        </label>
        <div class="space-x-2">
          <button @click="applyTenant()" class="px-3 py-2 rounded-full border border-gray-300 dark:border-slate-700 text-xs">
            Appliquer tenant
          </button>
          <button @click="saveConf()" class="bg-brand-600 hover:bg-brand-700 text-white px-4 py-2 rounded-full text-xs font-medium shadow-soft">
            Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="fixed bottom-4 right-4 z-50 space-y-2">
  <template x-for="(toast, i) in toasts" :key="i">
    <div x-show="toast.visible" x-transition
         class="rounded-2xl shadow-2xl px-4 py-3 text-white text-sm flex items-center gap-3"
         :class="{
           'bg-emerald-600': toast.type==='success',
           'bg-rose-600': toast.type==='error',
           'bg-slate-800': toast.type==='info',
           'bg-amber-600': toast.type==='warning'
         }">
      <i class="fa-solid"
         :class="{
           'fa-circle-check': toast.type==='success',
           'fa-circle-exclamation': toast.type==='error',
           'fa-circle-info': toast.type==='info',
           'fa-triangle-exclamation': toast.type==='warning'
         }"></i>
      <div class="flex-1" x-text="toast.message"></div>
      <button class="ml-2 opacity-80 hover:opacity-100" @click="removeToast(i)">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </template>
</div>

<script>
  /********************
   * CONFIG & FLAGS
   ********************/
  const LICENSE_UI = false;
  const FRONT_DEFAULT_TENANT = "demo";
  const KC = {issuer: "https://sso.lyneerp.com/realms/lyneerp", clientId: "rh-core"};
  const DEV_MODE = (localStorage.getItem('lyneerp_dev') === '1')
    || ['localhost', '127.0.0.1'].includes(location.hostname)
    || location.hostname.endsWith('.local');

  /********************
   * HELPERS
   ********************/
  const log = (...a) => console.debug('[HR]', ...a);
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function base64UrlDecode(str) {
    str = str.replace(/-/g, '+').replace(/_/g, '/');
    const pad = str.length % 4;
    if (pad) str += '='.repeat(4 - pad);
    try { return atob(str); } catch { return ''; }
  }

  function parseJwt(token) {
    if (!token) return null;
    const parts = token.split('.');
    if (parts.length !== 3) return null;
    try { return JSON.parse(base64UrlDecode(parts[1])); } catch { return null; }
  }

  function getStoredAccessToken() {
    return localStorage.getItem('lyneerp_token')
      || sessionStorage.getItem('lyneerp_token')
      || localStorage.getItem('kc_access_token')
      || sessionStorage.getItem('kc_access_token')
      || '';
  }

  function getStoredRefreshToken() {
    return localStorage.getItem('kc_refresh_token') || sessionStorage.getItem('kc_refresh_token') || '';
  }

  async function refreshTokenIfNeeded(exp) {
    const now = Math.floor(Date.now() / 1000);
    if (!exp || exp - now > 30) return false;
    const refresh = getStoredRefreshToken();
    if (!refresh) return false;

    const res = await fetch(`${KC.issuer}/protocol/openid-connect/token`, {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: new URLSearchParams({grant_type: "refresh_token", client_id: KC.clientId, refresh_token: refresh})
    });
    if (!res.ok) return false;

    const p = await res.json();
    const remember = !!localStorage.getItem('kc_access_token');
    const storage = remember ? localStorage : sessionStorage;
    if (p.access_token) storage.setItem("kc_access_token", p.access_token);
    if (p.refresh_token) storage.setItem("kc_refresh_token", p.refresh_token);
    return true;
  }

  function kcLogout() {
    const storedIdToken = sessionStorage.getItem('kc_id_token') || localStorage.getItem('kc_id_token') || '';
    const storedAccessToken =
      localStorage.getItem('kc_access_token') ||
      sessionStorage.getItem('kc_access_token') ||
      localStorage.getItem('lyneerp_token') ||
      sessionStorage.getItem('lyneerp_token') || '';
    const hintToken = storedIdToken || storedAccessToken;

    ['lyneerp_token', 'kc_access_token', 'kc_refresh_token', 'kc_id_token'].forEach(k => {
      localStorage.removeItem(k);
      sessionStorage.removeItem(k);
    });

    if (!hintToken) { window.location.assign('/oidc/authenticate/'); return; }

    const redirectUri = window.location.origin + '/oidc/authenticate/';
    const url =
      `${KC.issuer}/protocol/openid-connect/logout` +
      `?post_logout_redirect_uri=${encodeURIComponent(redirectUri)}` +
      `&client_id=${encodeURIComponent(KC.clientId)}` +
      `&id_token_hint=${encodeURIComponent(hintToken)}`;

    window.location.assign(url);
  }

  function deriveTenantFromHost(host) {
    const h = (host || location.hostname).toLowerCase();
    const m = h.match(/^([a-z0-9-]+)\.(?:rh\.)?lyneerp\.com$/i);
    if (m) return m[1];
    const parts = h.split('.');
    if (parts.length >= 3) return parts[0];
    return '';
  }

  function buildUrl(apiBase, path) {
    if (/^https?:\/\//i.test(path)) return path;
    if (path.startsWith('/')) return path;
    return `${apiBase}${path.startsWith('/') ? '' : '/'}${path}`;
  }

  function normalizeApiBase(val) {
    if (!val) return '/api/rh';
    let v = val.trim();
    if (/^https?:\/\//i.test(v) && !/\/api\/rh\/?$/i.test(v)) v = v.replace(/\/+$/, '') + '/api/rh';
    return v.replace(/\/+$/, '');
  }

  function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    if (match) return decodeURIComponent(match[2]);
    return null;
  }

  function shouldSendCsrf(url, method) {
    const sameOrigin = !/^https?:\/\//i.test(url) || url.startsWith(location.origin);
    const unsafe = !['GET', 'HEAD', 'OPTIONS', 'TRACE'].includes((method || 'GET').toUpperCase());
    return sameOrigin && unsafe;
  }

  const cache = {
    get(key) {
      try {
        const raw = localStorage.getItem('cache:' + key);
        if (!raw) return null;
        const {exp, val} = JSON.parse(raw);
        if (exp && Date.now() > exp) { localStorage.removeItem('cache:' + key); return null; }
        return val;
      } catch { return null; }
    },
    set(key, val, ttlMs = 60000) {
      try { localStorage.setItem('cache:' + key, JSON.stringify({exp: Date.now() + ttlMs, val})); } catch {}
    },
    del(key) { localStorage.removeItem('cache:' + key); }
  };

  async function fetchWithBackoff(url, options = {}, {retries = 2, baseDelay = 300} = {}) {
    let attempt = 0, lastErr;
    while (attempt <= retries) {
      try {
        const res = await fetch(url, options);
        if (res.status >= 500 || res.status === 429) throw new Error('server/backpressure');
        return res;
      } catch (e) {
        lastErr = e;
        if (attempt === retries) break;
        await sleep(baseDelay * Math.pow(2, attempt));
        attempt++;
      }
    }
    throw lastErr || new Error('fetch failed');
  }

  const Conf = {
    apiBase: normalizeApiBase(localStorage.getItem('lyneerp_api') || '/api/rh'),
    tenantId: localStorage.getItem('lyneerp_tenant') || deriveTenantFromHost(location.hostname),
    token: getStoredAccessToken(),
    dark: (localStorage.getItem('lyneerp_dark') === '1') || window.matchMedia?.('(prefers-color-scheme: dark)').matches,
    save() {
      localStorage.setItem('lyneerp_api', this.apiBase);
      localStorage.setItem('lyneerp_tenant', this.tenantId || '');
      if (this.token) localStorage.setItem('lyneerp_token', this.token);
      localStorage.setItem('lyneerp_dark', this.dark ? '1' : '0');
    }
  };

  function resolveInitialTenant(current) {
    return current || deriveTenantFromHost(location.hostname) || localStorage.getItem('lyneerp_tenant') || FRONT_DEFAULT_TENANT;
  }

  function hrApp() {
    return {
      favorites: JSON.parse(localStorage.getItem('lyneerp_favs') || '[]'),

      isFav(itemId) { return this.favorites.includes(itemId); },
      toggleFav(itemId) {
        if (!itemId) return;
        if (this.isFav(itemId)) this.favorites = this.favorites.filter(x => x !== itemId);
        else this.favorites = [itemId, ...this.favorites].slice(0, 12);
        localStorage.setItem('lyneerp_favs', JSON.stringify(this.favorites));
      },
      get favoriteItems() {
        const out = [];
        for (const g of this.navigation) {
          for (const it of g.items) {
            if (this.isFav(it.id)) out.push({...it, _group: g});
          }
        }
        out.sort((a, b) => this.favorites.indexOf(a.id) - this.favorites.indexOf(b.id));
        return out;
      },

      navQuery: '',
      openGroupId: null,

      toggleGroup(id) {
        // in collapsed: keep a single open group (accordion)
        this.openGroupId = (this.openGroupId === id) ? null : id;
      },

      switchView(item) {
        if (!item) return;
        this.activeNav = item.id;
        this.currentView = item.id;

        // open correct group
        const g = this.navigation.find(x => x.items?.some(it => it.id === item.id));
        if (g) this.openGroupId = g.id;

        if (item.route) { window.location.assign(item.route); return; }
        this.prefetch(item.id);
      },

      get filteredNavigation() {
        const q = (this.navQuery || '').toLowerCase().trim();
        if (!q) return this.navigation;
        return this.navigation
          .map(g => {
            const items = g.items.filter(it =>
              (it.name || '').toLowerCase().includes(q) ||
              (it.id || '').toLowerCase().includes(q)
            );
            const groupMatch =
              (g.name || '').toLowerCase().includes(q) ||
              (g.desc || '').toLowerCase().includes(q);
            if (groupMatch) return g;
            if (items.length) return {...g, items};
            return null;
          })
          .filter(Boolean);
      },

      sidebarCollapsed: false,
      openCmd: false,
      openSettings: false,
      cmdQuery: '',

      loading: false,
      toasts: [],
      dark: Conf.dark,
      online: navigator.onLine,

      authHint: false,
      license: {status: 'active', plan: 'FREE', valid_until: null},
      licenseBlocker: {visible: false, detail: ''},

      apiBase: normalizeApiBase(Conf.apiBase),
      tenantId: resolveInitialTenant(Conf.tenantId) || FRONT_DEFAULT_TENANT,
      token: Conf.token,
      user: null,

      currentView: 'dashboard',
      activeNav: 'dashboard',
      dashboardStats: {},
      employees: [],
      recruitments: [],

      // THEMES
      navThemes: {
        core: {
          topbarTint: 'bg-gradient-to-r from-indigo-50/80 to-white/70 dark:from-indigo-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-indigo-200/60 dark:border-indigo-900/40',
          pill: 'bg-indigo-600 text-white',
          panelRing: 'ring-1 ring-indigo-200/60 dark:ring-indigo-900/40',
          panelGlow: 'bg-gradient-to-br from-indigo-50/70 to-white dark:from-indigo-900/10 dark:to-slate-900',
          header: 'hover:bg-indigo-50/60 dark:hover:bg-indigo-900/15',
          headerActive: 'bg-indigo-50/70 dark:bg-indigo-900/15',
          chip: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-200',
          icon: 'bg-indigo-100 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-900/30',
          iconOpen: 'bg-indigo-600 text-white border-transparent shadow-sm shadow-indigo-200/60 dark:shadow-none',
          titleOpen: 'text-indigo-900 dark:text-indigo-200',
          desc: 'text-indigo-700/80 dark:text-indigo-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-indigo-50/60 dark:hover:bg-indigo-900/15',
          itemActive: 'bg-indigo-600 text-white shadow-sm shadow-indigo-200/60 dark:shadow-none',
          itemIcon: 'bg-indigo-50 text-indigo-700 border-indigo-100 dark:bg-indigo-900/25 dark:text-indigo-200 dark:border-indigo-900/25',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-200',
          accent: 'bg-white/80'
        },
        hr: {
          topbarTint: 'bg-gradient-to-r from-emerald-50/80 to-white/70 dark:from-emerald-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-emerald-200/60 dark:border-emerald-900/40',
          pill: 'bg-emerald-600 text-white',
          panelRing: 'ring-1 ring-emerald-200/60 dark:ring-emerald-900/40',
          panelGlow: 'bg-gradient-to-br from-emerald-50/70 to-white dark:from-emerald-900/10 dark:to-slate-900',
          header: 'hover:bg-emerald-50/70 dark:hover:bg-emerald-900/15',
          headerActive: 'bg-emerald-50/80 dark:bg-emerald-900/15',
          chip: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200',
          icon: 'bg-emerald-100 text-emerald-700 border-emerald-200 dark:bg-emerald-900/30 dark:text-emerald-200 dark:border-emerald-900/30',
          iconOpen: 'bg-emerald-600 text-white border-transparent shadow-sm shadow-emerald-200/60 dark:shadow-none',
          titleOpen: 'text-emerald-900 dark:text-emerald-200',
          desc: 'text-emerald-700/80 dark:text-emerald-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-emerald-50/70 dark:hover:bg-emerald-900/15',
          itemActive: 'bg-emerald-600 text-white shadow-sm shadow-emerald-200/60 dark:shadow-none',
          itemIcon: 'bg-emerald-50 text-emerald-700 border-emerald-100 dark:bg-emerald-900/25 dark:text-emerald-200 dark:border-emerald-900/25',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200',
          accent: 'bg-white/80'
        },
        finance: {
          topbarTint: 'bg-gradient-to-r from-orange-50/80 to-white/70 dark:from-orange-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-orange-200/60 dark:border-orange-900/40',
          pill: 'bg-orange-600 text-white',
          panelRing: 'ring-1 ring-orange-200/60 dark:ring-orange-900/40',
          panelGlow: 'bg-gradient-to-br from-orange-50/70 to-white dark:from-orange-900/10 dark:to-slate-900',
          header: 'hover:bg-orange-50/70 dark:hover:bg-orange-900/15',
          headerActive: 'bg-orange-50/80 dark:bg-orange-900/15',
          chip: 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-200',
          icon: 'bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-900/30 dark:text-orange-200 dark:border-orange-900/30',
          iconOpen: 'bg-orange-600 text-white border-transparent shadow-sm shadow-orange-200/60 dark:shadow-none',
          titleOpen: 'text-orange-900 dark:text-orange-200',
          desc: 'text-orange-700/80 dark:text-orange-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-orange-50/70 dark:hover:bg-orange-900/15',
          itemActive: 'bg-orange-600 text-white shadow-sm shadow-orange-200/60 dark:shadow-none',
          itemIcon: 'bg-orange-50 text-orange-800 border-orange-100 dark:bg-orange-900/25 dark:text-orange-200 dark:border-orange-900/25',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-orange-100 text-orange-900 dark:bg-orange-900/30 dark:text-orange-200',
          accent: 'bg-white/80'
        },
        sales: {
          topbarTint: 'bg-gradient-to-r from-rose-50/80 to-white/70 dark:from-rose-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-rose-200/60 dark:border-rose-900/40',
          pill: 'bg-rose-600 text-white',
          panelRing: 'ring-1 ring-rose-200/60 dark:ring-rose-900/40',
          panelGlow: 'bg-gradient-to-br from-rose-50/70 to-white dark:from-rose-900/10 dark:to-slate-900',
          header: 'hover:bg-rose-50/70 dark:hover:bg-rose-900/15',
          headerActive: 'bg-rose-50/80 dark:bg-rose-900/15',
          chip: 'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-200',
          icon: 'bg-rose-100 text-rose-700 border-rose-200 dark:bg-rose-900/30 dark:text-rose-200 dark:border-rose-900/30',
          iconOpen: 'bg-rose-600 text-white border-transparent shadow-sm shadow-rose-200/60 dark:shadow-none',
          titleOpen: 'text-rose-900 dark:text-rose-200',
          desc: 'text-rose-700/80 dark:text-rose-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-rose-50/70 dark:hover:bg-rose-900/15',
          itemActive: 'bg-rose-600 text-white shadow-sm shadow-rose-200/60 dark:shadow-none',
          itemIcon: 'bg-rose-50 text-rose-700 border-rose-100 dark:bg-rose-900/25 dark:text-rose-200 dark:border-rose-900/25',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-200',
          accent: 'bg-white/80'
        },
        ops: {
          topbarTint: 'bg-gradient-to-r from-cyan-50/80 to-white/70 dark:from-cyan-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-cyan-200/60 dark:border-cyan-900/40',
          pill: 'bg-cyan-600 text-white',
          panelRing: 'ring-1 ring-cyan-200/60 dark:ring-cyan-900/40',
          panelGlow: 'bg-gradient-to-br from-cyan-50/70 to-white dark:from-cyan-900/10 dark:to-slate-900',
          header: 'hover:bg-cyan-50/70 dark:hover:bg-cyan-900/15',
          headerActive: 'bg-cyan-50/80 dark:bg-cyan-900/15',
          chip: 'bg-cyan-100 text-cyan-700 dark:bg-cyan-900/30 dark:text-cyan-200',
          icon: 'bg-cyan-100 text-cyan-700 border-cyan-200 dark:bg-cyan-900/30 dark:text-cyan-200 dark:border-cyan-900/30',
          iconOpen: 'bg-cyan-600 text-white border-transparent shadow-sm shadow-cyan-200/60 dark:shadow-none',
          titleOpen: 'text-cyan-900 dark:text-cyan-200',
          desc: 'text-cyan-700/80 dark:text-cyan-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-cyan-50/70 dark:hover:bg-cyan-900/15',
          itemActive: 'bg-cyan-600 text-white shadow-sm shadow-cyan-200/60 dark:shadow-none',
          itemIcon: 'bg-cyan-50 text-cyan-700 border-cyan-100 dark:bg-cyan-900/25 dark:text-cyan-200 dark:border-cyan-900/25',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-200',
          accent: 'bg-white/80'
        },
        projects: {
          topbarTint: 'bg-gradient-to-r from-blue-50/80 to-white/70 dark:from-blue-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-blue-200/60 dark:border-blue-900/40',
          pill: 'bg-blue-600 text-white',
          panelRing: 'ring-1 ring-blue-200/60 dark:ring-blue-900/40',
          panelGlow: 'bg-gradient-to-br from-blue-50/70 to-white dark:from-blue-900/10 dark:to-slate-900',
          header: 'hover:bg-blue-50/70 dark:hover:bg-blue-900/15',
          headerActive: 'bg-blue-50/80 dark:bg-blue-900/15',
          chip: 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-200',
          icon: 'bg-blue-100 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-200 dark:border-blue-900/30',
          iconOpen: 'bg-blue-600 text-white border-transparent shadow-sm shadow-blue-200/60 dark:shadow-none',
          titleOpen: 'text-blue-900 dark:text-blue-200',
          desc: 'text-blue-700/80 dark:text-blue-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-blue-50/70 dark:hover:bg-blue-900/15',
          itemActive: 'bg-blue-600 text-white shadow-sm shadow-blue-200/60 dark:shadow-none',
          itemIcon: 'bg-blue-50 text-blue-700 border-blue-100 dark:bg-blue-900/25 dark:text-blue-200 dark:border-blue-900/25',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200',
          accent: 'bg-white/80'
        },
        bi: {
          topbarTint: 'bg-gradient-to-r from-yellow-50/85 to-white/70 dark:from-yellow-900/15 dark:to-slate-900/70',
          topbarBorder: 'border-yellow-200/70 dark:border-yellow-900/40',
          pill: 'bg-yellow-500 text-slate-900',
          panelRing: 'ring-1 ring-yellow-200/70 dark:ring-yellow-900/40',
          panelGlow: 'bg-gradient-to-br from-yellow-50/70 to-white dark:from-yellow-900/10 dark:to-slate-900',
          header: 'hover:bg-yellow-50/70 dark:hover:bg-yellow-900/15',
          headerActive: 'bg-yellow-50/80 dark:bg-yellow-900/15',
          chip: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-200',
          icon: 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/30 dark:text-yellow-200 dark:border-yellow-900/30',
          iconOpen: 'bg-yellow-500 text-slate-900 border-transparent shadow-sm shadow-yellow-200/60 dark:shadow-none',
          titleOpen: 'text-yellow-900 dark:text-yellow-200',
          desc: 'text-yellow-700/80 dark:text-yellow-200/70',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/15',
          itemActive: 'bg-yellow-500 text-slate-900 shadow-sm shadow-yellow-200/60 dark:shadow-none',
          itemIcon: 'bg-yellow-50 text-yellow-800 border-yellow-100 dark:bg-yellow-900/25 dark:text-yellow-200 dark:border-yellow-900/25',
          itemIconActive: 'bg-black/10 text-slate-900 border-black/10',
          badge: 'bg-yellow-100 text-yellow-900 dark:bg-yellow-900/30 dark:text-yellow-200',
          accent: 'bg-slate-900/70'
        },
        admin: {
          topbarTint: 'bg-gradient-to-r from-slate-50/80 to-white/70 dark:from-slate-800/40 dark:to-slate-900/70',
          topbarBorder: 'border-slate-200/70 dark:border-slate-800',
          pill: 'bg-slate-900 text-white',
          panelRing: 'ring-1 ring-slate-200/70 dark:ring-slate-700/70',
          panelGlow: 'bg-gradient-to-br from-slate-50 to-white dark:from-slate-800/40 dark:to-slate-900',
          header: 'hover:bg-slate-50 dark:hover:bg-slate-800',
          headerActive: 'bg-slate-50 dark:bg-slate-800',
          chip: 'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200',
          icon: 'bg-slate-200 text-slate-700 border-slate-200 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700',
          iconOpen: 'bg-slate-900 text-white border-transparent',
          titleOpen: 'text-slate-900 dark:text-white',
          desc: 'text-slate-500 dark:text-slate-400',
          item: 'text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800',
          itemActive: 'bg-slate-900 text-white',
          itemIcon: 'bg-slate-100 text-slate-700 border-slate-200 dark:bg-slate-800 dark:text-slate-200 dark:border-slate-700',
          itemIconActive: 'bg-white/15 text-white border-white/10',
          badge: 'bg-slate-200 text-slate-800 dark:bg-slate-800 dark:text-slate-200',
          accent: 'bg-white/80'
        }
      },

      // NAVIGATION
      navigation: [
        { id:'core', name:'Accueil & Core', icon:'fa-solid fa-house', desc:'Vue g√©n√©rale, t√¢ches, documents, audits', theme:null,
          items:[
            {id:'dashboard', name:'Tableau de bord', icon:'fa-solid fa-chart-pie'},
            {id:'notifications', name:'Notifications', icon:'fa-solid fa-bell'},
            {id:'tasks', name:'T√¢ches & Rappels', icon:'fa-solid fa-list-check'},
            {id:'documents', name:'GED (Documents)', icon:'fa-solid fa-folder-open'},
            {id:'audit', name:'Journal & Audit', icon:'fa-solid fa-shield-halved'},
          ]
        },
        { id:'hr', name:'Ressources Humaines', icon:'fa-solid fa-users', desc:'Employ√©s, cong√©s, pointage, recrutement', theme:null,
          items:[
            {id:'employees', name:'Employ√©s', icon:'fa-solid fa-users'},
            {id:'contracts', name:'Contrats', icon:'fa-solid fa-file-signature'},
            {id:'leaves', name:'Cong√©s', icon:'fa-solid fa-calendar-check'},
            {id:'attendance', name:'Pointage', icon:'fa-solid fa-clock'},
            {id:'recruitment', name:'Recrutement', icon:'fa-solid fa-briefcase'},
            {id:'performance', name:'√âvaluations', icon:'fa-solid fa-star'},
            {id:'training', name:'Formations', icon:'fa-solid fa-graduation-cap'},
          ]
        },
        { id:'finance', name:'Finance & Comptabilit√©', icon:'fa-solid fa-coins', desc:'Facturation, paiements, budgets, rapports', theme:null,
          items:[
            {id:'finance_dashboard', name:'Dashboard finance', icon:'fa-solid fa-gauge'},
            {id:'invoicing', name:'Facturation', icon:'fa-solid fa-file-invoice-dollar'},
            {id:'payments', name:'Paiements', icon:'fa-solid fa-credit-card'},
            {id:'expenses', name:'D√©penses', icon:'fa-solid fa-receipt'},
            {id:'budgets', name:'Budgets', icon:'fa-solid fa-piggy-bank'},
            {id:'financial_reports', name:'√âtats financiers', icon:'fa-solid fa-file-lines'},
          ]
        },
        { id:'sales', name:'Ventes & CRM', icon:'fa-solid fa-handshake', desc:'Leads, opportunit√©s, devis, support', theme:null,
          items:[
            {id:'leads', name:'Prospects (Leads)', icon:'fa-solid fa-user-plus'},
            {id:'opportunities', name:'Opportunit√©s', icon:'fa-solid fa-mountain-sun'},
            {id:'quotes', name:'Devis', icon:'fa-solid fa-file-signature'},
            {id:'sales_orders', name:'Commandes', icon:'fa-solid fa-cart-shopping'},
            {id:'customer_support', name:'Support client', icon:'fa-solid fa-headset'},
          ]
        },
        { id:'ops', name:'Achats ‚Ä¢ Stock ‚Ä¢ Logistique', icon:'fa-solid fa-truck-ramp-box', desc:'Achats, inventaire, exp√©ditions', theme:null,
          items:[
            {id:'purchase_orders', name:'Bons de commande', icon:'fa-solid fa-file-invoice'},
            {id:'products', name:'Produits', icon:'fa-solid fa-box'},
            {id:'stock_moves', name:'Mouvements de stock', icon:'fa-solid fa-arrow-right-arrow-left'},
            {id:'inventory_counts', name:'Inventaires', icon:'fa-solid fa-clipboard-check'},
            {id:'shipments', name:'Exp√©ditions', icon:'fa-solid fa-truck-fast'},
            {id:'tracking', name:'Tracking', icon:'fa-solid fa-location-crosshairs'},
          ]
        },
        { id:'projects', name:'Projets', icon:'fa-solid fa-diagram-project', desc:'Kanban, jalons, co√ªts', theme:null,
          items:[
            {id:'projects_list', name:'Projets', icon:'fa-solid fa-folder'},
            {id:'kanban', name:'Kanban', icon:'fa-solid fa-table-columns'},
            {id:'gantt', name:'Gantt', icon:'fa-solid fa-chart-gantt'},
            {id:'project_costs', name:'Co√ªts projet', icon:'fa-solid fa-sack-dollar'},
          ]
        },
        { id:'bi', name:'BI & Reporting', icon:'fa-solid fa-chart-column', desc:'Dashboards, KPI, exports', theme:null,
          items:[
            {id:'dashboards', name:'Dashboards', icon:'fa-solid fa-chart-column'},
            {id:'reports', name:'Rapports', icon:'fa-solid fa-file-lines'},
            {id:'exports', name:'Exports', icon:'fa-solid fa-file-export'},
            {id:'data_quality', name:'Qualit√© des donn√©es', icon:'fa-solid fa-check-double'},
          ]
        },
        { id:'admin', name:'Administration', icon:'fa-solid fa-gear', desc:'Tenants, r√¥les, licences, logs', theme:null,
          items:[
            {id:'tenants', name:'Tenants', icon:'fa-solid fa-building'},
            {id:'users_roles', name:'Utilisateurs & R√¥les', icon:'fa-solid fa-users-gear'},
            {id:'permissions', name:'Permissions', icon:'fa-solid fa-user-shield'},
            {id:'license', name:'Licences', icon:'fa-solid fa-receipt'},
            {id:'logs', name:'Logs', icon:'fa-solid fa-scroll'},
            {id:'settings', name:'Param√®tres', icon:'fa-solid fa-sliders'},
          ]
        },
      ],

      // computed
      get viewTitle() {
        for (const g of this.navigation) {
          const it = g.items.find(x => x.id === this.currentView);
          if (it) return it.name;
        }
        return 'LyneERP';
      },
      get activeGroup() {
        for (const g of this.navigation) {
          if (g.items?.some(it => it.id === this.currentView)) return g;
        }
        return this.navigation?.[0] || null;
      },
      get topbarTheme() {
        const t = this.activeGroup?.theme || {};
        return {
          tint: t.topbarTint || 'bg-white/70 dark:bg-slate-900/70',
          border: t.topbarBorder || 'border-gray-200 dark:border-slate-800',
          pill: t.pill || 'bg-slate-900 text-white'
        };
      },
      get viewDesc() {
        return ({
          dashboard: 'Vue d‚Äôensemble de votre activit√© RH',
          employees: 'G√©rez votre effectif et les informations employ√©s',
          recruitment: 'Recrutez avec l‚Äôaide de l‚ÄôIA',
          leaves: 'Suivez et approuvez les demandes de cong√©s',
          attendance: 'Surveillez la pr√©sence et les heures',
          contracts: 'Gestion des contrats de travail et documents',
          payroll: 'Paie, primes, charges et bulletins',
          finance_dashboard: 'Vue globale comptable et tr√©sorerie',
        })[this.currentView] || 'Plateforme ERP intelligente';
      },

      toggleDark() {
        this.dark = !this.dark;
        Conf.dark = this.dark;
        Conf.save();
      },

      async ensureAuthenticated() {
        try {
          if (!this.token) this.token = getStoredAccessToken();

          try {
            const who = await this.apiCall('/api/auth/whoami/', {noAuth: true, noTenant: true});
            this.user = who?.user || {};
            this.tenantId = resolveInitialTenant(this.tenantId || who?.tenant);
            Conf.tenantId = this.tenantId;
            Conf.save();
            return;
          } catch (e) {
            log('Session whoami failed ‚Üí trying JWT', e?.message);
          }

          if (this.token) {
            const claims = parseJwt(this.token);
            await refreshTokenIfNeeded(claims?.exp);
            this.token = getStoredAccessToken();

            const who = await this.apiCall('/api/auth/whoami/', {noTenant: true});
            this.user = who?.user || {
              preferred_username: claims?.preferred_username,
              username: claims?.preferred_username
            };
            this.tenantId = resolveInitialTenant(this.tenantId || who?.tenant || claims?.tenant || claims?.tenant_id);
            Conf.token = this.token;
            Conf.tenantId = this.tenantId;
            Conf.save();
            return;
          }

          if (DEV_MODE) {
            this.user = {username: 'dev', preferred_username: 'dev'};
            this.tenantId = resolveInitialTenant(this.tenantId);
            Conf.tenantId = this.tenantId;
            Conf.save();
            return;
          }

          throw new Error("Aucune m√©thode d'authentification valide");
        } catch (e) {
          console.error('Authentication error:', e);
          this.authHint = true;
          if (!DEV_MODE) {
            setTimeout(() => {
              const loginUrl = '/auth/keycloak/login/';
              if (window.location.pathname !== loginUrl) window.location.assign(loginUrl);
            }, 1200);
          }
          throw e;
        }
      },

      async apiCall(path, options = {}) {
        this.authHint = false;
        const {noAuth = false, noTenant = false, cacheKey = null, cacheTtl = 0, ...fetchOptions} = options;

        const url = buildUrl(this.apiBase, path);
        const method = (fetchOptions.method || 'GET').toUpperCase();

        if (cacheKey && cacheTtl > 0) {
          const hit = cache.get(cacheKey);
          if (hit != null) return hit;
        }

        const headers = {'Content-Type': 'application/json'};
        const effectiveTenant = noTenant ? null : (this.tenantId || resolveInitialTenant() || FRONT_DEFAULT_TENANT);
        if (effectiveTenant) headers['X-Tenant-Id'] = effectiveTenant;
        if (!noAuth && this.token) headers['Authorization'] = `Bearer ${this.token}`;
        if (shouldSendCsrf(url, method)) {
          const csrf = getCookie('csrftoken');
          if (csrf) headers['X-CSRFToken'] = csrf;
        }

        try {
          this.loading = true;
          const res = await fetchWithBackoff(url, {...fetchOptions, headers}, {retries: 2, baseDelay: 300});
          const isJson = (res.headers.get('content-type') || '').includes('application/json');
          const payload = res.status === 204 ? null : (isJson ? await res.json().catch(() => null) : null);

          if (!res.ok) {
            if (res.status === 401 || res.status === 403) this.authHint = true;
            const detail = payload?.detail || payload?.message || '';
            throw new Error(`${res.status} ${res.statusText}${detail ? ' - ' + detail : ''}`);
          }

          if (cacheKey && cacheTtl > 0) cache.set(cacheKey, payload, cacheTtl);
          return payload;
        } catch (e) {
          console.error(e);
          this.showToast(e.message || 'Erreur API', 'error');
          throw e;
        } finally {
          this.loading = false;
        }
      },

      prefetch(k) {
        if (k === 'dashboard' && !Object.keys(this.dashboardStats).length) this.loadDashboardStats();
        if (k === 'employees' && !this.employees.length) this.loadEmployees();
        if (k === 'recruitment' && !this.recruitments.length) this.loadRecruitments();
      },

      async loadDashboardStats() {
        try {
          this.dashboardStats = await this.apiCall('dashboard/stats/', {cacheKey: 'dashboard_stats', cacheTtl: 30000});
        } catch (_) {}
      },
      async loadEmployees() {
        try {
          const d = await this.apiCall('employees/');
          this.employees = d?.results || d || [];
        } catch (_) {}
      },
      async loadRecruitments() {
        try {
          const d = await this.apiCall('recruitments/');
          this.recruitments = d?.results || d || [];
        } catch (_) {}
      },

      showToast(message, type = 'info') {
        if (window.hrToast) window.hrToast(message, type);
        const t = {message, type, visible: true};
        this.toasts.push(t);
        setTimeout(() => {
          t.visible = false;
          this.toasts = this.toasts.filter(x => x !== t);
        }, 3800);
      },
      removeToast(i) { this.toasts.splice(i, 1); },

      saveConf() {
        this.apiBase = normalizeApiBase(this.apiBase);
        Conf.apiBase = this.apiBase;
        Conf.tenantId = this.tenantId;
        Conf.token = this.token;
        Conf.dark = this.dark;
        Conf.save();
        this.showToast('Configuration enregistr√©e', 'success');
      },

      applyTenant() {
        this.tenantId = this.tenantId || FRONT_DEFAULT_TENANT;
        Conf.tenantId = this.tenantId;
        Conf.save();
        cache.del('dashboard_stats');
        this.loadDashboardStats();
        this.loadEmployees();
        this.loadRecruitments();
        this.showToast('Tenant appliqu√©', 'success');
        this.openSettings = false;
      },

      handleOnline() { this.online = true; this.showToast('Connexion r√©tablie', 'success'); },
      handleOffline() { this.online = false; this.showToast('Vous √™tes hors ligne', 'warning'); },

      logout() { kcLogout(); },

      async init() {
        // inject themes
        this.navigation = (this.navigation || []).map(g => ({...g, theme: this.navThemes[g.id] || this.navThemes.admin}));

        // open group for current view
        const g = this.navigation.find(x => x.items?.some(it => it.id === this.currentView));
        this.openGroupId = g?.id || 'hr';

        // watch collapsed (UX: close in collapsed, restore on expand)
        this.$watch('sidebarCollapsed', (v) => {
          if (v) this.openGroupId = null;
          else {
            const gg = this.navigation.find(x => x.items?.some(it => it.id === this.currentView));
            this.openGroupId = gg?.id || 'hr';
          }
        });

        this.apiBase = normalizeApiBase(localStorage.getItem('lyneerp_api') || this.apiBase);
        this.tenantId = resolveInitialTenant(localStorage.getItem('lyneerp_tenant') || this.tenantId);
        this.token = getStoredAccessToken() || this.token;

        await this.ensureAuthenticated();
        this.loadDashboardStats();
        this.loadEmployees();
        this.loadRecruitments();

        window.addEventListener('online', () => this.handleOnline());
        window.addEventListener('offline', () => this.handleOffline());
      },

      get cmdResults() {
        const q = this.cmdQuery.toLowerCase().trim();
        const base = [
          {key:'cfg', label:'Ouvrir Configuration', desc:'API / Tenant / Token', icon:'fa-solid fa-gear', action:()=> this.openSettings=true},
          {key:'dm', label:'Basculer Mode sombre', desc:'Raccourci ‚åò/Ctrl + J', icon:'fa-solid fa-moon', action:()=> this.toggleDark()},
        ];

        const pages = [];
        for (const g of this.navigation) {
          for (const it of g.items) {
            pages.push({key:'nav:'+it.id, label: it.name, desc: g.name, icon: it.icon, action:()=> this.switchView(it)});
          }
        }

        const items = [...pages, ...base];
        if (!q) return items.slice(0, 40);
        return items.filter(it => (it.label + ' ' + it.desc).toLowerCase().includes(q)).slice(0, 40);
      },
    }
  }

  document.addEventListener('alpine:init', () => {
    Alpine.magic('cmd', el => e => e.metaKey && !e.shiftKey);
    Alpine.magic('ctrl', el => e => e.ctrlKey && !e.shiftKey);
  });

  window.formatDate = (s) => s ? new Date(s).toLocaleDateString('fr-FR') : '';
  window.formatDateTime = (s) => s ? new Date(s).toLocaleString('fr-FR') : '';
</script>

<script>
  // Toast helper
  window.hrToast = function (message, type = 'info') {
    if (typeof Swal === 'undefined') { alert(message); return; }

    let icon = 'info';
    if (type === 'success') icon = 'success';
    else if (type === 'error') icon = 'error';
    else if (type === 'warning') icon = 'warning';

    Swal.fire({
      toast: true,
      position: 'top-end',
      showConfirmButton: false,
      timer: 3500,
      timerProgressBar: true,
      icon,
      title: message,
    });
  };
</script>

</body>
</html>