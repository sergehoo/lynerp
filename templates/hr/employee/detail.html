{# Lyneerp/hr/templates/hr/employee/detail.html #}
{% extends "./base_employee.html" %}
{% load humanize %}

{% block title %}Dossier Employ√© ‚Äî {{ employee.full_name }}{% endblock %}
{% block page_mode %}server{% endblock %}
{% block server_title %}Dossier Employ√©{% endblock %}
{% block server_desc %}Fiche compl√®te, contrats, cong√©s, paies, performance, documents, pointage‚Ä¶{% endblock %}

{% block page_content %}
<div class="rounded-3xl bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 p-6">
  <div class="max-w-7xl mx-auto py-4 space-y-6" x-data="employeeDashboard('{{ active_tab|default:'overview' }}')">

    <!-- HEADER STICKY -->
    <div class="sticky top-3 z-10">
      <div class="rounded-3xl border border-gray-100 dark:border-slate-800 bg-white/90 dark:bg-slate-900/80 backdrop-blur p-6 shadow-sm">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <div class="flex items-center gap-4 min-w-0">
            <div class="relative shrink-0">
              <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-700 text-white flex items-center justify-center text-xl font-bold uppercase">
                {{ employee.first_name|first }}{{ employee.last_name|first }}
              </div>
              <div class="absolute -bottom-1 -right-1 w-6 h-6 rounded-full border-2 border-white
                {% if employee.is_active %} bg-emerald-500 {% else %} bg-rose-500 {% endif %}">
              </div>
            </div>

            <div class="min-w-0">
              <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                <span>Matricule ‚Ä¢ <span class="font-semibold text-slate-600 dark:text-slate-200">{{ employee.matricule|default:"‚Äî" }}</span></span>
                <span class="text-slate-300">‚Ä¢</span>
                <span class="px-2 py-0.5 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-200 font-medium">
                  ID: {{ employee.id|slice:":8" }}
                </span>
                <span class="text-slate-300">‚Ä¢</span>
                <span class="font-medium text-slate-600 dark:text-slate-200">{{ tenant.name }}</span>
              </div>

              <div class="mt-1 text-2xl font-bold text-slate-900 dark:text-white truncate">
                {{ employee.full_name }}
              </div>

              <div class="text-sm text-slate-500 dark:text-slate-300 flex flex-wrap items-center gap-2">
                <span>{{ employee.position.title|default:"‚Äî" }}</span>
                <span class="text-slate-300">‚Ä¢</span>
                <span>{{ employee.department.name|default:"‚Äî" }}</span>
                <span class="text-slate-300">‚Ä¢</span>
                <span>{{ employee.email|default:"‚Äî" }}</span>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-2 items-center justify-start lg:justify-end">
            <span class="px-3 py-1.5 rounded-full text-xs font-semibold border
              {% if employee.is_active %} bg-emerald-50 text-emerald-700 border-emerald-200 {% else %} bg-rose-50 text-rose-700 border-rose-200 {% endif %}">
              {% if employee.is_active %}‚úì Actif{% else %}‚úó Inactif{% endif %}
            </span>

            <span class="px-3 py-1.5 rounded-full text-xs font-semibold border
              {% if employee.is_on_leave %} bg-amber-50 text-amber-700 border-amber-200 {% else %} bg-slate-50 text-slate-600 border-slate-200 {% endif %}">
              {% if employee.is_on_leave %}üèùÔ∏è En cong√©{% else %}‚úÖ Disponible{% endif %}
            </span>

            <a href="mailto:{{ employee.email }}"
               class="px-4 py-2 rounded-full bg-slate-900 hover:bg-slate-800 text-white text-xs font-semibold flex items-center gap-2 transition-colors">
              <i class="fa-solid fa-envelope text-xs"></i> Email
            </a>

            <button @click="printProfile()"
              class="px-4 py-2 rounded-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-xs font-semibold flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
              <i class="fa-solid fa-print text-xs"></i> Imprimer
            </button>
          </div>
        </div>

        <!-- KPI LINE -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6 pt-6 border-t border-slate-100 dark:border-slate-800">
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-white">{{ employee.seniority|floatformat:1 }}</div>
            <div class="text-xs text-slate-500">Ann√©es</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-white">{{ counts.leaves|default:"0" }}</div>
            <div class="text-xs text-slate-500">Cong√©s</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-white">{{ counts.contracts|default:"0" }}</div>
            <div class="text-xs text-slate-500">Contrats</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-white">{{ counts.payrolls|default:"0" }}</div>
            <div class="text-xs text-slate-500">Fiches de paie</div>
          </div>
          <div class="text-center">
            <div class="text-2xl font-bold text-slate-900 dark:text-white">
              {% if current_contract %}
                {{ current_contract.base_salary|floatformat:0|intcomma }} {{ current_contract.salary_currency }}
              {% else %}‚Äî{% endif %}
            </div>
            <div class="text-xs text-slate-500">Salaire actuel</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Anchor for smooth scroll -->
    <div x-ref="tabContent"></div>

    <!-- TABS (sticky) -->
    <div class="sticky top-[220px] z-10">
      <div class="rounded-3xl border border-gray-100 dark:border-slate-800 bg-white/90 dark:bg-slate-900/80 backdrop-blur p-3 shadow-sm">
        <div class="flex flex-wrap gap-2">
          {% include "hr/employee/_tab_btn.html" with key="overview" label="Aper√ßu" icon="fa-chart-column" badge="" %}
          {% include "hr/employee/_tab_btn.html" with key="contracts" label="Contrats" icon="fa-file-contract" badge=counts.contracts %}
          {% include "hr/employee/_tab_btn.html" with key="leaves" label="Cong√©s" icon="fa-umbrella-beach" badge=counts.leaves %}
          {% include "hr/employee/_tab_btn.html" with key="attendance" label="Pointage" icon="fa-clock" badge=counts.attendance %}
          {% include "hr/employee/_tab_btn.html" with key="payroll" label="Paie" icon="fa-money-bill-wave" badge=counts.payrolls %}
          {% include "hr/employee/_tab_btn.html" with key="docs" label="Documents" icon="fa-folder-open" badge=counts.documents %}
          {% include "hr/employee/_tab_btn.html" with key="performance" label="Performance" icon="fa-chart-line" badge=counts.performance %}
          {% include "hr/employee/_tab_btn.html" with key="salary" label="Salaire" icon="fa-sack-dollar" badge=counts.salary %}
          {% include "hr/employee/_tab_btn.html" with key="history" label="Historique" icon="fa-clock-rotate-left" badge=counts.history %}
          {% if can_view_medical %}
            {% include "hr/employee/_tab_btn.html" with key="medical" label="M√©dical" icon="fa-kit-medical" badge="" danger=1 %}
          {% endif %}
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="space-y-6">

      <!-- OVERVIEW -->
      <div x-show="activeTab==='overview'" x-cloak class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="rounded-3xl border border-slate-100 dark:border-slate-800 p-5 bg-white dark:bg-slate-900">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-semibold text-slate-900 dark:text-white">Informations personnelles</div>
              <i class="fa-solid fa-user text-slate-400"></i>
            </div>
            <dl class="space-y-2 text-sm">
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Email</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ employee.email|default:"‚Äî" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">T√©l√©phone</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ employee.phone|default:"‚Äî" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Naissance</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ employee.birth_date|date:"d/m/Y"|default:"‚Äî" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Ville</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ employee.city|default:"‚Äî" }}</dd></div>
            </dl>
          </div>

          <div class="rounded-3xl border border-slate-100 dark:border-slate-800 p-5 bg-white dark:bg-slate-900">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-semibold text-slate-900 dark:text-white">Situation professionnelle</div>
              <i class="fa-solid fa-briefcase text-slate-400"></i>
            </div>
            <dl class="space-y-2 text-sm">
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Embauche</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ employee.hire_date|date:"d/m/Y"|default:"‚Äî" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Contrat</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{% if current_contract %}{{ current_contract.contract_type.name|default:"‚Äî" }}{% else %}‚Äî{% endif %}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Statut</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ employee.get_employment_status_display|default:"‚Äî" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Taux horaire</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{% if current_contract %}{{ current_contract.hourly_rate|floatformat:2|intcomma }} {{ current_contract.salary_currency }}{% else %}‚Äî{% endif %}</dd></div>
            </dl>
          </div>

          <div class="rounded-3xl border border-slate-100 dark:border-slate-800 p-5 bg-white dark:bg-slate-900">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-semibold text-slate-900 dark:text-white">Statistiques</div>
              <i class="fa-solid fa-chart-pie text-slate-400"></i>
            </div>
            <dl class="space-y-2 text-sm">
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Jours travaill√©s (30j)</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ stats.last_30_days_worked|default:"0" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Retards (mois)</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ stats.late_arrivals_month|default:"0" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Absences (ann√©e)</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ stats.absences_year|default:"0" }}</dd></div>
              <div class="flex justify-between gap-3"><dt class="text-slate-500">Heures supp. (mois)</dt><dd class="font-medium text-slate-900 dark:text-slate-100">{{ stats.overtime_month|default:"0" }}h</dd></div>
            </dl>
          </div>
        </div>

        <!-- Soldes cong√©s -->
        <div class="rounded-3xl border border-slate-100 dark:border-slate-800 p-5 bg-white dark:bg-slate-900">
          <div class="flex items-center justify-between mb-4">
            <div class="text-sm font-semibold text-slate-900 dark:text-white">Soldes de cong√©s {{ current_year }}</div>
            <div class="text-xs text-slate-500">Total utilis√© : {{ stats.total_leave_used|default:"0" }} jours</div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for b in leave_balances %}
              <div class="rounded-2xl border border-slate-100 dark:border-slate-800 p-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-medium text-slate-900 dark:text-white">{{ b.leave_type.name }}</div>
                  <div class="text-xs text-slate-400">{{ b.year }}</div>
                </div>
                <div class="flex items-center justify-between mb-2">
                  <div class="text-lg font-bold text-slate-900 dark:text-white">{{ b.remaining_days }} j</div>
                  <div class="text-xs text-slate-500">/ {{ b.total_days }} j</div>
                </div>
                <div class="w-full bg-slate-100 dark:bg-slate-800 rounded-full h-2">
                  <div class="bg-emerald-500 h-2 rounded-full" style="width: {{ b.utilization_rate|floatformat:0 }}%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-500 mt-1">
                  <span>Restants</span>
                  <span>{{ b.utilization_rate|floatformat:0 }}% utilis√©</span>
                </div>
              </div>
            {% empty %}
              <div class="col-span-3 text-center py-10 text-slate-500 text-sm">Aucun solde de cong√©.</div>
            {% endfor %}
          </div>
        </div>

        <!-- √âch√©ances -->
        <div class="rounded-3xl border border-slate-100 dark:border-slate-800 p-5 bg-white dark:bg-slate-900">
          <div class="text-sm font-semibold text-slate-900 dark:text-white mb-4">Prochaines √©ch√©ances</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            {% for d in upcoming_deadlines %}
              <div class="rounded-2xl bg-amber-50 dark:bg-amber-900/20 border border-amber-100 dark:border-amber-800 p-4">
                <div class="flex items-center justify-between mb-2">
                  <div class="text-xs font-medium text-amber-700 dark:text-amber-200">{{ d.type }}</div>
                  <div class="text-xs text-amber-600 dark:text-amber-300">{{ d.date|date:"d/m" }}</div>
                </div>
                <div class="text-sm text-amber-900 dark:text-amber-100">{{ d.description }}</div>
              </div>
            {% empty %}
              <div class="col-span-3 text-center py-10 text-slate-500 text-sm">Aucune √©ch√©ance.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- CONTRACTS -->
      {% include "hr/employee/_tab_contracts.html" %}

      <!-- LEAVES -->
      {% include "hr/employee/_tab_leaves.html" %}

      <!-- ATTENDANCE -->
      {% include "hr/employee/_tab_attendance.html" %}

      <!-- PAYROLL -->
      {% include "hr/employee/_tab_payroll.html" %}

      <!-- DOCS -->
      {% include "hr/employee/_tab_docs.html" %}

      <!-- PERFORMANCE -->
      {% include "hr/employee/_tab_performance.html" %}

      <!-- SALARY -->
      {% include "hr/employee/_tab_salary.html" %}

      <!-- HISTORY -->
      {% include "hr/employee/_tab_history.html" %}

      <!-- MEDICAL -->
      {% if can_view_medical %}
        {% include "hr/employee/_tab_medical.html" %}
      {% endif %}

    </div>

  </div>
</div>

<script>
function employeeDashboard(initialTab) {
  return {
    activeTab: initialTab || 'overview',
    changeTab(tab) {
      this.activeTab = tab;
      const url = new URL(window.location.href);
      url.searchParams.set('tab', tab);
      // on ne casse pas les filtres d√©j√† pr√©sents
      window.history.replaceState({}, '', url.toString());
      this.$nextTick(() => this.$refs.tabContent?.scrollIntoView({behavior: 'smooth', block: 'start'}));
    },
    printProfile() { window.print(); },
  }
}
</script>
{% endblock %}