<!-- Lyneerp/hr/templates/hr/partials/employees.html -->
<div class="space-y-8" x-data="employeeView()" x-init="init()">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-slate-900 text-white text-xs font-medium mb-2">
                <i class="fas fa-users-cog text-[11px]"></i>
                <span>Ressources humaines ‚Ä¢ Employ√©s</span>
            </div>
            <h3 class="text-2xl font-semibold text-slate-900 tracking-tight">Gestion des employ√©s</h3>
            <p class="text-sm text-slate-500 mt-1">
                Recherchez, filtrez, importez, exportez et g√©rez votre effectif en temps r√©el.
            </p>
        </div>
        <div class="flex flex-wrap gap-2">
            <button
                    @click="openImport()"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-gray-200 bg-white text-sm font-medium text-slate-600 hover:bg-gray-50 shadow-sm">
                <i class="fas fa-file-import text-[13px]"></i>
                <span>Importer</span>
            </button>
            <button
                    @click="openExport()"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-emerald-200 bg-emerald-50 text-sm font-medium text-emerald-700 hover:bg-emerald-100">
                <i class="fas fa-download text-[13px]"></i>
                <span>Exporter</span>
            </button>
            <button
                    @click="openCreate()"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-900 text-white text-sm font-semibold shadow-sm shadow-slate-400/40 hover:bg-slate-800">
                <i class="fas fa-plus text-[13px]"></i>
                <span>Nouvel employ√©</span>
            </button>
        </div>
    </div>


    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center shadow-md shadow-slate-300/70">
                <i class="fas fa-users text-sm"></i>
            </div>
            <div>
                <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Total (tous)</div>
                <div class="mt-1 text-2xl font-semibold text-slate-900 tracking-tight" x-text="total"></div>
                <div class="text-[11px] text-slate-400">Selon les filtres et la pagination</div>
            </div>
        </div>
        <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
                <i class="fas fa-user-check text-sm"></i>
            </div>
            <div>
                <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Actifs (page)</div>
                <div class="mt-1 text-2xl font-semibold text-emerald-600 tracking-tight" x-text="counts.active"></div>
                <div class="text-[11px] text-slate-400">Visibles sur la page actuelle</div>
            </div>
        </div>
        <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-rose-50 text-rose-600 flex items-center justify-center">
                <i class="fas fa-user-slash text-sm"></i>
            </div>
            <div>
                <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Inactifs (page)</div>
                <div class="mt-1 text-2xl font-semibold text-rose-600 tracking-tight" x-text="counts.inactive"></div>
                <div class="text-[11px] text-slate-400">Visibles sur la page actuelle</div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <!-- Filtres -->
    <div class="bg-white border border-gray-100 rounded-3xl shadow-sm p-5">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
            <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <!-- Search -->
                <div class="relative">
                    <input
                            type="text"
                            placeholder="Rechercher (nom, email, matricule)‚Ä¶"
                            class="w-full pl-10 pr-3 py-2.5 rounded-full border border-gray-200 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
                            x-model="search"
                            @input.debounce.400ms="page=1; fetchEmployees()">
                    <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                </div>

                <!-- D√©partement -->
                <div>
                    <select
                            x-model="filters.department"
                            @change="page=1; fetchEmployees()"
                            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                        <option value="">Tous les d√©partements</option>
                        <template x-for="d in departments" :key="d.id">
                            <option :value="String(d.id)" x-text="d.name"></option>
                        </template>
                    </select>
                </div>

                <!-- Contrat -->
                <div>
                    <select
                            x-model="filters.contract_type"
                            @change="page=1; fetchEmployees()"
                            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                        <option value="">Tous contrats</option>
                        <option value="CDI">CDI</option>
                        <option value="CDD">CDD</option>
                        <option value="STAGE">Stage</option>
                        <option value="ALTERNANCE">Alternance</option>
                    </select>
                </div>

                <!-- Statut -->
                <div>
                    <select
                            x-model="filters.is_active"
                            @change="page=1; fetchEmployees()"
                            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                        <option value="">Actif + Inactif</option>
                        <option value="true">Actif</option>
                        <option value="false">Inactif</option>
                    </select>
                </div>
            </div>

            <!-- Tri & page size + reset -->
            <div class="flex items-center gap-3 justify-end">
                <button
                        type="button"
                        @click="resetFilters()"
                        class="px-3 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50 inline-flex items-center gap-1.5">
                    <i class="fas fa-rotate-left text-[11px]"></i>
                    <span>R√©initialiser</span>
                </button>
                <select
                        x-model="ordering"
                        @change="page=1; fetchEmployees()"
                        class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    <option value="last_name">Nom (A‚ÜíZ)</option>
                    <option value="-last_name">Nom (Z‚ÜíA)</option>
                    <option value="-hire_date">Embauche r√©cents</option>
                    <option value="hire_date">Embauche anciens</option>
                    <option value="-created_at">Cr√©√©s r√©cents</option>
                    <option value="created_at">Cr√©√©s anciens</option>
                </select>
                <select
                        x-model.number="pageSize"
                        @change="page=1; fetchEmployees()"
                        class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Actions batch -->
    <div class="flex flex-wrap items-center gap-2" x-show="selectedIds.length">
        <div class="text-xs text-slate-500 bg-slate-50 border border-slate-100 px-3 py-1.5 rounded-full">
            <span class="font-semibold text-slate-900" x-text="selectedIds.length"></span>
            <span class="ml-1">s√©lectionn√©(s)</span>
        </div>
        <button
                @click="batch('activate')"
                class="px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100 text-xs font-medium inline-flex items-center gap-1.5">
            <i class="fas fa-toggle-on text-[11px]"></i> Activer
        </button>
        <button
                @click="batch('deactivate')"
                class="px-3 py-1.5 rounded-full bg-amber-50 text-amber-700 hover:bg-amber-100 text-xs font-medium inline-flex items-center gap-1.5">
            <i class="fas fa-toggle-off text-[11px]"></i> D√©sactiver
        </button>
        <button
                @click="openBatchDepartment()"
                class="px-3 py-1.5 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-xs font-medium inline-flex items-center gap-1.5">
            <i class="fas fa-right-left text-[11px]"></i> Changer de d√©partement
        </button>
        <button
                @click="openTerminate()"
                class="px-3 py-1.5 rounded-full bg-rose-50 text-rose-700 hover:bg-rose-100 text-xs font-medium inline-flex items-center gap-1.5">
            <i class="fas fa-user-slash text-[11px]"></i> Terminer
        </button>
    </div>

    <!-- Tableau -->
    <div class="bg-white border border-gray-100 rounded-3xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-slate-700">
                <thead class="bg-gray-50 text-xs font-semibold text-slate-400 uppercase">
                <tr>
                    <th class="px-4 py-3">
                        <input type="checkbox" @change="toggleAll($event)" :checked="allChecked"
                               class="rounded border-slate-300">
                    </th>
                    <th class="px-6 py-3 text-left">Entreprise</th>
                    <th class="px-6 py-3 text-left">Employ√©</th>
                    <th class="px-6 py-3 text-left">D√©partement</th>
                    <th class="px-6 py-3 text-left">Poste</th>
                    <th class="px-6 py-3 text-left">Contrat</th>
                    <th class="px-6 py-3 text-left">Embauche</th>
                    <th class="px-6 py-3 text-left">Statut</th>
                    <th class="px-6 py-3 text-right">Actions</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-100">
                <!-- skeleton -->
                <template x-if="loading">
                    <template x-for="i in 6" :key="i">
                        <tr>
                           <td class="px-6 py-4 text-sm text-slate-700">
  <div class="font-medium text-slate-900" x-text="emp.tenant_name || '‚Äî'"></div>
  <div class="text-[11px] text-slate-400" x-text="emp.tenant_slug || ''"></div>
</td>
                            <td class="px-4 py-4">
                                <div class="h-4 w-4 skeleton rounded-full"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-40 skeleton rounded"></div>
                                <div class="h-3 w-32 mt-2 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-28 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-28 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-16 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-20 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-6 w-16 skeleton rounded-full"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-8 w-24 ml-auto skeleton rounded-full"></div>
                            </td>
                        </tr>
                    </template>
                </template>

                <!-- rows -->
                <template x-for="emp in employees" :key="emp.id">
                    <tr class="hover:bg-gray-50/70 transition-colors">
                        <td class="px-4 py-4">
                            <input
                                    type="checkbox"
                                    :value="emp.id"
                                    @change="toggleOne(emp.id, $event)"
                                    :checked="selectedIds.includes(emp.id)"
                                    class="rounded border-slate-300">
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-slate-900/90 text-white flex items-center justify-center text-xs font-semibold uppercase">
                                    <span x-text="(emp.first_name?.[0] || '') + (emp.last_name?.[0] || '')"></span>
                                </div>
                                <div class="min-w-0">
                                    <div class="text-sm font-semibold text-slate-900 truncate"
                                         x-text="`${emp.first_name} ${emp.last_name}`"></div>
                                    <div class="text-xs text-slate-500 truncate" x-text="emp.email"></div>
                                    <div class="text-[11px] text-slate-400" x-text="emp.matricule"></div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-700"
                            x-text="emp.department_name || emp.department?.name || '‚Äî'"></td>
                        <td class="px-6 py-4 text-sm text-slate-700"
                            x-text="emp.position_title || emp.position?.title || '‚Äî'"></td>
                        <td class="px-6 py-4 text-sm text-slate-700" x-text="emp.contract_type || '‚Äî'"></td>
                        <td class="px-6 py-4 text-sm text-slate-500" x-text="formatDate(emp.hire_date) || '‚Äî'"></td>
                        <td class="px-6 py-4">
                            <button
                                    @click="toggleActive(emp)"
                                    class="px-2.5 py-1 rounded-full text-[11px] font-semibold inline-flex items-center gap-1.5"
                                    :class="emp.is_active ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'">
                                <i :class="emp.is_active ? 'fas fa-toggle-on text-[12px]' : 'fas fa-toggle-off text-[12px]'"></i>
                                <span x-text="emp.is_active ? 'Actif' : 'Inactif'"></span>
                            </button>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex justify-end gap-2">
                                <button
                                        @click="openEdit(emp)"
                                        class="px-3 py-1.5 text-xs rounded-full bg-slate-900 text-white hover:bg-slate-800 inline-flex items-center gap-1.5">
                                    <i class="fas fa-edit text-[11px]"></i>
                                    <span>√âditer</span>
                                </button>
                                <button
                                        @click="confirmDelete(emp)"
                                        class="px-3 py-1.5 text-xs rounded-full bg-white border border-rose-200 text-rose-600 hover:bg-rose-50 inline-flex items-center gap-1.5">
                                    <i class="fas fa-trash text-[11px]"></i>
                                    <span>Supprimer</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>

                <!-- empty -->
                <tr x-show="!loading && employees.length===0">
                    <td colspan="8" class="py-16 text-center">
                        <div class="inline-flex flex-col items-center justify-center px-6 py-5 rounded-3xl border border-dashed border-gray-300 bg-gray-50/60">
                            <i class="fas fa-users text-gray-300 text-4xl mb-2"></i>
                            <div class="text-sm font-medium text-slate-900">Aucun employ√©</div>
                            <div class="text-xs text-slate-500 mb-3">Ajoutez votre premier collaborateur pour
                                commencer.
                            </div>
                            <button
                                    @click="openCreate()"
                                    class="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-semibold hover:bg-slate-800">
                                <i class="fas fa-plus text-[11px]"></i>
                                <span>Ajouter un employ√©</span>
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="flex flex-col sm:flex-row items-center justify-between gap-3 px-4 py-3 border-t border-gray-100 bg-gray-50/80">
            <div class="text-xs text-slate-500" x-text="paginationText()"></div>
            <div class="flex gap-2">
                <button
                        @click="prevPage()"
                        :disabled="page<=1"
                        class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-medium text-slate-700 bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
                    <i class="fas fa-chevron-left text-[10px]"></i>
                    <span>Pr√©c√©dent</span>
                </button>
                <button
                        @click="nextPage()"
                        :disabled="page>=maxPage"
                        class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-medium text-slate-700 bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
                    <span>Suivant</span>
                    <i class="fas fa-chevron-right text-[10px]"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Cr√©ation / √âdition -->
    <div x-show="showForm" x-cloak
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                <div>
                    <h4 class="text-base font-semibold text-slate-900"
                        x-text="editId ? 'Modifier l‚Äôemploy√©' : 'Nouvel employ√©'"></h4>
                    <p class="text-xs text-slate-500 mt-0.5">Compl√©tez les informations principales de l‚Äôemploy√©.</p>
                </div>
                <button @click="closeForm()" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <form @submit.prevent="submitForm()" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Matricule</label>
                        <input
                                type="text"
                                x-model.trim="form.matricule"
                                required
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Email</label>
                        <input
                                type="email"
                                x-model.trim="form.email"
                                required
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Pr√©nom</label>
                        <input
                                type="text"
                                x-model.trim="form.first_name"
                                required
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Nom</label>
                        <input
                                type="text"
                                x-model.trim="form.last_name"
                                required
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Date d‚Äôembauche</label>
                        <input
                                type="date"
                                x-model="form.hire_date"
                                required
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Type de contrat</label>
                        <select
                                x-model="form.contract_type"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                            <option value="CDI">CDI</option>
                            <option value="CDD">CDD</option>
                            <option value="STAGE">Stage</option>
                            <option value="ALTERNANCE">Alternance</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">D√©partement</label>
                        <select
                                x-model="form.department"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                            <option value="">‚Äî</option>
                            <template x-for="d in departments" :key="d.id">
                                <option :value="d.id" x-text="d.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Poste</label>
                        <select
                                x-model="form.position"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                            <option value="">‚Äî</option>
                            <template x-for="p in positions" :key="p.id">
                                <option :value="p.id" x-text="p.title"></option>
                            </template>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 pt-2">
                        <input type="checkbox" x-model="form.is_active" class="rounded border-slate-300">
                        <label class="text-xs text-slate-600">Actif</label>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-2 pt-3 border-t border-gray-100">
                    <button
                            type="button"
                            @click="closeForm()"
                            class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
                        Annuler
                    </button>
                    <button
                            type="submit"
                            class="px-4 py-2 rounded-full bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800 inline-flex items-center gap-2"
                            :disabled="submitting">
                        <i class="fas fa-circle-notch fa-spin text-[11px]" x-show="submitting"></i>
                        <span x-text="editId ? 'Enregistrer' : 'Cr√©er'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import -->
    <div x-show="showImport" x-cloak
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                <div>
                    <h4 class="text-base font-semibold text-slate-900">Importer des employ√©s</h4>
                    <p class="text-xs text-slate-500 mt-0.5">Importez un fichier Excel ou CSV conforme √† votre
                        mod√®le.</p>
                </div>
                <button @click="showImport=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">Fichier (.csv ou .xlsx)</label>
                    <input type="file" accept=".csv,.xlsx" @change="handleFile" class="w-full text-xs">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" x-model="importUpdateExisting" class="rounded border-slate-300">
                    <label class="text-xs text-slate-600">Mettre √† jour les enregistrements existants</label>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button
                        @click="showImport=false"
                        class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
                    Annuler
                </button>
                <button
                        @click="doImport()"
                        class="px-4 py-2 rounded-full bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800"
                        :disabled="!importFile">
                    Importer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Export -->
    <div x-show="showExport" x-cloak
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
                <div>
                    <h4 class="text-base font-semibold text-slate-900">Exporter les employ√©s</h4>
                    <p class="text-xs text-slate-500 mt-0.5">Filtrez les donn√©es puis g√©n√©rez un fichier √† partager.</p>
                </div>
                <button @click="showExport=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-6 space-y-6 text-sm">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-1">
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Format</label>
                        <select x-model="exportFormat"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
                            <option value="xlsx">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Champs</label>
                        <div class="grid grid-cols-2 gap-2">
                            <template x-for="f in exportFieldsAll" :key="f.value">
                                <label class="text-xs flex items-center gap-2">
                                    <input type="checkbox" :value="f.value" x-model="exportFields"
                                           class="rounded border-slate-300">
                                    <span x-text="f.label"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">D√©partement</label>
                        <select x-model="exportFilters.department"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
                            <option value="">Tous</option>
                            <template x-for="d in departments" :key="d.id">
                                <option :value="d.id" x-text="d.name"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Contrat</label>
                        <select x-model="exportFilters.contract_type"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
                            <option value="">Tous</option>
                            <option value="CDI">CDI</option>
                            <option value="CDD">CDD</option>
                            <option value="STAGE">Stage</option>
                            <option value="ALTERNANCE">Alternance</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-500 mb-1 block">Statut</label>
                        <select x-model="exportFilters.is_active"
                                class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
                            <option value="">Actif + Inactif</option>
                            <option value="true">Actif</option>
                            <option value="false">Inactif</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button
                        @click="showExport=false"
                        class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
                    Annuler
                </button>
                <button
                        @click="doExport()"
                        class="px-4 py-2 rounded-full bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700"
                        :disabled="!exportFields.length">
                    Exporter
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Delete -->
    <div x-show="confirming" x-cloak
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h4 class="text-base font-semibold text-slate-900">Supprimer l‚Äôemploy√©</h4>
                <button @click="confirming=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-6 text-sm text-slate-700">
                <p>Supprimer d√©finitivement
                    <span class="font-semibold" x-text="toDelete?.first_name + ' ' + toDelete?.last_name"></span> ?
                </p>
                <p class="text-xs text-slate-500 mt-2">Cette action est irr√©versible.</p>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button
                        @click="confirming=false"
                        class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
                    Annuler
                </button>
                <button
                        @click="doDelete()"
                        class="px-4 py-2 rounded-full bg-rose-600 text-white text-xs font-semibold hover:bg-rose-700">
                    Supprimer
                </button>
            </div>
        </div>
    </div>

    <!-- Modals batch -->
    <div x-show="showBatchDept" x-cloak
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h4 class="text-base font-semibold text-slate-900">Changer de d√©partement</h4>
                <button @click="showBatchDept=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <select x-model="batchDepartmentId"
                        class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
                    <option value="">S√©lectionner‚Ä¶</option>
                    <template x-for="d in departments" :key="d.id">
                        <option :value="d.id" x-text="d.name"></option>
                    </template>
                </select>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button
                        @click="showBatchDept=false"
                        class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
                    Annuler
                </button>
                <button
                        @click="batch('change_department')"
                        :disabled="!batchDepartmentId"
                        class="px-4 py-2 rounded-full bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800">
                    Appliquer
                </button>
            </div>
        </div>
    </div>

    <div x-show="showTerminate" x-cloak
         class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                <h4 class="text-base font-semibold text-slate-900">Terminer les contrats</h4>
                <button @click="showTerminate=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <label class="text-xs font-medium text-slate-500 mb-1 block">Motif (optionnel)</label>
                <input
                        type="text"
                        x-model="terminateReason"
                        class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
            <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button
                        @click="showTerminate=false"
                        class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
                    Annuler
                </button>
                <button
                        @click="batch('terminate')"
                        class="px-4 py-2 rounded-full bg-rose-600 text-white text-xs font-semibold hover:bg-rose-700">
                    Terminer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    /* JS d‚Äôorigine conserv√© (juste r√©-indenter) */
    function employeeView() {
        return {
            // state
            employees: [],
            loading: false,
            page: 1,
            pageSize: 10,
            total: 0,
            maxPage: 1,
            ordering: 'last_name',
            search: '',
            filters: {department: '', contract_type: '', is_active: ''},
            selectedIds: [],
            get allChecked() {
                return this.selectedIds.length && this.selectedIds.length === this.employees.length;
            },

            resetFilters() {
                this.search = '';
                this.filters = {department: '', contract_type: '', is_active: ''};
                this.page = 1;
                this.ordering = 'last_name';
                this.pageSize = 10;
                this.fetchEmployees();
            },

            // refs
            departments: [],
            positions: [],
            counts: {total: 0, active: 0, inactive: 0},

            // modals/forms
            showForm: false,
            editId: null,
            submitting: false,
            form: {
                matricule: '', email: '', first_name: '', last_name: '',
                hire_date: new Date().toISOString().slice(0, 10),
                contract_type: 'CDI', department: '', position: '', is_active: true
            },

            confirming: false,
            toDelete: null,
            showImport: false,
            importFile: null,
            importUpdateExisting: true,
            showExport: false,
            exportFormat: 'xlsx',
            exportFields: ['matricule', 'first_name', 'last_name', 'email', 'department', 'position', 'hire_date', 'contract_type', 'is_active'],
            exportFieldsAll: [
                {label: 'Matricule', value: 'matricule'},
                {label: 'Pr√©nom', value: 'first_name'},
                {label: 'Nom', value: 'last_name'},
                {label: 'Email', value: 'email'},
                {label: 'D√©partement', value: 'department'},
                {label: 'Poste', value: 'position'},
                {label: 'Date embauche', value: 'hire_date'},
                {label: 'Contrat', value: 'contract_type'},
                {label: 'Actif', value: 'is_active'},
            ],
            exportFilters: {department: '', contract_type: '', is_active: ''},

            showBatchDept: false,
            batchDepartmentId: '',
            showTerminate: false,
            terminateReason: '',

            // API helper
            async apiCall(path, options = {}, expectBlob = false) {
                const headers = {'X-Tenant-Id': Conf.tenantId};
                // CSRF pour les requ√™tes non-GET / non-HEAD
                const method = (options.method || 'GET').toUpperCase();
                if (!['GET', 'HEAD', 'OPTIONS'].includes(method)) {
                    const csrftoken = getCookie('csrftoken');
                    if (csrftoken) {
                        headers['X-CSRFToken'] = csrftoken;   // üëà important
                    }
                }
                if (!(options.body instanceof FormData)) {
                    headers['Content-Type'] = 'application/json';
                }
                if (Conf.token) headers['Authorization'] = `Bearer ${Conf.token}`;

                const url = `${Conf.apiBase}${path.startsWith('/') ? '' : '/'}${path}`;
                const res = await fetch(url, {...options, headers});

                if (!res.ok) {
                    let detail = '';
                    try {
                        const j = await res.json();
                        if (typeof j === 'string') {
                            detail = j;
                        } else if (j.detail) {
                            detail = j.detail;
                        } else {
                            // on garde tout le payload (erreurs de champs DRF)
                            detail = JSON.stringify(j);
                        }
                    } catch {
                        // rien, on garde detail=''
                    }
                    throw new Error(`${res.status} ${res.statusText}${detail ? ' - ' + detail : ''}`);
                }

                if (expectBlob) return res.blob();
                return res.status === 204 ? null : res.json();
            },

            // load
            async fetchRefs() {
                try {
                    const d = await this.apiCall('/departments/');
                    this.departments = d.results || d;
                } catch {
                }
                try {
                    const p = await this.apiCall('/positions/');
                    this.positions = p.results || p;
                } catch {
                }
            },

            async fetchEmployees() {
                this.loading = true;
                try {
                    const params = new URLSearchParams();
                    params.set('page', this.page);
                    params.set('page_size', this.pageSize);
                    params.set('ordering', this.ordering);

                    if (this.search) params.set('search', this.search);
                    if (this.filters.department) params.set('department', this.filters.department);
                    if (this.filters.contract_type) params.set('contract_type', this.filters.contract_type);
                    if (this.filters.is_active !== '') {
                        // on force un bool pour DRF (true/false)
                        const boolVal = this.filters.is_active === 'true';
                        params.set('is_active', boolVal);
                    }

                    const data = await this.apiCall(`/employees/?${params.toString()}`);
                    const list = data.results || data;

                    this.employees = list;
                    this.total = data.count ?? (Array.isArray(list) ? list.length : 0);
                    this.maxPage = data.count
                        ? Math.max(1, Math.ceil(data.count / this.pageSize))
                        : 1;

                    // counts sur la page courante
                    let active = 0, inactive = 0;
                    for (const e of list) {
                        if (e.is_active) active++;
                        else inactive++;
                    }
                    this.counts = {total: this.total, active, inactive};

                    // on garde seulement les IDs encore visibles
                    this.selectedIds = this.selectedIds.filter(
                        id => this.employees.find(e => e.id === id)
                    );
                } catch (e) {
                    console.error(e);
                    this.toast('Chargement des employ√©s impossible', 'error');
                } finally {
                    this.loading = false;
                }
            },

            // pagination
            paginationText() {
                if (!this.total) return '‚Äî';
                const start = (this.page - 1) * this.pageSize + 1;
                const end = Math.min(this.page * this.pageSize, this.total);
                return `R√©sultats ${start}‚Äì${end} sur ${this.total}`;
            },
            nextPage() {
                if (this.page < this.maxPage) {
                    this.page++;
                    this.fetchEmployees();
                }
            },
            prevPage() {
                if (this.page > 1) {
                    this.page--;
                    this.fetchEmployees();
                }
            },

            // selection
            toggleAll(ev) {
                this.selectedIds = ev.target.checked ? this.employees.map(e => e.id) : [];
            },
            toggleOne(id, ev) {
                if (ev.target.checked) {
                    if (!this.selectedIds.includes(id)) this.selectedIds.push(id);
                } else {
                    this.selectedIds = this.selectedIds.filter(x => x !== id);
                }
            },

            // CRUD simple
            openCreate() {
                this.editId = null;
                this.form = {
                    matricule: '', email: '', first_name: '', last_name: '',
                    hire_date: new Date().toISOString().slice(0, 10),
                    contract_type: 'CDI', department: '', position: '', is_active: true
                };
                this.showForm = true;
            },
            openEdit(emp) {
                this.editId = emp.id;
                this.form = {
                    matricule: emp.matricule || '',
                    email: emp.email || '',
                    first_name: emp.first_name || '',
                    last_name: emp.last_name || '',
                    hire_date: (emp.hire_date || '').slice(0, 10),
                    contract_type: emp.contract_type || 'CDI',
                    department: emp.department || emp.department_id || emp.department?.id || '',
                    position: emp.position || emp.position_id || emp.position?.id || '',
                    is_active: !!emp.is_active
                };
                this.showForm = true;
            },
            closeForm() {
                this.showForm = false;
                this.editId = null;
            },

            async submitForm() {
                this.submitting = true;
                try {
                    const payload = {...this.form};
                    if (this.editId) {
                        await this.apiCall(`/employees/${this.editId}/`, {
                            method: 'PATCH',
                            body: JSON.stringify(payload),
                        });
                        this.toast('Employ√© mis √† jour avec succ√®s', 'success');
                    } else {
                        await this.apiCall('/employees/', {
                            method: 'POST',
                            body: JSON.stringify(payload),
                        });
                        this.toast('Employ√© cr√©√© avec succ√®s', 'success');
                    }
                    this.showForm = false;
                    this.fetchEmployees();
                } catch (e) {
                    console.error('Erreur submit employ√©:', e);
                    const msg = e && e.message ? e.message : 'Enregistrement impossible';
                    this.toast(msg, 'error');
                } finally {
                    this.submitting = false;
                }
            },

            confirmDelete(emp) {
                this.toDelete = emp;
                this.confirming = true;
            },
            async doDelete() {
                try {
                    await this.apiCall(`/employees/${this.toDelete.id}/`, {method: 'DELETE'});
                    this.toast('Employ√© supprim√©', 'success');
                    this.confirming = false;
                    this.toDelete = null;
                    this.fetchEmployees();
                } catch {
                    this.toast('Suppression impossible', 'error');
                }
            },

            // toggle actif
            async toggleActive(emp) {
                try {
                    const newVal = !emp.is_active;
                    await this.apiCall(`/employees/${emp.id}/`, {
                        method: 'PATCH',
                        body: JSON.stringify({is_active: newVal})
                    });
                    emp.is_active = newVal;
                    this.toast(newVal ? 'Employ√© activ√©' : 'Employ√© d√©sactiv√©', 'success');
                } catch {
                    this.toast('Action impossible', 'error');
                }
            },

            // batch
            async batch(action) {
                if (!this.selectedIds.length) return;
                try {
                    let data = {employee_ids: this.selectedIds, action};
                    if (action === 'change_department') data.data = {department_id: this.batchDepartmentId};
                    if (action === 'terminate') data.data = {reason: this.terminateReason || ''};

                    await this.apiCall('/bulk/bulk_employee_action/', {method: 'POST', body: JSON.stringify(data)});
                    this.toast('Action batch appliqu√©e', 'success');
                    this.showBatchDept = false;
                    this.showTerminate = false;
                    this.selectedIds = [];
                    this.fetchEmployees();
                } catch {
                    this.toast('Action batch impossible', 'error');
                }
            },
            openBatchDepartment() {
                this.showBatchDept = true;
            },
            openTerminate() {
                this.showTerminate = true;
            },

            // import
            openImport() {
                this.showImport = true;
                this.importFile = null;
            },
            handleFile(e) {
                this.importFile = e.target.files?.[0] || null;
            },
            async doImport() {
                if (!this.importFile) return;
                try {
                    const form = new FormData();
                    form.append('file', this.importFile);
                    form.append('update_existing', String(this.importUpdateExisting));
                    await this.apiCall('/employees/import_employees/', {method: 'POST', body: form});
                    this.toast('Import termin√©', 'success');
                    this.showImport = false;
                    this.fetchEmployees();
                } catch {
                    this.toast('Import impossible', 'error');
                }
            },

            // export
            openExport() {
                // on pr√©-remplit l'export avec les filtres d√©j√† appliqu√©s
                this.exportFilters = {
                    department: this.filters.department || '',
                    contract_type: this.filters.contract_type || '',
                    is_active: this.filters.is_active || '',
                };
                this.showExport = true;
            },
            async doExport() {
                try {
                    const body = {
                        format: this.exportFormat,
                        fields: this.exportFields,
                        filters: {
                            ...(this.exportFilters.department ? {department: this.exportFilters.department} : {}),
                            ...(this.exportFilters.contract_type ? {contract_type: this.exportFilters.contract_type} : {}),
                            ...(this.exportFilters.is_active ? {is_active: this.exportFilters.is_active} : {})
                        }
                    };
                    const blob = await this.apiCall('/employees/export_employees/', {
                        method: 'POST',
                        body: JSON.stringify(body)
                    }, true);
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const ext = this.exportFormat === 'xlsx' ? 'xlsx' : 'csv';
                    a.href = url;
                    a.download = `employees_export.${ext}`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                    this.toast('Export g√©n√©r√©', 'success');
                    this.showExport = false;
                } catch {
                    this.toast('Export impossible', 'error');
                }
            },

            // utils
            formatDate(d) {
                if (!d) return '';
                return new Date(d).toLocaleDateString('fr-FR');
            },
            toast(msg, type = 'info') {
                if (window.hrToast) {
                    window.hrToast(msg, type);
                } else {
                    console.log(`[${type}]`, msg);
                    alert(msg);
                }
            },

            // init
            async init() {
                await this.fetchRefs();
                await this.fetchEmployees();
            }
        };
    }
</script>

<style>
    .skeleton {
        background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
        background-size: 200% 100%;
        animation: loading 1.3s infinite;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0
        }
        100% {
            background-position: -200% 0
        }
    }
</style>