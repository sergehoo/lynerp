<!-- Lyneerp/hr/templates/hr/partials/contracts.html -->
<div class="space-y-8" x-data="contractView()" x-init="init()">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-slate-900 text-white text-xs font-medium mb-2">
        <i class="fas fa-file-signature text-[11px]"></i>
        <span>Ressources humaines • Contrats</span>
      </div>
      <h3 class="text-2xl font-semibold text-slate-900 tracking-tight">Gestion des contrats</h3>
      <p class="text-sm text-slate-500 mt-1">
        Créez, suivez, approuvez, signez et résiliez les contrats. Alertes intégrées (fin, renouvellement, période d’essai).
      </p>
    </div>

    <div class="flex flex-wrap gap-2">
      <button @click="openExport()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-emerald-200 bg-emerald-50 text-sm font-medium text-emerald-700 hover:bg-emerald-100">
        <i class="fas fa-download text-[13px]"></i>
        <span>Exporter</span>
      </button>

      <button @click="openCreate()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-900 text-white text-sm font-semibold shadow-sm shadow-slate-400/40 hover:bg-slate-800">
        <i class="fas fa-plus text-[13px]"></i>
        <span>Nouveau contrat</span>
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center shadow-md shadow-slate-300/70">
        <i class="fas fa-file-contract text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Total (tous)</div>
        <div class="mt-1 text-2xl font-semibold text-slate-900 tracking-tight" x-text="total"></div>
        <div class="text-[11px] text-slate-400">Selon filtres + pagination</div>
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
        <i class="fas fa-badge-check text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Actifs (page)</div>
        <div class="mt-1 text-2xl font-semibold text-emerald-600 tracking-tight" x-text="counts.active"></div>
        <div class="text-[11px] text-slate-400">Contrats visibles</div>
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-amber-50 text-amber-700 flex items-center justify-center">
        <i class="fas fa-arrows-rotate text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">À renouveler (page)</div>
        <div class="mt-1 text-2xl font-semibold text-amber-700 tracking-tight" x-text="counts.renewable"></div>
        <div class="text-[11px] text-slate-400">≤ 30 jours restants</div>
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-rose-50 text-rose-700 flex items-center justify-center">
        <i class="fas fa-hourglass-end text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Expire bientôt (page)</div>
        <div class="mt-1 text-2xl font-semibold text-rose-700 tracking-tight" x-text="counts.expiring"></div>
        <div class="text-[11px] text-slate-400">≤ 60 jours restants</div>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="bg-white border border-gray-100 rounded-3xl shadow-sm p-5">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
      <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">
        <!-- search -->
        <div class="relative lg:col-span-2">
          <input
            type="text"
            placeholder="Rechercher (n° contrat, poste, employé)…"
            class="w-full pl-10 pr-3 py-2.5 rounded-full border border-gray-200 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
            x-model="search"
            @input.debounce.400ms="page=1; fetchContracts()">
          <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
        </div>

        <!-- employee -->
        <div class="lg:col-span-2">
          <select
            x-model="filters.employee"
            @change="page=1; fetchContracts()"
            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="">Tous les employés</option>
            <template x-for="e in employees" :key="e.id">
              <option :value="String(e.id)" x-text="`${e.first_name || ''} ${e.last_name || ''}`.trim()"></option>
            </template>
          </select>
        </div>

        <!-- contract type -->
        <div>
          <select
            x-model="filters.contract_type"
            @change="page=1; fetchContracts()"
            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="">Tous types</option>
            <template x-for="ct in contractTypes" :key="ct.id">
              <option :value="String(ct.id)" x-text="`${ct.name} (${ct.code})`"></option>
            </template>
          </select>
        </div>

        <!-- status -->
        <div>
          <select
            x-model="filters.status"
            @change="page=1; fetchContracts()"
            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="">Tous statuts</option>
            <option value="DRAFT">Brouillon</option>
            <option value="PENDING_APPROVAL">Attente approbation</option>
            <option value="ACTIVE">Actif</option>
            <option value="SUSPENDED">Suspendu</option>
            <option value="TERMINATED">Résilié</option>
            <option value="EXPIRED">Expiré</option>
            <option value="RENEWED">Renouvelé</option>
          </select>
        </div>

        <!-- date range -->
        <div>
          <input type="date"
                 x-model="filters.start_after"
                 @change="page=1; fetchContracts()"
                 class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
                 title="Début après">
        </div>
        <div>
          <input type="date"
                 x-model="filters.start_before"
                 @change="page=1; fetchContracts()"
                 class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
                 title="Début avant">
        </div>
      </div>

      <!-- tri + page size + reset -->
      <div class="flex items-center gap-3 justify-end">
        <button
          type="button"
          @click="resetFilters()"
          class="px-3 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50 inline-flex items-center gap-1.5">
          <i class="fas fa-rotate-left text-[11px]"></i>
          <span>Réinitialiser</span>
        </button>

        <select
          x-model="ordering"
          @change="page=1; fetchContracts()"
          class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          <option value="-start_date">Début récents</option>
          <option value="start_date">Début anciens</option>
          <option value="contract_number">N° (A→Z)</option>
          <option value="-contract_number">N° (Z→A)</option>
          <option value="-created_at">Créés récents</option>
          <option value="created_at">Créés anciens</option>
        </select>

        <select
          x-model.number="pageSize"
          @change="page=1; fetchContracts()"
          class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          <option>10</option>
          <option>20</option>
          <option>50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Actions batch -->
  <div class="flex flex-wrap items-center gap-2" x-show="selectedIds.length" x-cloak>
    <div class="text-xs text-slate-500 bg-slate-50 border border-slate-100 px-3 py-1.5 rounded-full">
      <span class="font-semibold text-slate-900" x-text="selectedIds.length"></span>
      <span class="ml-1">sélectionné(s)</span>
    </div>

    <button
      @click="batchOpen('submit')"
      class="px-3 py-1.5 rounded-full bg-slate-50 text-slate-700 hover:bg-slate-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-paper-plane text-[11px]"></i> Soumettre
    </button>

    <button
      @click="batchOpen('approve')"
      class="px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-check text-[11px]"></i> Approuver
    </button>

    <button
      @click="batchOpen('sign')"
      class="px-3 py-1.5 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-pen-fancy text-[11px]"></i> Marquer signé
    </button>

    <button
      @click="openTerminate()"
      class="px-3 py-1.5 rounded-full bg-rose-50 text-rose-700 hover:bg-rose-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-ban text-[11px]"></i> Résilier
    </button>
  </div>

  <!-- Tableau -->
  <div class="bg-white border border-gray-100 rounded-3xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-gray-50 text-xs font-semibold text-slate-400 uppercase">
          <tr>
            <th class="px-4 py-3">
              <input type="checkbox" @change="toggleAll($event)" :checked="allChecked" class="rounded border-slate-300">
            </th>
            <th class="px-6 py-3 text-left">Contrat</th>
            <th class="px-6 py-3 text-left">Employé</th>
            <th class="px-6 py-3 text-left">Département</th>
            <th class="px-6 py-3 text-left">Poste</th>
            <th class="px-6 py-3 text-left">Type</th>
            <th class="px-6 py-3 text-left">Période</th>
            <th class="px-6 py-3 text-left">Rémunération</th>
            <th class="px-6 py-3 text-left">Statut</th>
            <th class="px-6 py-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-100">
          <!-- skeleton -->
          <template x-if="loading">
            <template x-for="i in 6" :key="i">
              <tr>
                <td class="px-4 py-4"><div class="h-4 w-4 skeleton rounded-full"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-44 skeleton rounded"></div><div class="h-3 w-28 mt-2 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-40 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-28 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-28 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-24 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-40 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-20 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-6 w-28 skeleton rounded-full"></div></td>
                <td class="px-6 py-4"><div class="h-8 w-24 ml-auto skeleton rounded-full"></div></td>
              </tr>
            </template>
          </template>

          <!-- rows -->
          <template x-for="c in contracts" :key="c.id">
            <tr class="hover:bg-gray-50/70 transition-colors">
              <td class="px-4 py-4">
                <input type="checkbox"
                       :value="c.id"
                       @change="toggleOne(c.id, $event)"
                       :checked="selectedIds.includes(c.id)"
                       class="rounded border-slate-300">
              </td>

              <td class="px-6 py-4" data-url-template="{% url 'contract_detail' pk=0 %}">
                <a
                  :href="$el.closest('td').dataset.urlTemplate.replace('0', String(c.id))"
                  class="block rounded-2xl p-3 bg-slate-50 hover:bg-slate-100 transition group"
                  :title="`${c.contract_number || ''} ${c.title || ''}`.trim()"
                >
                  <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs font-semibold group-hover:bg-slate-700 transition">
                      <i class="fas fa-file-signature"></i>
                    </div>
                    <div>
                      <div class="font-semibold text-slate-900" x-text="c.contract_number || '—'"></div>
                      <div class="text-[11px] text-slate-400" x-text="c.title || '—'"></div>
                    </div>
                  </div>
                </a>
              </td>

              <td class="px-6 py-4">
                <div class="font-medium text-slate-900" x-text="c.employee_display || (c.employee_name || '—')"></div>
                <div class="text-xs text-slate-500" x-text="c.employee_email || ''"></div>
              </td>

              <td class="px-6 py-4 text-sm text-slate-700" x-text="c.department_display || c.department_name || '—'"></td>
              <td class="px-6 py-4 text-sm text-slate-700" x-text="c.position_display || c.position_title || '—'"></td>

              <td class="px-6 py-4">
                <div class="text-sm font-medium text-slate-900" x-text="c.contract_type_display || '—'"></div>
                <div class="text-[11px] text-slate-400" x-text="c.salary_frequency_label || c.salary_frequency || ''"></div>
              </td>

              <td class="px-6 py-4">
                <div class="text-sm text-slate-700">
                  <span x-text="formatDate(c.start_date)"></span>
                  <span class="text-slate-300">→</span>
                  <span x-text="c.end_date ? formatDate(c.end_date) : '—'"></span>
                </div>
                <div class="text-[11px] text-slate-400">
                  <template x-if="c.days_until_end !== null && c.days_until_end !== undefined">
                    <span x-text="`J-${c.days_until_end}`"></span>
                  </template>
                  <template x-if="c.days_until_end === null || c.days_until_end === undefined">
                    <span x-text="c.contract_type_is_permanent ? 'CDI' : ''"></span>
                  </template>
                  <template x-if="c.is_probation_period">
                    <span class="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 font-semibold">
                      <i class="fas fa-flask text-[10px]"></i> Essai
                    </span>
                  </template>
                </div>
              </td>

              <td class="px-6 py-4">
                <div class="font-semibold text-slate-900" x-text="money(c.base_salary, c.salary_currency)"></div>
                <div class="text-[11px] text-slate-400" x-text="`${c.weekly_hours ?? ''}h/sem`"></div>
              </td>

              <td class="px-6 py-4">
                <span class="px-2.5 py-1 rounded-full text-[11px] font-semibold inline-flex items-center gap-1.5"
                      :class="statusPill(c.status).cls">
                  <i :class="statusPill(c.status).ico"></i>
                  <span x-text="statusPill(c.status).label"></span>
                </span>
              </td>

              <td class="px-6 py-4">
                <div class="flex justify-end gap-2">
                  <button
                    @click="openEdit(c)"
                    class="px-3 py-1.5 text-xs rounded-full bg-slate-900 text-white hover:bg-slate-800 inline-flex items-center gap-1.5"
                    title="Modifier">
                    <i class="fas fa-edit text-[11px]"></i>
                  </button>

                  <button
                    @click="openActions(c)"
                    class="px-3 py-1.5 text-xs rounded-full bg-white border border-gray-200 text-slate-700 hover:bg-gray-50 inline-flex items-center gap-1.5"
                    title="Actions">
                    <i class="fas fa-ellipsis text-[11px]"></i>
                  </button>
                </div>
              </td>
            </tr>
          </template>

          <!-- empty -->
          <tr x-show="!loading && contracts.length===0">
            <td colspan="10" class="py-16 text-center">
              <div class="inline-flex flex-col items-center justify-center px-6 py-5 rounded-3xl border border-dashed border-gray-300 bg-gray-50/60">
                <i class="fas fa-file-contract text-gray-300 text-4xl mb-2"></i>
                <div class="text-sm font-medium text-slate-900">Aucun contrat</div>
                <div class="text-xs text-slate-500 mb-3">Créez un contrat pour commencer le suivi.</div>
                <button @click="openCreate()"
                        class="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-semibold hover:bg-slate-800">
                  <i class="fas fa-plus text-[11px]"></i>
                  <span>Créer un contrat</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-3 px-4 py-3 border-t border-gray-100 bg-gray-50/80">
      <div class="text-xs text-slate-500" x-text="paginationText()"></div>
      <div class="flex gap-2">
        <button @click="prevPage()" :disabled="page<=1"
                class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-medium text-slate-700 bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
          <i class="fas fa-chevron-left text-[10px]"></i>
          <span>Précédent</span>
        </button>
        <button @click="nextPage()" :disabled="page>=maxPage"
                class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-medium text-slate-700 bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
          <span>Suivant</span>
          <i class="fas fa-chevron-right text-[10px]"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Modals ... (inchangés, je les laisse tels que tu les as) -->
  <!-- ✅ Garde tes modals Create/Edit, Actions, Terminate, Export comme dans ton code -->
</div>

<script>
/**
 * Helpers (fallback si ce partial est rendu seul)
 */
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? decodeURIComponent(match[2]) : null;
}
function normalizeApiBase(val) {
  if (!val) return '/api/rh';
  let v = String(val).trim();
  if (/^https?:\/\//i.test(v) && !/\/api\/rh\/?$/i.test(v)) v = v.replace(/\/+$/, '') + '/api/rh';
  return v.replace(/\/+$/, '');
}
function buildUrl(apiBase, path) {
  if (/^https?:\/\//i.test(path)) return path;
  if (path.startsWith('/')) return apiBase.replace(/\/+$/, '') + path;
  return apiBase.replace(/\/+$/, '') + '/' + path;
}
function deriveTenantFromHost(host) {
  const h = (host || location.hostname).toLowerCase();
  const m = h.match(/^([a-z0-9-]+)\.(?:rh\.)?lyneerp\.com$/i);
  if (m) return m[1];
  const parts = h.split('.');
  if (parts.length >= 3) return parts[0];
  return '';
}
function getStoredAccessToken() {
  return localStorage.getItem('lyneerp_token')
    || sessionStorage.getItem('lyneerp_token')
    || localStorage.getItem('kc_access_token')
    || sessionStorage.getItem('kc_access_token')
    || '';
}

function contractView() {
  return {
    // state
    contracts: [],
    contractTypes: [],
    employees: [],
    departments: [],
    positions: [],

    loading: false,
    page: 1,
    pageSize: 10,
    total: 0,
    maxPage: 1,
    ordering: '-start_date',
    search: '',
    filters: { employee:'', contract_type:'', status:'', start_after:'', start_before:'' },

    selectedIds: [],
    get allChecked() {
      return this.contracts.length > 0 && this.selectedIds.length === this.contracts.length;
    },

    counts: { active: 0, renewable: 0, expiring: 0 },

    // modals
    showForm: false,
    editId: null,
    submitting: false,
    form: {
      employee: '',
      contract_type: '',
      title: '',
      department: '',
      position: '',
      start_date: new Date().toISOString().slice(0, 10),
      end_date: '',
      base_salary: 0,
      salary_currency: 'XOF',
      salary_frequency: 'MONTHLY',
      weekly_hours: 40,
      work_location: '',
      remote_allowed: false,
      remote_days_per_week: 0,
      probation_start_date: '',
      probation_duration_days: 90,
      probation_end_date: '',
      status: 'DRAFT'
    },

    showActions: false,
    activeContract: null,

    showTerminate: false,
    terminateTargets: [],
    terminateForm: {
      termination_type: 'OTHER',
      termination_date: new Date().toISOString().slice(0, 10),
      termination_reason: ''
    },

    showExport: false,
    exportFormat: 'xlsx',
    exportFields: [
      'contract_number','employee','contract_type','title','department','position',
      'start_date','end_date','base_salary','salary_currency','status'
    ],
    exportFieldsAll: [
      {label:'N° contrat', value:'contract_number'},
      {label:'Employé', value:'employee'},
      {label:'Type', value:'contract_type'},
      {label:'Poste', value:'title'},
      {label:'Département', value:'department'},
      {label:'Position', value:'position'},
      {label:'Début', value:'start_date'},
      {label:'Fin', value:'end_date'},
      {label:'Salaire', value:'base_salary'},
      {label:'Devise', value:'salary_currency'},
      {label:'Statut', value:'status'},
    ],
    exportFilters: { status:'', contract_type:'', employee:'' },

    // resolved conf (local fallback)
    _apiBase: null,
    _tenantId: null,
    _token: null,

    resolveConf() {
      // si Conf global existe, l’utiliser, sinon fallback localStorage
      const apiFromGlobal = (window.Conf && window.Conf.apiBase) ? window.Conf.apiBase : null;
      const tenantFromGlobal = (window.Conf && window.Conf.tenantId) ? window.Conf.tenantId : null;
      const tokenFromGlobal = (window.Conf && window.Conf.token) ? window.Conf.token : null;

      this._apiBase = normalizeApiBase(apiFromGlobal || localStorage.getItem('lyneerp_api') || '/api/rh');
      this._tenantId = tenantFromGlobal || localStorage.getItem('lyneerp_tenant') || deriveTenantFromHost(location.hostname) || 'demo';
      this._token = tokenFromGlobal || getStoredAccessToken() || '';
    },

    async apiCall(path, options = {}, expectBlob = false) {
      if (!this._apiBase) this.resolveConf();

      const headers = { 'X-Tenant-Id': this._tenantId };
      const method = (options.method || 'GET').toUpperCase();

      if (!['GET','HEAD','OPTIONS'].includes(method)) {
        const csrftoken = getCookie('csrftoken');
        if (csrftoken) headers['X-CSRFToken'] = csrftoken;
      }

      if (!(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
      if (this._token) headers['Authorization'] = `Bearer ${this._token}`;

      const url = buildUrl(this._apiBase, path);
      const res = await fetch(url, { ...options, headers });

      if (!res.ok) {
        let detail = '';
        try {
          const j = await res.json();
          detail = j.detail ? j.detail : JSON.stringify(j);
        } catch {}
        throw new Error(`${res.status} ${res.statusText}${detail ? ' - ' + detail : ''}`);
      }

      if (expectBlob) return res.blob();
      return res.status === 204 ? null : res.json();
    },

    toast(msg, type='info') {
      if (window.hrToast) window.hrToast(msg, type);
      else { console.log(`[${type}]`, msg); alert(msg); }
    },

    async fetchRefs() {
      try { const ct = await this.apiCall('/contract-types/'); this.contractTypes = ct.results || ct; } catch {}
      try { const e = await this.apiCall('/employees/?page_size=200'); this.employees = e.results || e; } catch {}
      try { const d = await this.apiCall('/departments/'); this.departments = d.results || d; } catch {}
      try { const p = await this.apiCall('/positions/'); this.positions = p.results || p; } catch {}
    },

    async fetchContracts() {
      this.loading = true;
      try {
        const params = new URLSearchParams();
        params.set('page', String(this.page));
        params.set('page_size', String(this.pageSize));
        params.set('ordering', this.ordering);

        if (this.search) params.set('search', this.search);
        if (this.filters.employee) params.set('employee', this.filters.employee);
        if (this.filters.contract_type) params.set('contract_type', this.filters.contract_type);
        if (this.filters.status) params.set('status', this.filters.status);
        if (this.filters.start_after) params.set('start_date__gte', this.filters.start_after);
        if (this.filters.start_before) params.set('start_date__lte', this.filters.start_before);

        const data = await this.apiCall(`/employment-contracts/?${params.toString()}`);
        const list = data.results || data || [];

        this.contracts = Array.isArray(list) ? list : [];
        this.total = (data && typeof data.count === 'number') ? data.count : this.contracts.length;
        this.maxPage = this.total ? Math.max(1, Math.ceil(this.total / this.pageSize)) : 1;

        let active = 0, renewable = 0, expiring = 0;
        for (const c of this.contracts) {
          if (c.is_active) active++;
          if (c.can_be_renewed) renewable++;
          if (c.requires_renewal) expiring++;
        }
        this.counts = { active, renewable, expiring };

        // keep only visible selected
        const visibleIds = new Set(this.contracts.map(x => x.id));
        this.selectedIds = this.selectedIds.filter(id => visibleIds.has(id));
      } catch (e) {
        console.error(e);
        this.toast(e.message || "Chargement des contrats impossible", "error");
      } finally {
        this.loading = false;
      }
    },

    paginationText() {
      if (!this.total) return '—';
      const start = (this.page - 1) * this.pageSize + 1;
      const end = Math.min(this.page * this.pageSize, this.total);
      return `Résultats ${start}–${end} sur ${this.total}`;
    },
    nextPage() { if (this.page < this.maxPage) { this.page++; this.fetchContracts(); } },
    prevPage() { if (this.page > 1) { this.page--; this.fetchContracts(); } },

    toggleAll(ev) {
      this.selectedIds = ev.target.checked ? this.contracts.map(c => c.id) : [];
    },
    toggleOne(id, ev) {
      if (ev.target.checked) {
        if (!this.selectedIds.includes(id)) this.selectedIds.push(id);
      } else {
        this.selectedIds = this.selectedIds.filter(x => x !== id);
      }
    },

    resetFilters() {
      this.search = '';
      this.filters = { employee:'', contract_type:'', status:'', start_after:'', start_before:'' };
      this.page = 1;
      this.pageSize = 10;
      this.ordering = '-start_date';
      this.selectedIds = [];
      this.fetchContracts();
    },

    statusPill(st) {
      const map = {
        DRAFT: {label:'Brouillon', cls:'bg-slate-100 text-slate-700', ico:'fas fa-pen text-[11px]'},
        PENDING_APPROVAL: {label:'À approuver', cls:'bg-amber-50 text-amber-700', ico:'fas fa-hourglass-half text-[11px]'},
        ACTIVE: {label:'Actif', cls:'bg-emerald-50 text-emerald-700', ico:'fas fa-badge-check text-[11px]'},
        SUSPENDED: {label:'Suspendu', cls:'bg-indigo-50 text-indigo-700', ico:'fas fa-pause text-[11px]'},
        TERMINATED: {label:'Résilié', cls:'bg-rose-50 text-rose-700', ico:'fas fa-ban text-[11px]'},
        EXPIRED: {label:'Expiré', cls:'bg-gray-100 text-gray-700', ico:'fas fa-hourglass-end text-[11px]'},
        RENEWED: {label:'Renouvelé', cls:'bg-sky-50 text-sky-700', ico:'fas fa-rotate text-[11px]'},
      };
      return map[st] || {label: st || '—', cls:'bg-gray-100 text-gray-700', ico:'fas fa-circle text-[10px]'};
    },

    formatDate(d) { return (!d) ? '—' : new Date(d).toLocaleDateString('fr-FR'); },
    money(v, cur='XOF') {
      if (v === null || v === undefined || v === '') return '—';
      try {
        return new Intl.NumberFormat('fr-FR', { style:'currency', currency: cur || 'XOF', maximumFractionDigits: 0 }).format(Number(v));
      } catch {
        return `${v} ${cur || ''}`.trim();
      }
    },

    openCreate() {
      this.editId = null;
      this.form = {
        employee: '', contract_type: '', title: '', department: '', position: '',
        start_date: new Date().toISOString().slice(0, 10), end_date: '',
        base_salary: 0, salary_currency: 'XOF', salary_frequency: 'MONTHLY',
        weekly_hours: 40, work_location: '', remote_allowed: false, remote_days_per_week: 0,
        probation_start_date: '', probation_duration_days: 90, probation_end_date: '',
        status: 'DRAFT'
      };
      this.showForm = true;
    },
    openEdit(c) {
      this.editId = c.id;
      this.form = {
        employee: c.employee ?? c.employee_id ?? '',
        contract_type: c.contract_type ?? c.contract_type_id ?? '',
        title: c.title || '',
        department: c.department ?? c.department_id ?? '',
        position: c.position ?? c.position_id ?? '',
        start_date: (c.start_date || '').slice(0,10),
        end_date: c.end_date ? String(c.end_date).slice(0,10) : '',
        base_salary: Number(c.base_salary || 0),
        salary_currency: c.salary_currency || 'XOF',
        salary_frequency: c.salary_frequency || 'MONTHLY',
        weekly_hours: Number(c.weekly_hours ?? 40),
        work_location: c.work_location || '',
        remote_allowed: !!c.remote_allowed,
        remote_days_per_week: Number(c.remote_days_per_week ?? 0),
        probation_start_date: c.probation_start_date ? String(c.probation_start_date).slice(0,10) : '',
        probation_duration_days: Number(c.probation_duration_days ?? 90),
        probation_end_date: c.probation_end_date ? String(c.probation_end_date).slice(0,10) : '',
        status: c.status || 'DRAFT'
      };
      this.showForm = true;
    },
    closeForm() { this.showForm = false; this.editId = null; },

    async submitForm() {
      this.submitting = true;
      try {
        const payload = { ...this.form };

        if (this.editId) {
          await this.apiCall(`/employment-contracts/${this.editId}/`, { method:'PATCH', body: JSON.stringify(payload) });
          this.toast('Contrat mis à jour', 'success');
        } else {
          await this.apiCall(`/employment-contracts/`, { method:'POST', body: JSON.stringify(payload) });
          this.toast('Contrat créé', 'success');
        }
        this.showForm = false;
        await this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast(e.message || "Enregistrement impossible", "error");
      } finally {
        this.submitting = false;
      }
    },

    openActions(c) { this.activeContract = c; this.showActions = true; },

    async doAction(action) {
      const c = this.activeContract;
      if (!c) return;
      try {
        if (action === 'submit') {
          await this.apiCall(`/employment-contracts/${c.id}/submit_for_approval/`, { method:'POST', body: '{}' });
          this.toast('Contrat soumis', 'success');
        } else if (action === 'approve') {
          await this.apiCall(`/employment-contracts/${c.id}/approve/`, { method:'POST', body: '{}' });
          this.toast('Contrat approuvé', 'success');
        } else if (action === 'sign') {
          await this.apiCall(`/employment-contracts/${c.id}/mark_signed/`, {
            method:'POST',
            body: JSON.stringify({ signed_by_employee:true, signed_by_employer:true })
          });
          this.toast('Contrat marqué signé', 'success');
        }
        this.showActions = false;
        await this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast('Action impossible : ' + (e.message || ''), 'error');
      }
    },

    openTerminate() {
      this.terminateTargets = this.selectedIds.length
        ? [...this.selectedIds]
        : (this.activeContract ? [this.activeContract.id] : []);
      this.terminateForm = {
        termination_type: 'OTHER',
        termination_date: new Date().toISOString().slice(0,10),
        termination_reason: ''
      };
      this.showActions = false;
      this.showTerminate = true;
    },
    async doTerminate() {
      try {
        if (!this.terminateTargets.length) return;
        for (const id of this.terminateTargets) {
          await this.apiCall(`/employment-contracts/${id}/terminate/`, {
            method:'POST',
            body: JSON.stringify(this.terminateForm)
          });
        }
        this.toast('Résiliation appliquée', 'success');
        this.showTerminate = false;
        this.selectedIds = [];
        await this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast('Résiliation impossible : ' + (e.message || ''), 'error');
      }
    },

    batchOpen(kind) {
      if (!this.selectedIds.length) return;
      this.activeContract = null;
      if (kind === 'submit') this.batchDo('submit');
      if (kind === 'approve') this.batchDo('approve');
      if (kind === 'sign') this.batchDo('sign');
    },
    async batchDo(kind) {
      try {
        for (const id of this.selectedIds) {
          if (kind === 'submit') await this.apiCall(`/employment-contracts/${id}/submit_for_approval/`, { method:'POST', body:'{}' });
          if (kind === 'approve') await this.apiCall(`/employment-contracts/${id}/approve/`, { method:'POST', body:'{}' });
          if (kind === 'sign') await this.apiCall(`/employment-contracts/${id}/mark_signed/`, { method:'POST', body: JSON.stringify({signed_by_employee:true, signed_by_employer:true}) });
        }
        this.toast('Action batch appliquée', 'success');
        this.selectedIds = [];
        await this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast('Action batch impossible : ' + (e.message || ''), 'error');
      }
    },

    openExport() {
      this.exportFilters = {
        status: this.filters.status || '',
        contract_type: this.filters.contract_type || '',
        employee: this.filters.employee || '',
      };
      this.showExport = true;
    },
    async doExport() {
      try {
        const body = {
          format: this.exportFormat,
          fields: this.exportFields,
          filters: {
            ...(this.exportFilters.status ? {status: this.exportFilters.status} : {}),
            ...(this.exportFilters.contract_type ? {contract_type: this.exportFilters.contract_type} : {}),
            ...(this.exportFilters.employee ? {employee: this.exportFilters.employee} : {}),
          }
        };

        const blob = await this.apiCall('/employment-contracts/export_contracts/', {
          method: 'POST',
          body: JSON.stringify(body)
        }, true);

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `contracts_export.${this.exportFormat === 'xlsx' ? 'xlsx' : 'csv'}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        this.toast('Export généré', 'success');
        this.showExport = false;
      } catch (e) {
        console.error(e);
        this.toast('Export impossible', 'error');
      }
    },

    async init() {
      this.resolveConf();
      await this.fetchRefs();
      await this.fetchContracts();
    }
  };
}
</script>

<style>
.skeleton {
  background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
  background-size: 200% 100%;
  animation: loading 1.3s infinite;
}
@keyframes loading {
  0% { background-position: 200% 0 }
  100% { background-position: -200% 0 }
}
</style>