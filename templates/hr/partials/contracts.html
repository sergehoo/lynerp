<!-- Lyneerp/hr/templates/hr/partials/contracts.html -->
<div class="space-y-8" x-data="contractView()" x-init="init()">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-slate-900 text-white text-xs font-medium mb-2">
        <i class="fas fa-file-signature text-[11px]"></i>
        <span>Ressources humaines • Contrats</span>
      </div>
      <h3 class="text-2xl font-semibold text-slate-900 tracking-tight">Gestion des contrats</h3>
      <p class="text-sm text-slate-500 mt-1">
        Créez, suivez, approuvez, signez et résiliez les contrats. Alertes intégrées (fin, renouvellement, période d’essai).
      </p>
    </div>

    <div class="flex flex-wrap gap-2">
      <button @click="openExport()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-emerald-200 bg-emerald-50 text-sm font-medium text-emerald-700 hover:bg-emerald-100">
        <i class="fas fa-download text-[13px]"></i>
        <span>Exporter</span>
      </button>

      <button @click="openCreate()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-slate-900 text-white text-sm font-semibold shadow-sm shadow-slate-400/40 hover:bg-slate-800">
        <i class="fas fa-plus text-[13px]"></i>
        <span>Nouveau contrat</span>
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-slate-900 text-white flex items-center justify-center shadow-md shadow-slate-300/70">
        <i class="fas fa-file-contract text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Total (tous)</div>
        <div class="mt-1 text-2xl font-semibold text-slate-900 tracking-tight" x-text="total"></div>
        <div class="text-[11px] text-slate-400">Selon filtres + pagination</div>
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
        <i class="fas fa-badge-check text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Actifs (page)</div>
        <div class="mt-1 text-2xl font-semibold text-emerald-600 tracking-tight" x-text="counts.active"></div>
        <div class="text-[11px] text-slate-400">Contrats visibles</div>
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-amber-50 text-amber-700 flex items-center justify-center">
        <i class="fas fa-arrows-rotate text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">À renouveler (page)</div>
        <div class="mt-1 text-2xl font-semibold text-amber-700 tracking-tight" x-text="counts.renewable"></div>
        <div class="text-[11px] text-slate-400">≤ 30 jours restants</div>
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-3xl p-5 shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-rose-50 text-rose-700 flex items-center justify-center">
        <i class="fas fa-hourglass-end text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Expire bientôt (page)</div>
        <div class="mt-1 text-2xl font-semibold text-rose-700 tracking-tight" x-text="counts.expiring"></div>
        <div class="text-[11px] text-slate-400">≤ 60 jours restants</div>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="bg-white border border-gray-100 rounded-3xl shadow-sm p-5">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
      <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">
        <!-- search -->
        <div class="relative lg:col-span-2">
          <input
            type="text"
            placeholder="Rechercher (n° contrat, poste, employé)…"
            class="w-full pl-10 pr-3 py-2.5 rounded-full border border-gray-200 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
            x-model="search"
            @input.debounce.400ms="page=1; fetchContracts()">
          <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
        </div>

        <!-- employee -->
        <div class="lg:col-span-2">
          <select
            x-model="filters.employee"
            @change="page=1; fetchContracts()"
            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="">Tous les employés</option>
            <template x-for="e in employees" :key="e.id">
              <option :value="String(e.id)" x-text="`${e.first_name || ''} ${e.last_name || ''}`.trim()"></option>
            </template>
          </select>
        </div>

        <!-- contract type -->
        <div>
          <select
            x-model="filters.contract_type"
            @change="page=1; fetchContracts()"
            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="">Tous types</option>
            <template x-for="ct in contractTypes" :key="ct.id">
              <option :value="String(ct.id)" x-text="`${ct.name} (${ct.code})`"></option>
            </template>
          </select>
        </div>

        <!-- status -->
        <div>
          <select
            x-model="filters.status"
            @change="page=1; fetchContracts()"
            class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="">Tous statuts</option>
            <option value="DRAFT">Brouillon</option>
            <option value="PENDING_APPROVAL">Attente approbation</option>
            <option value="ACTIVE">Actif</option>
            <option value="SUSPENDED">Suspendu</option>
            <option value="TERMINATED">Résilié</option>
            <option value="EXPIRED">Expiré</option>
            <option value="RENEWED">Renouvelé</option>
          </select>
        </div>

        <!-- date range -->
        <div>
          <input type="date"
                 x-model="filters.start_after"
                 @change="page=1; fetchContracts()"
                 class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
                 title="Début après">
        </div>
        <div>
          <input type="date"
                 x-model="filters.start_before"
                 @change="page=1; fetchContracts()"
                 class="w-full rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
                 title="Début avant">
        </div>
      </div>

      <!-- tri + page size + reset -->
      <div class="flex items-center gap-3 justify-end">
        <button
          type="button"
          @click="resetFilters()"
          class="px-3 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50 inline-flex items-center gap-1.5">
          <i class="fas fa-rotate-left text-[11px]"></i>
          <span>Réinitialiser</span>
        </button>

        <select
          x-model="ordering"
          @change="page=1; fetchContracts()"
          class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          <option value="-start_date">Début récents</option>
          <option value="start_date">Début anciens</option>
          <option value="contract_number">N° (A→Z)</option>
          <option value="-contract_number">N° (Z→A)</option>
          <option value="-created_at">Créés récents</option>
          <option value="created_at">Créés anciens</option>
        </select>

        <select
          x-model.number="pageSize"
          @change="page=1; fetchContracts()"
          class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          <option>10</option>
          <option>20</option>
          <option>50</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Actions batch -->
  <div class="flex flex-wrap items-center gap-2" x-show="selectedIds.length">
    <div class="text-xs text-slate-500 bg-slate-50 border border-slate-100 px-3 py-1.5 rounded-full">
      <span class="font-semibold text-slate-900" x-text="selectedIds.length"></span>
      <span class="ml-1">sélectionné(s)</span>
    </div>

    <button
      @click="batchOpen('submit')"
      class="px-3 py-1.5 rounded-full bg-slate-50 text-slate-700 hover:bg-slate-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-paper-plane text-[11px]"></i> Soumettre
    </button>

    <button
      @click="batchOpen('approve')"
      class="px-3 py-1.5 rounded-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-check text-[11px]"></i> Approuver
    </button>

    <button
      @click="batchOpen('sign')"
      class="px-3 py-1.5 rounded-full bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-pen-fancy text-[11px]"></i> Marquer signé
    </button>

    <button
      @click="openTerminate()"
      class="px-3 py-1.5 rounded-full bg-rose-50 text-rose-700 hover:bg-rose-100 text-xs font-medium inline-flex items-center gap-1.5">
      <i class="fas fa-ban text-[11px]"></i> Résilier
    </button>
  </div>

  <!-- Tableau -->
  <div class="bg-white border border-gray-100 rounded-3xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-slate-700">
        <thead class="bg-gray-50 text-xs font-semibold text-slate-400 uppercase">
          <tr>
            <th class="px-4 py-3">
              <input type="checkbox" @change="toggleAll($event)" :checked="allChecked" class="rounded border-slate-300">
            </th>
            <th class="px-6 py-3 text-left">Contrat</th>
            <th class="px-6 py-3 text-left">Employé</th>
            <th class="px-6 py-3 text-left">Département</th>
            <th class="px-6 py-3 text-left">Poste</th>
            <th class="px-6 py-3 text-left">Type</th>
            <th class="px-6 py-3 text-left">Période</th>
            <th class="px-6 py-3 text-left">Rémunération</th>
            <th class="px-6 py-3 text-left">Statut</th>
            <th class="px-6 py-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-100">
          <!-- skeleton -->
          <template x-if="loading">
            <template x-for="i in 6" :key="i">
              <tr>
                <td class="px-4 py-4"><div class="h-4 w-4 skeleton rounded-full"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-44 skeleton rounded"></div><div class="h-3 w-28 mt-2 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-40 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-28 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-28 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-24 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-40 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-4 w-20 skeleton rounded"></div></td>
                <td class="px-6 py-4"><div class="h-6 w-28 skeleton rounded-full"></div></td>
                <td class="px-6 py-4"><div class="h-8 w-24 ml-auto skeleton rounded-full"></div></td>
              </tr>
            </template>
          </template>

          <!-- rows -->
          <template x-for="c in contracts" :key="c.id">
            <tr class="hover:bg-gray-50/70 transition-colors">
              <td class="px-4 py-4">
                <input type="checkbox"
                       :value="c.id"
                       @change="toggleOne(c.id, $event)"
                       :checked="selectedIds.includes(c.id)"
                       class="rounded border-slate-300">
              </td>

             <td class="px-6 py-4" data-detail-template="{% url 'contract_detail' pk=999999 %}">
   <a :href="detailUrl(c.id)" class="block rounded-2xl p-3 bg-slate-50 hover:bg-slate-100 transition group">
                  <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs font-semibold group-hover:bg-slate-700 transition">
                      <i class="fas fa-file-signature"></i>
                    </div>
                    <div>
                      <div class="font-semibold text-slate-900" x-text="c.contract_number || '—'"></div>
                      <div class="text-[11px] text-slate-400" x-text="c.title || '—'"></div>
                    </div>
                  </div>
                </a>
</td>

              <td class="px-6 py-4">
                <div class="font-medium text-slate-900" x-text="c.employee_display || (c.employee_name || '—')"></div>
                <div class="text-xs text-slate-500" x-text="c.employee_email || ''"></div>
              </td>

              <td class="px-6 py-4 text-sm text-slate-700" x-text="c.department_display || c.department_name || '—'"></td>
              <td class="px-6 py-4 text-sm text-slate-700" x-text="c.position_display || c.position_title || '—'"></td>

              <td class="px-6 py-4">
                <div class="text-sm font-medium text-slate-900" x-text="c.contract_type_display || '—'"></div>
                <div class="text-[11px] text-slate-400" x-text="c.salary_frequency_label || c.salary_frequency || ''"></div>
              </td>

              <td class="px-6 py-4">
                <div class="text-sm text-slate-700">
                  <span x-text="formatDate(c.start_date)"></span>
                  <span class="text-slate-300">→</span>
                  <span x-text="c.end_date ? formatDate(c.end_date) : '—'"></span>
                </div>
                <div class="text-[11px] text-slate-400">
                  <template x-if="c.days_until_end !== null && c.days_until_end !== undefined">
                    <span x-text="`J-${c.days_until_end}`"></span>
                  </template>
                  <template x-if="c.days_until_end === null || c.days_until_end === undefined">
                    <span x-text="c.contract_type_is_permanent ? 'CDI' : ''"></span>
                  </template>
                  <template x-if="c.is_probation_period">
                    <span class="ml-2 inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 font-semibold">
                      <i class="fas fa-flask text-[10px]"></i> Essai
                    </span>
                  </template>
                </div>
              </td>

              <td class="px-6 py-4">
                <div class="font-semibold text-slate-900" x-text="money(c.base_salary, c.salary_currency)"></div>
                <div class="text-[11px] text-slate-400" x-text="`${c.weekly_hours ?? ''}h/sem`"></div>
              </td>

              <td class="px-6 py-4">
                <span class="px-2.5 py-1 rounded-full text-[11px] font-semibold inline-flex items-center gap-1.5"
                      :class="statusPill(c.status).cls">
                  <i :class="statusPill(c.status).ico"></i>
                  <span x-text="statusPill(c.status).label"></span>
                </span>
              </td>

              <td class="px-6 py-4">
                <div class="flex justify-end gap-2">
                  <button
                    @click="openEdit(c)"
                    class="px-3 py-1.5 text-xs rounded-full bg-slate-900 text-white hover:bg-slate-800 inline-flex items-center gap-1.5"
                    title="Modifier">
                    <i class="fas fa-edit text-[11px]"></i>
                  </button>

                  <button
                    @click="openActions(c)"
                    class="px-3 py-1.5 text-xs rounded-full bg-white border border-gray-200 text-slate-700 hover:bg-gray-50 inline-flex items-center gap-1.5"
                    title="Actions">
                    <i class="fas fa-ellipsis text-[11px]"></i>
                  </button>
                </div>
              </td>
            </tr>
          </template>

          <!-- empty -->
          <tr x-show="!loading && contracts.length===0">
            <td colspan="10" class="py-16 text-center">
              <div class="inline-flex flex-col items-center justify-center px-6 py-5 rounded-3xl border border-dashed border-gray-300 bg-gray-50/60">
                <i class="fas fa-file-contract text-gray-300 text-4xl mb-2"></i>
                <div class="text-sm font-medium text-slate-900">Aucun contrat</div>
                <div class="text-xs text-slate-500 mb-3">Créez un contrat pour commencer le suivi.</div>
                <button @click="openCreate()"
                        class="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-semibold hover:bg-slate-800">
                  <i class="fas fa-plus text-[11px]"></i>
                  <span>Créer un contrat</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="flex flex-col sm:flex-row items-center justify-between gap-3 px-4 py-3 border-t border-gray-100 bg-gray-50/80">
      <div class="text-xs text-slate-500" x-text="paginationText()"></div>
      <div class="flex gap-2">
        <button @click="prevPage()" :disabled="page<=1"
                class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-medium text-slate-700 bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
          <i class="fas fa-chevron-left text-[10px]"></i>
          <span>Précédent</span>
        </button>
        <button @click="nextPage()" :disabled="page>=maxPage"
                class="px-3 py-1.5 rounded-full border border-gray-200 text-xs font-medium text-slate-700 bg-white hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
          <span>Suivant</span>
          <i class="fas fa-chevron-right text-[10px]"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Create/Edit -->
  <div x-show="showForm" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
        <div>
          <h4 class="text-base font-semibold text-slate-900" x-text="editId ? 'Modifier le contrat' : 'Nouveau contrat'"></h4>
          <p class="text-xs text-slate-500 mt-0.5">Renseignez les informations de base du contrat.</p>
        </div>
        <button @click="closeForm()" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>

      <form @submit.prevent="submitForm()" class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Employé</label>
            <select x-model="form.employee" required class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
              <option value="">—</option>
              <template x-for="e in employees" :key="e.id">
                <option :value="e.id" x-text="`${e.first_name || ''} ${e.last_name || ''}`.trim()"></option>
              </template>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Type de contrat</label>
            <select x-model="form.contract_type" required class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
              <option value="">—</option>
              <template x-for="ct in contractTypes" :key="ct.id">
                <option :value="ct.id" x-text="`${ct.name} (${ct.code})`"></option>
              </template>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Intitulé du poste</label>
            <input type="text" x-model.trim="form.title" required
                   class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Département</label>
            <select x-model="form.department" required class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
              <option value="">—</option>
              <template x-for="d in departments" :key="d.id">
                <option :value="d.id" x-text="d.name"></option>
              </template>
            </select>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Poste</label>
            <select x-model="form.position" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
              <option value="">—</option>
              <template x-for="p in positions" :key="p.id">
                <option :value="p.id" x-text="p.title"></option>
              </template>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Début</label>
              <input type="date" x-model="form.start_date" required
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Fin (CDD)</label>
              <input type="date" x-model="form.end_date"
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Salaire de base</label>
              <input type="number" step="0.01" x-model.number="form.base_salary" required
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Devise</label>
              <select x-model="form.salary_currency" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                <option value="XOF">XOF</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Fréquence</label>
              <select x-model="form.salary_frequency" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
                <option value="MONTHLY">Mensuel</option>
                <option value="WEEKLY">Hebdomadaire</option>
                <option value="BIWEEKLY">Bimensuel</option>
                <option value="DAILY">Journalier</option>
                <option value="HOURLY">Horaire</option>
              </select>
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Heures / semaine</label>
              <input type="number" step="0.25" x-model.number="form.weekly_hours"
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Lieu de travail</label>
            <input type="text" x-model.trim="form.work_location"
                   class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div class="flex items-center gap-2 pt-2">
              <input type="checkbox" x-model="form.remote_allowed" class="rounded border-slate-300">
              <label class="text-xs text-slate-600">Télétravail autorisé</label>
            </div>
            <div x-show="form.remote_allowed">
              <label class="text-xs font-medium text-slate-500 mb-1 block">Jours télétravail / semaine</label>
              <input type="number" min="0" max="7" x-model.number="form.remote_days_per_week"
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
          </div>

          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Début essai</label>
              <input type="date" x-model="form.probation_start_date"
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Durée essai (jours)</label>
              <input type="number" min="0" x-model.number="form.probation_duration_days"
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
            <div>
              <label class="text-xs font-medium text-slate-500 mb-1 block">Fin essai</label>
              <input type="date" x-model="form.probation_end_date"
                     class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="text-xs font-medium text-slate-500 mb-1 block">Statut</label>
            <select x-model="form.status"
                    class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-sm focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
              <option value="DRAFT">Brouillon</option>
              <option value="PENDING_APPROVAL">Attente approbation</option>
              <option value="ACTIVE">Actif</option>
              <option value="SUSPENDED">Suspendu</option>
              <option value="TERMINATED">Résilié</option>
              <option value="EXPIRED">Expiré</option>
              <option value="RENEWED">Renouvelé</option>
            </select>
          </div>
        </div>

        <div class="flex items-center justify-end gap-2 pt-3 border-t border-gray-100">
          <button type="button" @click="closeForm()"
                  class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
            Annuler
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-full bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800 inline-flex items-center gap-2"
                  :disabled="submitting">
            <i class="fas fa-circle-notch fa-spin text-[11px]" x-show="submitting"></i>
            <span x-text="editId ? 'Enregistrer' : 'Créer'"></span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Actions (submit/approve/sign/terminate single) -->
  <div x-show="showActions" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <div>
          <h4 class="text-base font-semibold text-slate-900">Actions</h4>
          <p class="text-xs text-slate-500 mt-0.5" x-text="activeContract ? (activeContract.contract_number || '') : ''"></p>
        </div>
        <button @click="showActions=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>

      <div class="p-6 space-y-2 text-sm">
        <button @click="doAction('submit')"
                class="w-full px-4 py-2 rounded-2xl border border-gray-200 hover:bg-gray-50 text-slate-700 inline-flex items-center justify-between">
          <span class="inline-flex items-center gap-2"><i class="fas fa-paper-plane text-[12px]"></i> Soumettre pour approbation</span>
          <i class="fas fa-chevron-right text-[11px] text-slate-400"></i>
        </button>

        <button @click="doAction('approve')"
                class="w-full px-4 py-2 rounded-2xl border border-emerald-200 bg-emerald-50 hover:bg-emerald-100 text-emerald-700 inline-flex items-center justify-between">
          <span class="inline-flex items-center gap-2"><i class="fas fa-check text-[12px]"></i> Approuver</span>
          <i class="fas fa-chevron-right text-[11px]"></i>
        </button>

        <button @click="doAction('sign')"
                class="w-full px-4 py-2 rounded-2xl border border-indigo-200 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 inline-flex items-center justify-between">
          <span class="inline-flex items-center gap-2"><i class="fas fa-pen-fancy text-[12px]"></i> Marquer signé</span>
          <i class="fas fa-chevron-right text-[11px]"></i>
        </button>

        <button @click="openTerminate()"
                class="w-full px-4 py-2 rounded-2xl border border-rose-200 bg-rose-50 hover:bg-rose-100 text-rose-700 inline-flex items-center justify-between">
          <span class="inline-flex items-center gap-2"><i class="fas fa-ban text-[12px]"></i> Résilier</span>
          <i class="fas fa-chevron-right text-[11px]"></i>
        </button>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
        <button @click="showActions=false"
                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Terminate -->
  <div x-show="showTerminate" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden border border-gray-100">
      <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
        <h4 class="text-base font-semibold text-slate-900">Résiliation</h4>
        <button @click="showTerminate=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>

      <div class="p-6 space-y-4 text-sm">
        <div>
          <label class="text-xs font-medium text-slate-500 mb-1 block">Type</label>
          <select x-model="terminateForm.termination_type"
                  class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <option value="RESIGNATION">Démission</option>
            <option value="DISMISSAL">Licenciement</option>
            <option value="MUTUAL_AGREEMENT">Rupture conventionnelle</option>
            <option value="END_CONTRACT">Fin de contrat</option>
            <option value="OTHER">Autre</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-medium text-slate-500 mb-1 block">Date</label>
          <input type="date" x-model="terminateForm.termination_date"
                 class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
        </div>

        <div>
          <label class="text-xs font-medium text-slate-500 mb-1 block">Motif</label>
          <input type="text" x-model="terminateForm.termination_reason"
                 class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
                 placeholder="Optionnel">
        </div>

        <div class="text-[11px] text-slate-500 bg-slate-50 border border-slate-100 rounded-2xl p-3">
          Cette action met le contrat au statut <span class="font-semibold">TERMINATED</span> et renseigne les champs de résiliation.
        </div>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
        <button @click="showTerminate=false"
                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
          Annuler
        </button>
        <button @click="doTerminate()"
                class="px-4 py-2 rounded-full bg-rose-600 text-white text-xs font-semibold hover:bg-rose-700">
          Résilier
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Export -->
  <div x-show="showExport" x-cloak class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
      <div class="flex items-center justify-between px-6 py-4 border-b border-gray-100">
        <div>
          <h4 class="text-base font-semibold text-slate-900">Exporter les contrats</h4>
          <p class="text-xs text-slate-500 mt-0.5">Filtrez puis générez un fichier.</p>
        </div>
        <button @click="showExport=false" class="p-2 hover:bg-gray-50 rounded-full text-slate-400">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>

      <div class="p-6 space-y-6 text-sm">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Format</label>
            <select x-model="exportFormat" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
              <option value="xlsx">Excel (.xlsx)</option>
              <option value="csv">CSV (.csv)</option>
            </select>
          </div>

          <div class="md:col-span-2">
            <label class="text-xs font-medium text-slate-500 mb-1 block">Champs</label>
            <div class="grid grid-cols-2 gap-2">
              <template x-for="f in exportFieldsAll" :key="f.value">
                <label class="text-xs flex items-center gap-2">
                  <input type="checkbox" :value="f.value" x-model="exportFields" class="rounded border-slate-300">
                  <span x-text="f.label"></span>
                </label>
              </template>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Statut</label>
            <select x-model="exportFilters.status" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
              <option value="">Tous</option>
              <option value="DRAFT">Brouillon</option>
              <option value="PENDING_APPROVAL">Attente approbation</option>
              <option value="ACTIVE">Actif</option>
              <option value="TERMINATED">Résilié</option>
              <option value="EXPIRED">Expiré</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Type</label>
            <select x-model="exportFilters.contract_type" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
              <option value="">Tous</option>
              <template x-for="ct in contractTypes" :key="ct.id">
                <option :value="ct.id" x-text="ct.name"></option>
              </template>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-slate-500 mb-1 block">Employé</label>
            <select x-model="exportFilters.employee" class="w-full border border-gray-200 rounded-2xl px-3 py-2.5 text-xs">
              <option value="">Tous</option>
              <template x-for="e in employees" :key="e.id">
                <option :value="e.id" x-text="`${e.first_name || ''} ${e.last_name || ''}`.trim()"></option>
              </template>
            </select>
          </div>
        </div>
      </div>

      <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
        <button @click="showExport=false"
                class="px-4 py-2 rounded-full border border-gray-200 text-xs font-medium text-slate-600 hover:bg-gray-50">
          Annuler
        </button>
        <button @click="doExport()"
                class="px-4 py-2 rounded-full bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700"
                :disabled="!exportFields.length">
          Exporter
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function contractView() {
  return {
    // state
    contracts: [],
    contractTypes: [],
    employees: [],
    departments: [],
    positions: [],

    loading: false,
    page: 1,
    pageSize: 10,
    total: 0,
    maxPage: 1,
    ordering: '-start_date',
    search: '',
    filters: {
      employee: '',
      contract_type: '',
      status: '',
      start_after: '',
      start_before: ''
    },

    selectedIds: [],
    get allChecked() {
      return this.selectedIds.length && this.selectedIds.length === this.contracts.length;
    },

    counts: { active: 0, renewable: 0, expiring: 0 },

    // modals
    showForm: false,
    editId: null,
    submitting: false,
    form: {
      employee: '',
      contract_type: '',
      title: '',
      department: '',
      position: '',
      start_date: new Date().toISOString().slice(0, 10),
      end_date: '',
      base_salary: 0,
      salary_currency: 'XOF',
      salary_frequency: 'MONTHLY',
      weekly_hours: 40,
      work_location: '',
      remote_allowed: false,
      remote_days_per_week: 0,
      probation_start_date: '',
      probation_duration_days: 90,
      probation_end_date: '',
      status: 'DRAFT'
    },

    showActions: false,
    activeContract: null,

    showTerminate: false,
    terminateTargets: [], // ids
    terminateForm: {
      termination_type: 'OTHER',
      termination_date: new Date().toISOString().slice(0, 10),
      termination_reason: ''
    },

    showExport: false,
    exportFormat: 'xlsx',
    exportFields: [
      'contract_number','employee','contract_type','title','department','position',
      'start_date','end_date','base_salary','salary_currency','status'
    ],
    exportFieldsAll: [
      {label:'N° contrat', value:'contract_number'},
      {label:'Employé', value:'employee'},
      {label:'Type', value:'contract_type'},
      {label:'Poste', value:'title'},
      {label:'Département', value:'department'},
      {label:'Position', value:'position'},
      {label:'Début', value:'start_date'},
      {label:'Fin', value:'end_date'},
      {label:'Salaire', value:'base_salary'},
      {label:'Devise', value:'salary_currency'},
      {label:'Statut', value:'status'},
    ],
    exportFilters: { status:'', contract_type:'', employee:'' },

    // API helper
    async apiCall(path, options = {}, expectBlob = false) {
      const headers = { 'X-Tenant-Id': Conf.tenantId };
      const method = (options.method || 'GET').toUpperCase();
      if (!['GET','HEAD','OPTIONS'].includes(method)) {
        const csrftoken = getCookie('csrftoken');
        if (csrftoken) headers['X-CSRFToken'] = csrftoken;
      }
      if (!(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
      if (Conf.token) headers['Authorization'] = `Bearer ${Conf.token}`;

      const url = `${Conf.apiBase}${path.startsWith('/') ? '' : '/'}${path}`;
      const res = await fetch(url, { ...options, headers });
      if (!res.ok) {
        let detail = '';
        try {
          const j = await res.json();
          detail = j.detail ? j.detail : JSON.stringify(j);
        } catch {}
        throw new Error(`${res.status} ${res.statusText}${detail ? ' - ' + detail : ''}`);
      }
      if (expectBlob) return res.blob();
      return res.status === 204 ? null : res.json();
    },

    toast(msg, type='info') {
      if (window.hrToast) window.hrToast(msg, type);
      else { console.log(`[${type}]`, msg); alert(msg); }
    },

    // refs
    async fetchRefs() {
      try { const ct = await this.apiCall('/contract-types/'); this.contractTypes = ct.results || ct; } catch {}
      try { const e = await this.apiCall('/employees/?page_size=200'); this.employees = e.results || e; } catch {}
      try { const d = await this.apiCall('/departments/'); this.departments = d.results || d; } catch {}
      try { const p = await this.apiCall('/positions/'); this.positions = p.results || p; } catch {}
    },

    // list
    async fetchContracts() {
      this.loading = true;
      try {
        const params = new URLSearchParams();
        params.set('page', this.page);
        params.set('page_size', this.pageSize);
        params.set('ordering', this.ordering);
        if (this.search) params.set('search', this.search);
        if (this.filters.employee) params.set('employee', this.filters.employee);
        if (this.filters.contract_type) params.set('contract_type', this.filters.contract_type);
        if (this.filters.status) params.set('status', this.filters.status);

        // si tu ajoutes des filtres django-filter: start_date__gte / start_date__lte
        if (this.filters.start_after) params.set('start_date__gte', this.filters.start_after);
        if (this.filters.start_before) params.set('start_date__lte', this.filters.start_before);

        const data = await this.apiCall(`/employment-contracts/?${params.toString()}`);
        const list = data.results || data;

        this.contracts = list;
        this.total = data.count ?? (Array.isArray(list) ? list.length : 0);
        this.maxPage = data.count ? Math.max(1, Math.ceil(data.count / this.pageSize)) : 1;

        // stats page
        let active = 0, renewable = 0, expiring = 0;
        for (const c of list) {
          if (c.is_active) active++;
          if (c.can_be_renewed) renewable++;
          if (c.requires_renewal) expiring++;
        }
        this.counts = { active, renewable, expiring };

        // keep only visible selected
        this.selectedIds = this.selectedIds.filter(id => this.contracts.find(x => x.id === id));
      } catch (e) {
        console.error(e);
        this.toast("Chargement des contrats impossible", "error");
      } finally {
        this.loading = false;
      }
    },

    // pagination
    paginationText() {
      if (!this.total) return '—';
      const start = (this.page - 1) * this.pageSize + 1;
      const end = Math.min(this.page * this.pageSize, this.total);
      return `Résultats ${start}–${end} sur ${this.total}`;
    },
    nextPage() { if (this.page < this.maxPage) { this.page++; this.fetchContracts(); } },
    prevPage() { if (this.page > 1) { this.page--; this.fetchContracts(); } },

    // selection
    toggleAll(ev) { this.selectedIds = ev.target.checked ? this.contracts.map(c => c.id) : []; },
    toggleOne(id, ev) {
      if (ev.target.checked) { if (!this.selectedIds.includes(id)) this.selectedIds.push(id); }
      else { this.selectedIds = this.selectedIds.filter(x => x !== id); }
    },

    resetFilters() {
      this.search = '';
      this.filters = { employee:'', contract_type:'', status:'', start_after:'', start_before:'' };
      this.page = 1;
      this.pageSize = 10;
      this.ordering = '-start_date';
      this.selectedIds = [];
      this.fetchContracts();
    },

    // pills
    statusPill(st) {
      const map = {
        DRAFT: {label:'Brouillon', cls:'bg-slate-100 text-slate-700', ico:'fas fa-pen text-[11px]'},
        PENDING_APPROVAL: {label:'À approuver', cls:'bg-amber-50 text-amber-700', ico:'fas fa-hourglass-half text-[11px]'},
        ACTIVE: {label:'Actif', cls:'bg-emerald-50 text-emerald-700', ico:'fas fa-badge-check text-[11px]'},
        SUSPENDED: {label:'Suspendu', cls:'bg-indigo-50 text-indigo-700', ico:'fas fa-pause text-[11px]'},
        TERMINATED: {label:'Résilié', cls:'bg-rose-50 text-rose-700', ico:'fas fa-ban text-[11px]'},
        EXPIRED: {label:'Expiré', cls:'bg-gray-100 text-gray-700', ico:'fas fa-hourglass-end text-[11px]'},
        RENEWED: {label:'Renouvelé', cls:'bg-sky-50 text-sky-700', ico:'fas fa-rotate text-[11px]'},
      };
      return map[st] || {label: st || '—', cls:'bg-gray-100 text-gray-700', ico:'fas fa-circle text-[10px]'};
    },

    // utils
    formatDate(d) { if (!d) return '—'; return new Date(d).toLocaleDateString('fr-FR'); },
    money(v, cur='XOF') {
      if (v === null || v === undefined || v === '') return '—';
      try {
        return new Intl.NumberFormat('fr-FR', { style:'currency', currency: cur || 'XOF', maximumFractionDigits: 0 }).format(Number(v));
      } catch {
        return `${v} ${cur || ''}`.trim();
      }
    },

    // open/close form
    openCreate() {
      this.editId = null;
      this.form = {
        employee: '', contract_type: '', title: '', department: '', position: '',
        start_date: new Date().toISOString().slice(0, 10), end_date: '',
        base_salary: 0, salary_currency: 'XOF', salary_frequency: 'MONTHLY',
        weekly_hours: 40, work_location: '', remote_allowed: false, remote_days_per_week: 0,
        probation_start_date: '', probation_duration_days: 90, probation_end_date: '',
        status: 'DRAFT'
      };
      this.showForm = true;
    },
    openEdit(c) {
      this.editId = c.id;
      this.form = {
        employee: c.employee ?? c.employee_id ?? '',
        contract_type: c.contract_type ?? c.contract_type_id ?? '',
        title: c.title || '',
        department: c.department ?? c.department_id ?? '',
        position: c.position ?? c.position_id ?? '',
        start_date: (c.start_date || '').slice(0,10),
        end_date: c.end_date ? String(c.end_date).slice(0,10) : '',
        base_salary: Number(c.base_salary || 0),
        salary_currency: c.salary_currency || 'XOF',
        salary_frequency: c.salary_frequency || 'MONTHLY',
        weekly_hours: Number(c.weekly_hours ?? 40),
        work_location: c.work_location || '',
        remote_allowed: !!c.remote_allowed,
        remote_days_per_week: Number(c.remote_days_per_week ?? 0),
        probation_start_date: c.probation_start_date ? String(c.probation_start_date).slice(0,10) : '',
        probation_duration_days: Number(c.probation_duration_days ?? 90),
        probation_end_date: c.probation_end_date ? String(c.probation_end_date).slice(0,10) : '',
        status: c.status || 'DRAFT'
      };
      this.showForm = true;
    },
    closeForm() { this.showForm = false; this.editId = null; },

    async submitForm() {
      this.submitting = true;
      try {
        const payload = { ...this.form };

        if (this.editId) {
          await this.apiCall(`/employment-contracts/${this.editId}/`, { method:'PATCH', body: JSON.stringify(payload) });
          this.toast('Contrat mis à jour', 'success');
        } else {
          await this.apiCall(`/employment-contracts/`, { method:'POST', body: JSON.stringify(payload) });
          this.toast('Contrat créé', 'success');
        }
        this.showForm = false;
        this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast(e.message || "Enregistrement impossible", "error");
      } finally {
        this.submitting = false;
      }
    },

    // actions modal
    openActions(c) { this.activeContract = c; this.showActions = true; },

    async doAction(action) {
      const c = this.activeContract;
      if (!c) return;
      try {
        if (action === 'submit') {
          await this.apiCall(`/employment-contracts/${c.id}/submit_for_approval/`, { method:'POST', body: '{}' });
          this.toast('Contrat soumis', 'success');
        } else if (action === 'approve') {
          await this.apiCall(`/employment-contracts/${c.id}/approve/`, { method:'POST', body: '{}' });
          this.toast('Contrat approuvé', 'success');
        } else if (action === 'sign') {
          await this.apiCall(`/employment-contracts/${c.id}/mark_signed/`, {
            method:'POST',
            body: JSON.stringify({ signed_by_employee:true, signed_by_employer:true })
          });
          this.toast('Contrat marqué signé', 'success');
        }
        this.showActions = false;
        this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast('Action impossible : ' + (e.message || ''), 'error');
      }
    },

    // terminate
    openTerminate() {
      this.terminateTargets = this.selectedIds.length ? [...this.selectedIds] : (this.activeContract ? [this.activeContract.id] : []);
      this.terminateForm = {
        termination_type: 'OTHER',
        termination_date: new Date().toISOString().slice(0,10),
        termination_reason: ''
      };
      this.showActions = false;
      this.showTerminate = true;
    },
    async doTerminate() {
      try {
        if (!this.terminateTargets.length) return;
        // single terminate per id (simple + fiable)
        for (const id of this.terminateTargets) {
          await this.apiCall(`/employment-contracts/${id}/terminate/`, {
            method:'POST',
            body: JSON.stringify(this.terminateForm)
          });
        }
        this.toast('Résiliation appliquée', 'success');
        this.showTerminate = false;
        this.selectedIds = [];
        this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast('Résiliation impossible : ' + (e.message || ''), 'error');
      }
    },

    // batch open
    batchOpen(kind) {
      // exécute en boucle (pas besoin endpoint bulk)
      if (!this.selectedIds.length) return;
      this.activeContract = null;
      if (kind === 'submit') this.batchDo('submit');
      if (kind === 'approve') this.batchDo('approve');
      if (kind === 'sign') this.batchDo('sign');
    },
    async batchDo(kind) {
      try {
        for (const id of this.selectedIds) {
          if (kind === 'submit') await this.apiCall(`/employment-contracts/${id}/submit_for_approval/`, { method:'POST', body:'{}' });
          if (kind === 'approve') await this.apiCall(`/employment-contracts/${id}/approve/`, { method:'POST', body:'{}' });
          if (kind === 'sign') await this.apiCall(`/employment-contracts/${id}/mark_signed/`, { method:'POST', body: JSON.stringify({signed_by_employee:true, signed_by_employer:true}) });
        }
        this.toast('Action batch appliquée', 'success');
        this.selectedIds = [];
        this.fetchContracts();
      } catch (e) {
        console.error(e);
        this.toast('Action batch impossible : ' + (e.message || ''), 'error');
      }
    },

    // export
    openExport() {
      this.exportFilters = {
        status: this.filters.status || '',
        contract_type: this.filters.contract_type || '',
        employee: this.filters.employee || '',
      };
      this.showExport = true;
    },
    async doExport() {
      try {
        const body = {
          format: this.exportFormat,
          fields: this.exportFields,
          filters: {
            ...(this.exportFilters.status ? {status: this.exportFilters.status} : {}),
            ...(this.exportFilters.contract_type ? {contract_type: this.exportFilters.contract_type} : {}),
            ...(this.exportFilters.employee ? {employee: this.exportFilters.employee} : {}),
          }
        };
        // endpoint à créer côté API (sinon remplace par une URL existante)
        const blob = await this.apiCall('/employment-contracts/export_contracts/', {
          method: 'POST',
          body: JSON.stringify(body)
        }, true);

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `contracts_export.${this.exportFormat === 'xlsx' ? 'xlsx' : 'csv'}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        this.toast('Export généré', 'success');
        this.showExport = false;
      } catch (e) {
        console.error(e);
        this.toast('Export impossible', 'error');
      }
    },

    async init() {
      await this.fetchRefs();
      await this.fetchContracts();
    }
  };
}
</script>

<style>
.skeleton {
  background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
  background-size: 200% 100%;
  animation: loading 1.3s infinite;
}
@keyframes loading {
  0% { background-position: 200% 0 }
  100% { background-position: -200% 0 }
}
</style>