<!-- Lyneerp/hr/templates/hr/partials/recruitment.html -->
<div class="space-y-6" x-data="recruitmentView()" x-init="init()">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
            <h3 class="text-2xl font-bold text-gray-800">Recrutement</h3>
            <p class="text-gray-600">Créez, publiez et suivez vos campagnes de recrutement avec l’aide de l’IA.</p>
        </div>
        <div class="flex gap-3">
            <div class="relative">
                <input type="text" x-model="search"
                       @input.debounce.400ms="page=1; fetchRecruitments()"
                       placeholder="Rechercher un poste, une référence, un département…"
                       class="pl-10 pr-4 py-2 w-64 bg-white border rounded-xl focus:ring-2 focus:ring-blue-500 transition">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <button @click="openCreate()"
                    class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">
                <i class="fas fa-plus mr-2"></i>Nouveau recrutement
            </button>
        </div>
    </div>

    <!-- Statuts / filtres -->
    <div class="flex flex-wrap gap-2">
        <template x-for="chip in statusChips" :key="chip.key">
            <button @click="status = chip.key; page=1; fetchRecruitments()"
                    class="px-3 py-1 rounded-full border transition"
                    :class="status===chip.key
                      ? 'bg-blue-50 text-blue-700 border-blue-200'
                      : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'">
                <span class="font-medium" x-text="chip.label"></span>
                <span class="ml-2 text-xs px-2 py-0.5 rounded-full"
                      :class="status===chip.key ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'"
                      x-text="counts[chip.key] ?? 0"></span>
            </button>
        </template>
    </div>

    <!-- Carte liste -->
    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
        <!-- Barre d’actions tableau -->
        <div class="flex items-center justify-between px-4 py-3 border-b">
            <div class="flex items-center gap-2 text-sm">
                <span class="text-gray-600">Trier par :</span>
                <select x-model="ordering" @change="page=1; fetchRecruitments()"
                        class="border rounded-lg px-3 py-1 focus:ring-2 focus:ring-blue-500">
                    <option value="-created_at">Plus récents</option>
                    <option value="created_at">Plus anciens</option>
                    <option value="-publication_date">Publication (récent)</option>
                    <option value="publication_date">Publication (ancien)</option>
                    <option value="title">Titre (A→Z)</option>
                    <option value="-title">Titre (Z→A)</option>
                </select>
                <div class="hidden md:block h-4 w-px bg-gray-200 mx-2"></div>
                <span class="text-gray-500" x-text="`${total} résultat(s)`"></span>
            </div>

            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-600">Par page</span>
                <select x-model.number="pageSize" @change="page=1; fetchRecruitments()"
                        class="border rounded-lg px-2 py-1">
                    <option>10</option>
                    <option>20</option>
                    <option>50</option>
                </select>
            </div>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Poste</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Département</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Statut</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Candidatures</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Publiée le</th>
                    <th class="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Actions</th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <!-- Skeletons -->
                <template x-if="loading">
                    <template x-for="i in 6" :key="i">
                        <tr>
                            <td class="px-6 py-4">
                                <div class="h-4 w-40 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-32 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-6 w-20 skeleton rounded-full"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-10 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="h-4 w-24 skeleton rounded"></div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="h-8 w-28 ml-auto skeleton rounded"></div>
                            </td>
                        </tr>
                    </template>
                </template>

                <!-- Lignes -->
                <template x-for="rec in recruitments" :key="rec.id">
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 align-top">
                            <div class="text-sm font-semibold text-gray-900" x-text="rec.title"></div>
                            <div class="text-xs text-gray-500" x-text="rec.reference"></div>
                            <template x-if="rec.ai_scoring_enabled">
                  <span class="mt-2 inline-flex items-center text-[11px] px-2 py-0.5 rounded-full bg-purple-50 text-purple-700">
                    <i class="fas fa-robot mr-1"></i> IA activée
                  </span>
                            </template>
                        </td>
                        <td class="px-6 py-4 align-top">
                            <div class="text-sm text-gray-900"
                                 x-text="rec.department_name || rec.department?.name"></div>
                            <div class="text-xs text-gray-500" x-text="rec.position_title || rec.position?.title"></div>
                        </td>
                        <td class="px-6 py-4 align-top">
                <span class="px-2 inline-flex text-xs font-semibold rounded-full"
                      :class="statusClass(rec.status)"
                      x-text="statusLabel(rec.status)"></span>
                        </td>
                        <td class="px-6 py-4 align-top">
                            <div class="text-sm text-gray-900" x-text="rec.applications_count ?? 0"></div>
                        </td>
                        <td class="px-6 py-4 align-top text-sm text-gray-600"
                            x-text="formatDate(rec.publication_date) || '—'"></td>
                        <td class="px-6 py-4 align-top">
                            <div class="flex justify-end gap-2">
                                <button @click="openDetail(rec.id)"
                                        class="px-3 py-1.5 text-sm rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-200">
                                    <i class="fas fa-eye mr-1"></i>Voir
                                </button>
                                <button @click="openEdit(rec)"
                                        class="px-3 py-1.5 text-sm rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200">
                                    <i class="fas fa-edit mr-1"></i>Éditer
                                </button>
                                <template x-if="rec.status==='DRAFT' || rec.status==='CLOSED'">
                                    <button @click="publish(rec.id)"
                                            class="px-3 py-1.5 text-sm rounded-lg bg-green-100 text-green-700 hover:bg-green-200">
                                        <i class="fas fa-bullhorn mr-1"></i>Publier
                                    </button>
                                </template>
                                <template x-if="rec.status!=='CLOSED' && rec.status!=='CANCELLED'">
                                    <button @click="closeRec(rec.id)"
                                            class="px-3 py-1.5 text-sm rounded-lg bg-red-100 text-red-700 hover:bg-red-200">
                                        <i class="fas fa-lock mr-1"></i>Clôturer
                                    </button>
                                </template>
                                <button @click="confirmDelete(rec)"
                                        class="px-3 py-1.5 text-sm rounded-lg bg-white border text-red-600 hover:bg-red-50">
                                    <i class="fas fa-trash mr-1"></i>Supprimer
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>

                <!-- Empty -->
                <tr x-show="!loading && recruitments.length===0">
                    <td colspan="6" class="py-16 text-center">
                        <i class="fas fa-briefcase text-gray-300 text-5xl mb-3"></i>
                        <div class="text-lg font-medium text-gray-900">Aucun recrutement</div>
                        <div class="text-gray-500 mb-4">Créez votre première campagne.</div>
                        <button @click="openCreate()"
                                class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>Créer un recrutement
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="flex items-center justify-between px-4 py-3 border-t bg-gray-50">
            <div class="text-sm text-gray-600" x-text="paginationText()"></div>
            <div class="flex gap-2">
                <button @click="prevPage()" :disabled="page<=1"
                        class="px-3 py-1.5 rounded-lg border text-gray-700 hover:bg-gray-100 disabled:opacity-40">
                    <i class="fas fa-chevron-left mr-1"></i> Précédent
                </button>
                <button @click="nextPage()" :disabled="page>=maxPage"
                        class="px-3 py-1.5 rounded-lg border text-gray-700 hover:bg-gray-100 disabled:opacity-40">
                    Suivant <i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Création / Édition -->
    <div x-show="showForm" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-xl overflow-hidden">
            <div class="flex items-center justify-between px-6 py-4 border-b">
                <h4 class="text-lg font-semibold"
                    x-text="editId ? 'Modifier le recrutement' : 'Nouveau recrutement'"></h4>
                <button @click="closeForm()" class="p-2 hover:bg-gray-100 rounded-xl"><i class="fas fa-times"></i>
                </button>
            </div>

            <form @submit.prevent="submitForm()" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Intitulé du poste</label>
                        <input type="text" x-model.trim="form.title" required
                               class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-red-600 mt-1" x-show="errors.title" x-text="errors.title"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Référence</label>
                        <input type="text" x-model.trim="form.reference" required
                               class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-red-600 mt-1" x-show="errors.reference" x-text="errors.reference"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Département</label>
                        <select x-model="form.department" required
                                class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Sélectionner…</option>
                            <template x-for="d in departments" :key="d.id">
                                <option :value="d.id" x-text="d.name"></option>
                            </template>
                        </select>
                        <p class="text-xs text-red-600 mt-1" x-show="errors.department" x-text="errors.department"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Poste</label>
                        <select x-model="form.position" required
                                class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Sélectionner…</option>
                            <template x-for="p in positions" :key="p.id">
                                <option :value="p.id" x-text="p.title"></option>
                            </template>
                        </select>
                        <p class="text-xs text-red-600 mt-1" x-show="errors.position" x-text="errors.position"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type de contrat</label>
                        <select x-model="form.contract_type"
                                class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="CDI">CDI</option>
                            <option value="CDD">CDD</option>
                            <option value="STAGE">Stage</option>
                            <option value="ALTERNANCE">Alternance</option>
                            <option value="FREELANCE">Freelance</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de postes</label>
                        <input type="number" min="1" x-model.number="form.number_of_positions"
                               class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description du poste</label>
                        <textarea rows="4" x-model.trim="form.job_description"
                                  class="w-full border rounded-xl px-3 py-2 focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Salaire min</label>
                            <input type="number" step="0.01" x-model.number="form.salary_min"
                                   class="w-full border rounded-xl px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Salaire max</label>
                            <input type="number" step="0.01" x-model.number="form.salary_max"
                                   class="w-full border rounded-xl px-3 py-2">
                        </div>
                        <div class="flex items-center gap-2 pt-6">
                            <input id="remote_allowed" type="checkbox" x-model="form.remote_allowed" class="rounded">
                            <label for="remote_allowed" class="text-sm text-gray-700">Télétravail autorisé</label>
                        </div>
                    </div>

                    <!-- Bloc IA -->
                    <div class="md:col-span-2 p-4 rounded-xl border bg-purple-50/50">
                        <div class="flex items-center justify-between">
                            <div class="font-semibold text-purple-800"><i class="fas fa-robot mr-2"></i>Configuration IA
                            </div>
                            <label class="inline-flex items-center gap-2 text-sm">
                                <input type="checkbox" x-model="form.ai_scoring_enabled" class="rounded">
                                <span>Activer le scoring IA</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Score minimum (%)</label>
                                <input type="number" min="0" max="100" step="1" x-model.number="form.minimum_ai_score"
                                       class="w-full border rounded-xl px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Critères IA (JSON)</label>
                                <textarea rows="4" x-model="aiCriteriaText"
                                          @blur="validateJSON('aiCriteriaText')"
                                          class="w-full border rounded-xl px-3 py-2 font-mono text-xs"></textarea>
                                <p class="text-xs text-red-600 mt-1" x-show="errors.ai_scoring_criteria"
                                   x-text="errors.ai_scoring_criteria"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-2 pt-2 border-t">
                    <button type="button" @click="closeForm()"
                            class="px-4 py-2 rounded-xl border hover:bg-gray-50">Annuler
                    </button>
                    <button type="submit"
                            class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700"
                            :disabled="submitting">
                        <i class="fas fa-circle-notch fa-spin mr-2" x-show="submitting"></i>
                        <span x-text="editId ? 'Enregistrer' : 'Créer'"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal détail -->
    <div x-show="showDetail" x-cloak class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center p-4"
         @click="showDetail=false">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-xl overflow-hidden" @click.stop>
            <div class="flex items-center justify-between px-6 py-4 border-b">
                <div>
                    <h4 class="text-lg font-semibold" x-text="detail?.title"></h4>
                    <p class="text-sm text-gray-600" x-text="detail?.reference"></p>
                </div>
                <button @click="showDetail=false" class="p-2 hover:bg-gray-100 rounded-xl"><i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-4">
                    <div>
                        <div class="text-sm text-gray-500 mb-1">Description du poste</div>
                        <div class="p-4 bg-gray-50 rounded-xl" x-text="detail?.job_description || '—'"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Département</div>
                            <div class="font-medium" x-text="detail?.department_name || detail?.department?.name"></div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Type de contrat</div>
                            <div class="font-medium" x-text="detail?.contract_type"></div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Postes</div>
                            <div class="font-medium" x-text="detail?.number_of_positions"></div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500 mb-1">Scoring IA</div>
                            <div class="font-medium" x-text="detail?.ai_scoring_enabled ? 'Activé' : 'Désactivé'"></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-500">Statut</div>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full" :class="statusClass(detail?.status)"
                              x-text="statusLabel(detail?.status)"></span>
                    </div>
                    <div class="text-sm text-gray-500">Candidatures récentes</div>
                    <div class="space-y-3 max-h-72 overflow-y-auto pr-1">
                        <template x-for="app in detailApps" :key="app.id">
                            <div class="border rounded-xl p-3">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <div class="font-medium" x-text="`${app.first_name} ${app.last_name}`"></div>
                                        <div class="text-xs text-gray-500" x-text="app.email"></div>
                                    </div>
                                    <span class="text-xs px-2 py-0.5 rounded-full" :class="appStatusClass(app.status)"
                                          x-text="app.status"></span>
                                </div>
                                <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                                    <span x-text="formatDate(app.applied_at)"></span>
                                    <span x-show="app.ai_score"
                                          :class="Number(app.ai_score) >= 70 ? 'text-green-600' : 'text-yellow-600'"
                                          class="font-semibold" x-text="`IA: ${app.ai_score}%`"></span>
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <button @click="analyzeAI(app.id)"
                                            class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200">
                                        <i class="fas fa-robot mr-1"></i>Analyser IA
                                    </button>
                                    <button class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded hover:bg-gray-200">
                                        <i class="fas fa-eye mr-1"></i>Voir
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t bg-gray-50 flex items-center justify-end gap-2">
                <button @click="showDetail=false" class="px-4 py-2 rounded-xl border hover:bg-gray-100">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal confirmation suppression -->
    <div x-show="confirming" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden">
            <div class="px-6 py-4 border-b">
                <h4 class="text-lg font-semibold text-gray-800">Supprimer le recrutement</h4>
            </div>
            <div class="p-6">
                <p class="text-gray-700">Cette action est irréversible. Confirmez-vous la suppression de
                    <span class="font-semibold" x-text="toDelete?.title"></span> ?</p>
            </div>
            <div class="px-6 py-4 border-t flex items-center justify-end gap-2">
                <button @click="confirming=false" class="px-4 py-2 rounded-xl border hover:bg-gray-50">Annuler</button>
                <button @click="doDelete()" class="px-4 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700">
                    Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function recruitmentView() {
        return {
            // Etat liste
            recruitments: [],
            loading: false,
            page: 1,
            pageSize: 10,
            total: 0,
            maxPage: 1,
            ordering: '-created_at',
            search: '',
            status: 'all',
            counts: {},

            // Référentiels
            departments: [],
            positions: [],

            // Formulaire
            showForm: false,
            editId: null,
            submitting: false,
            form: {
                title: '',
                reference: '',
                department: '',
                position: '',
                job_description: '',
                contract_type: 'CDI',
                number_of_positions: 1,
                salary_min: null,
                salary_max: null,
                remote_allowed: false,
                ai_scoring_enabled: true,
                minimum_ai_score: 60,
                ai_scoring_criteria: {}
            },
            aiCriteriaText: '{\n  "skills": { "weight": 0.6 },\n  "experience": { "weight": 0.3 },\n  "education": { "weight": 0.1 }\n}',
            errors: {},

            // Détail
            showDetail: false,
            detail: null,
            detailApps: [],

            // Suppression
            confirming: false,
            toDelete: null,

            statusChips: [
                {key: 'all', label: 'Tous'},
                {key: 'OPEN', label: 'Ouverts'},
                {key: 'IN_REVIEW', label: 'En revue'},
                {key: 'INTERVIEW', label: 'Entretiens'},
                {key: 'OFFER', label: 'Offres'},
                {key: 'CLOSED', label: 'Clôturés'},
                {key: 'DRAFT', label: 'Brouillons'},
            ],

            // --- API helper local (utilise Conf global) --- //
            async apiCall(path, options = {}) {
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Tenant-Id': Conf.tenantId,
                };
                if (Conf.token) headers['Authorization'] = `Bearer ${Conf.token}`;
                const url = `${Conf.apiBase}${path.startsWith('/') ? '' : '/'}${path}`;
                const res = await fetch(url, {...options, headers});
                if (!res.ok) {
                    let detail = '';
                    try {
                        const j = await res.json();
                        detail = j.detail || j.error || '';
                    } catch {
                    }
                    throw new Error(`${res.status} ${res.statusText}${detail ? ' - ' + detail : ''}`);
                }
                return res.status === 204 ? null : res.json();
            },

            // --- Chargements --- //
            async fetchRecruitments() {
                this.loading = true;
                try {
                    const params = new URLSearchParams();
                    params.set('page', this.page);
                    params.set('page_size', this.pageSize);
                    params.set('ordering', this.ordering);
                    if (this.search) params.set('search', this.search);
                    if (this.status !== 'all') params.set('status', this.status);

                    const data = await this.apiCall(`/recruitments/?${params.toString()}`);
                    this.recruitments = data.results || data;
                    this.total = data.count ?? (Array.isArray(data) ? data.length : 0);
                    this.maxPage = data.count ? Math.max(1, Math.ceil(data.count / this.pageSize)) : 1;

                    // Compteurs par statut (appelle l’endpoint stats si dispo)
                    try {
                        const stats = await this.apiCall('/dashboard/recruitment_stats/');
                        const byStatus = stats.applications_by_status || {};
                        // on convertit pour chips (on garde simple: on affiche total par chip quand possible)
                        this.counts = {
                            all: stats.total_recruitments || this.total,
                            OPEN: 0, IN_REVIEW: 0, INTERVIEW: 0, OFFER: 0, CLOSED: 0, DRAFT: 0
                        };
                        // Comptage rapide depuis la page courante
                        for (const r of (data.results || data)) {
                            if (this.counts[r.status] !== undefined) this.counts[r.status]++;
                        }
                    } catch { /* silencieux */
                    }

                } catch (e) {
                    console.error(e);
                    this.toast('Impossible de charger les recrutements', 'error');
                } finally {
                    this.loading = false;
                }
            },

            async fetchRefs() {
                try {
                    const d = await this.apiCall('/departments/');
                    this.departments = d.results || d;
                } catch {
                }
                try {
                    const p = await this.apiCall('/positions/');
                    this.positions = p.results || p;
                } catch {
                }
            },

            // --- CRUD --- //
            openCreate() {
                this.editId = null;
                this.errors = {};
                this.form = {
                    title: '', reference: '', department: '', position: '',
                    job_description: '', contract_type: 'CDI', number_of_positions: 1,
                    salary_min: null, salary_max: null, remote_allowed: false,
                    ai_scoring_enabled: true, minimum_ai_score: 60, ai_scoring_criteria: {}
                };
                this.aiCriteriaText = '{\n  "skills": { "weight": 0.6 },\n  "experience": { "weight": 0.3 },\n  "education": { "weight": 0.1 }\n}';
                this.showForm = true;
            },

            openEdit(rec) {
                this.editId = rec.id;
                this.errors = {};
                this.form = {
                    title: rec.title || '',
                    reference: rec.reference || '',
                    department: rec.department || rec.department_id || rec.department?.id || '',
                    position: rec.position || rec.position_id || rec.position?.id || '',
                    job_description: rec.job_description || '',
                    contract_type: rec.contract_type || 'CDI',
                    number_of_positions: rec.number_of_positions || 1,
                    salary_min: rec.salary_min ?? null,
                    salary_max: rec.salary_max ?? null,
                    remote_allowed: !!rec.remote_allowed,
                    ai_scoring_enabled: !!rec.ai_scoring_enabled,
                    minimum_ai_score: Number(rec.minimum_ai_score ?? 60),
                    ai_scoring_criteria: rec.ai_scoring_criteria || {}
                };
                this.aiCriteriaText = JSON.stringify(this.form.ai_scoring_criteria || {}, null, 2);
                this.showForm = true;
            },

            closeForm() {
                this.showForm = false;
                this.editId = null;
            },

            validateJSON(field) {
                try {
                    JSON.parse(this[field]);
                    this.errors.ai_scoring_criteria = '';
                    return true;
                } catch {
                    this.errors.ai_scoring_criteria = 'JSON invalide';
                    return false;
                }
            },

            async submitForm() {
                this.submitting = true;
                this.errors = {};

                // Validation locale rapide
                if (!this.form.title) this.errors.title = 'Requis';
                if (!this.form.reference) this.errors.reference = 'Requis';
                if (!this.form.department) this.errors.department = 'Requis';
                if (!this.form.position) this.errors.position = 'Requis';
                if (!this.validateJSON('aiCriteriaText')) {
                    this.submitting = false;
                    return;
                }

                try {
                    const payload = {...this.form, ai_scoring_criteria: JSON.parse(this.aiCriteriaText)};
                    if (this.editId) {
                        await this.apiCall(`/recruitments/${this.editId}/`, {
                            method: 'PATCH',
                            body: JSON.stringify(payload)
                        });
                        this.toast('Recrutement mis à jour', 'success');
                    } else {
                        await this.apiCall('/recruitments/', {method: 'POST', body: JSON.stringify(payload)});
                        this.toast('Recrutement créé', 'success');
                    }
                    this.showForm = false;
                    this.fetchRecruitments();
                } catch (e) {
                    this.toast('Erreur lors de l’enregistrement', 'error');
                } finally {
                    this.submitting = false;
                }
            },

            confirmDelete(rec) {
                this.toDelete = rec;
                this.confirming = true;
            },

            async doDelete() {
                try {
                    const id = this.toDelete.id;               // sauvegarder l'id avant
                    await this.apiCall(`/recruitments/${id}/`, {method: 'DELETE'});
                    this.toast('Recrutement supprimé', 'success');
                    this.confirming = false;
                    this.toDelete = null;

                    // Optimistic local
                    this.recruitments = this.recruitments.filter(r => r.id !== id);

                    // Et on recharge éventuellement la page courante
                    this.fetchRecruitments();
                } catch {
                    this.toast('Suppression impossible', 'error');
                }
            }

            async publish(id) {
                try {
                    await this.apiCall(`/recruitments/${id}/publish/`, {method: 'POST'});
                    this.toast('Recrutement publié', 'success');
                    this.fetchRecruitments();
                } catch {
                    this.toast('Publication impossible', 'error');
                }
            },

            async closeRec(id) {
                try {
                    await this.apiCall(`/recruitments/${id}/close/`, {method: 'POST'});
                    this.toast('Recrutement clôturé', 'success');
                    this.fetchRecruitments();
                } catch {
                    this.toast('Clôture impossible', 'error');
                }
            },

            async openDetail(id) {
                try {
                    this.detail = await this.apiCall(`/recruitments/${id}/`);
                    this.showDetail = true;
                    const apps = await this.apiCall(`/applications/?recruitment=${id}`);
                    this.detailApps = apps.results || apps;
                } catch {
                    this.toast('Erreur lors du chargement du détail', 'error');
                }
            },

            async analyzeAI(appId) {
                try {
                    await this.apiCall(`/applications/${appId}/process_ai/`, {method: 'POST'});
                    this.toast('Analyse IA lancée', 'success');
                    if (this.detail?.id) this.openDetail(this.detail.id);
                } catch {
                    this.toast('Analyse IA impossible', 'error');
                }
            },

            // Pagination
            paginationText() {
                if (!this.total) return '—';
                const start = (this.page - 1) * this.pageSize + 1;
                const end = Math.min(this.page * this.pageSize, this.total);
                return `Résultats ${start}–${end} sur ${this.total}`;
            },
            nextPage() {
                if (this.page < this.maxPage) {
                    this.page++;
                    this.fetchRecruitments();
                }
            },
            prevPage() {
                if (this.page > 1) {
                    this.page--;
                    this.fetchRecruitments();
                }
            },

            // Mappings
            statusLabel(s) {
                const m = {
                    DRAFT: 'Brouillon',
                    OPEN: 'Ouvert',
                    IN_REVIEW: 'En revue',
                    INTERVIEW: 'Entretiens',
                    OFFER: 'Offre',
                    CLOSED: 'Clôturé',
                    CANCELLED: 'Annulé'
                };
                return m[s] || s || '—';
            },
            statusClass(s) {
                const map = {
                    DRAFT: 'bg-gray-100 text-gray-800',
                    OPEN: 'bg-green-100 text-green-700',
                    IN_REVIEW: 'bg-yellow-100 text-yellow-700',
                    INTERVIEW: 'bg-blue-100 text-blue-700',
                    OFFER: 'bg-purple-100 text-purple-700',
                    CLOSED: 'bg-red-100 text-red-700',
                    CANCELLED: 'bg-gray-200 text-gray-500'
                };
                return map[s] || 'bg-gray-100 text-gray-800';
            },
            appStatusClass(s) {
                const map = {
                    APPLIED: 'bg-blue-100 text-blue-800',
                    AI_SCREENED: 'bg-green-100 text-green-800',
                    AI_REJECTED: 'bg-red-100 text-red-800',
                    HR_REVIEW: 'bg-yellow-100 text-yellow-800',
                    SHORTLISTED: 'bg-purple-100 text-purple-800',
                    INTERVIEW_1: 'bg-indigo-100 text-indigo-800',
                    HIRED: 'bg-green-100 text-green-800'
                };
                return map[s] || 'bg-gray-100 text-gray-800';
            },

            // Utils
            toast(msg, type = 'info') {
                // essaie d’utiliser le toast global si présent
                if (window.dispatchEvent) {
                    window.dispatchEvent(new CustomEvent('toast', {detail: {msg, type}}));
                }
                console.log(`[${type}] ${msg}`);
            },
            formatDate(d) {
                if (!d) return '';
                return new Date(d).toLocaleDateString('fr-FR');
            },

            // Init
            async init() {
                await this.fetchRefs();
                await this.fetchRecruitments();
            }
        };
    }
</script>

<style>
    /* skeleton util (aligné avec ta base) */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @keyframes loading {
        0% {
            background-position: 200% 0
        }
        100% {
            background-position: -200% 0
        }
    }
</style>