<!-- Lyneerp/hr/templates/hr/partials/attendance.html -->
<div class="space-y-8" x-data="attendanceView()" x-init="init()">
  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <div class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-slate-900 text-white text-xs font-medium mb-2">
        <i class="fas fa-business-time text-[11px]"></i>
        <span>Ressources humaines • Pointage</span>
      </div>
      <h3 class="text-2xl font-semibold text-slate-900 tracking-tight">Pointage & présences</h3>
      <p class="text-sm text-slate-500 mt-1">
        Vue mensuelle en grille, édition rapide des pointages et export des données.
      </p>
    </div>
    <div class="flex flex-wrap gap-2">
      <button
        @click="showBulkCheckIn = true"
        class="inline-flex items-center gap-2 bg-emerald-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:bg-emerald-700">
        <i class="fas fa-users text-[13px]"></i>
        <span>Pointage collectif</span>
      </button>
      <button
        @click="exportCSV"
        class="inline-flex items-center gap-2 bg-slate-900 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:bg-slate-800">
        <i class="fas fa-download text-[13px]"></i>
        <span>Exporter CSV</span>
      </button>
    </div>
  </div>

  <!-- Filtres + sélecteur de période -->
  <div class="bg-white border border-gray-100 rounded-3xl shadow-sm p-5">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
      <!-- Période -->
      <div class="flex flex-wrap items-center gap-2">
        <button
          @click="prevMonth()"
          class="p-2 rounded-full border border-gray-200 bg-white text-slate-700 hover:bg-gray-50 inline-flex items-center justify-center">
          <i class="fas fa-chevron-left text-xs"></i>
        </button>

        <div class="flex items-center gap-2">
          <select
            x-model.number="selectedMonth"
            @change="reload()"
            class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <template x-for="m in months" :key="m.value">
              <option :value="m.value" x-text="m.label"></option>
            </template>
          </select>
          <select
            x-model.number="selectedYear"
            @change="reload()"
            class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
            <template x-for="y in years" :key="y">
              <option :value="y" x-text="y"></option>
            </template>
          </select>
        </div>

        <button
          @click="goToday()"
          class="px-3 py-2 rounded-full border border-gray-200 bg-white text-xs font-medium text-slate-700 hover:bg-gray-50">
          Aujourd’hui
        </button>

        <button
          @click="nextMonth()"
          class="p-2 rounded-full border border-gray-200 bg-white text-slate-700 hover:bg-gray-50 inline-flex items-center justify-center">
          <i class="fas fa-chevron-right text-xs"></i>
        </button>
      </div>

      <!-- Filtres -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 w-full lg:w-auto">
        <div class="relative">
          <input
            type="text"
            placeholder="Rechercher (nom, matricule)…"
            class="w-full pl-9 pr-3 py-2.5 rounded-full border border-gray-200 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300"
            x-model="search"
            @input.debounce.350ms="applyFilters()">
          <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
        </div>

        <select
          x-model="filterDept"
          @change="applyFilters()"
          class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          <option value="">Tous les départements</option>
          <template x-for="d in departments" :key="d.id">
            <option :value="d.id" x-text="d.name"></option>
          </template>
        </select>

        <select
          x-model="filterActive"
          @change="applyFilters()"
          class="rounded-full border border-gray-200 px-3 py-2.5 text-sm text-slate-700 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-100 focus:border-slate-300">
          <option value="">Actif + Inactif</option>
          <option value="true">Actif</option>
          <option value="false">Inactif</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
    <div class="p-5 bg-white border border-gray-100 rounded-3xl shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center">
        <i class="fas fa-user-check text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Présents</div>
        <div class="mt-1 text-2xl font-semibold text-emerald-600 tracking-tight" x-text="attendanceStats.present"></div>
      </div>
    </div>
    <div class="p-5 bg-white border border-gray-100 rounded-3xl shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-rose-50 text-rose-600 flex items-center justify-center">
        <i class="fas fa-user-times text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Absents</div>
        <div class="mt-1 text-2xl font-semibold text-rose-600 tracking-tight" x-text="attendanceStats.absent"></div>
      </div>
    </div>
    <div class="p-5 bg-white border border-gray-100 rounded-3xl shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-amber-50 text-amber-600 flex items-center justify-center">
        <i class="fas fa-clock text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Retards</div>
        <div class="mt-1 text-2xl font-semibold text-amber-600 tracking-tight" x-text="attendanceStats.late"></div>
      </div>
    </div>
    <div class="p-5 bg-white border border-gray-100 rounded-3xl shadow-sm flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-50 text-sky-600 flex items-center justify-center">
        <i class="fas fa-business-time text-sm"></i>
      </div>
      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-slate-400">Heures supp.</div>
        <div class="mt-1 text-2xl font-semibold text-sky-600 tracking-tight" x-text="attendanceStats.overtime"></div>
      </div>
    </div>
  </div>

  <!-- Légende -->
  <div class="flex flex-wrap items-center gap-3 text-xs text-slate-600">
    <span class="inline-flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-green-500"></span>Présent
    </span>
    <span class="inline-flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-red-500"></span>Absent
    </span>
    <span class="inline-flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-yellow-500"></span>Retard
    </span>
    <span class="inline-flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-blue-500"></span>Demi-journée
    </span>
    <span class="inline-flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-purple-500"></span>Congé
    </span>
    <span class="inline-flex items-center gap-1.5">
      <span class="w-3 h-3 rounded-full bg-gray-300"></span>Aucun pointage
    </span>
    <span class="inline-flex items-center gap-1.5 ml-auto">
      <span class="px-2 py-0.5 rounded-full bg-gray-100 border border-gray-200 text-[11px]">WE</span>
      <span>Week-end</span>
    </span>
  </div>

  <!-- Calendrier -->
  <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-auto">
    <table class="min-w-full text-sm text-slate-700 relative">
      <thead class="bg-gray-50 sticky top-0 z-10">
        <tr>
          <th
            class="px-4 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase sticky left-0 bg-gray-50 shadow-[2px_0_0_rgba(148,163,184,0.18)] z-20">
            Employé
          </th>
          <template x-for="d in calendarDays" :key="d.date">
            <th
              class="px-2 py-3 text-center text-[11px] font-semibold uppercase"
              :class="d.isWeekend ? 'bg-slate-50 text-slate-400' : 'bg-gray-50 text-slate-500'">
              <div class="text-xs font-semibold" x-text="d.day"></div>
              <div class="text-[11px] text-slate-400" x-text="d.label"></div>
            </th>
          </template>
        </tr>
      </thead>
      <tbody>
        <!-- skeleton -->
        <template x-if="loading">
          <template x-for="i in 6" :key="'sk'+i">
            <tr class="border-t border-gray-100">
              <td class="px-4 py-3 sticky left-0 bg-white z-10 shadow-[2px_0_0_rgba(148,163,184,0.12)]">
                <div class="h-4 w-40 skeleton rounded"></div>
                <div class="h-3 w-28 mt-2 skeleton rounded"></div>
              </td>
              <template x-for="d in calendarDays" :key="'skd'+d.date">
                <td class="px-2 py-2">
                  <div class="h-6 w-10 mx-auto skeleton rounded-full"></div>
                </td>
              </template>
            </tr>
          </template>
        </template>

        <!-- rows -->
        <template x-for="emp in filteredEmployees" :key="emp.id">
          <tr class="border-t border-gray-100 hover:bg-gray-50/60 transition-colors">
            <!-- col employé -->
            <td
              class="px-4 py-3 sticky left-0 bg-white z-10 shadow-[2px_0_0_rgba(148,163,184,0.12)]">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-slate-900 text-white flex items-center justify-center text-xs font-semibold uppercase">
                  <span x-text="(emp.first_name?.[0] || '') + (emp.last_name?.[0] || '')"></span>
                </div>
                <div class="min-w-0">
                  <div class="text-sm font-semibold text-slate-900 truncate"
                       x-text="`${emp.first_name} ${emp.last_name}`"></div>
                  <div class="text-[11px] text-slate-500" x-text="emp.matricule"></div>
                  <div class="text-[11px] text-slate-400" x-text="emp.department_name || emp.department?.name || ''"></div>
                </div>
              </div>
            </td>

            <!-- cells jour -->
            <template x-for="d in calendarDays" :key="emp.id + '-' + d.date">
              <td
                class="relative px-2 py-2 text-center"
                :class="{
                  'bg-slate-50': d.isWeekend,
                  'ring-1 ring-slate-300 ring-offset-1 ring-offset-slate-50': d.isToday
                }">
                <template x-if="attCell(emp.id, d.date)">
                  <div class="inline-flex flex-col items-center gap-1">
                    <button
                      @click="openCellEditor(emp.id, d.date)"
                      class="text-[11px] px-2 py-1 rounded-full border border-gray-200 bg-white hover:bg-gray-50 inline-flex items-center gap-1">
                      <span x-text="attCell(emp.id, d.date).check_in || '—'"></span>
                      <span class="text-slate-300">/</span>
                      <span x-text="attCell(emp.id, d.date).check_out || '—'"></span>
                    </button>
                    <span
                      class="w-3 h-3 rounded-full"
                      :class="statusDot(attCell(emp.id, d.date).status)"></span>
                  </div>
                </template>

                <template x-if="!attCell(emp.id, d.date) && !d.isWeekend">
                  <button
                    @click="openCellEditor(emp.id, d.date)"
                    class="w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 inline-flex items-center justify-center text-[11px] text-slate-700">
                    +
                  </button>
                </template>

                <!-- Popover éditeur -->
                <div
                  x-show="isEditorOpen(emp.id, d.date)"
                  x-cloak
                  class="absolute z-30 mt-2 left-1/2 -translate-x-1/2"
                  style="min-width: 220px;">
                  <div class="p-3 bg-white border border-gray-200 rounded-2xl shadow-xl text-left">
                    <div class="flex items-center justify-between mb-2">
                      <div class="text-xs font-semibold text-slate-900" x-text="formatDate(d.date)"></div>
                      <button @click="closeEditor()" class="p-1 rounded-full hover:bg-gray-100 text-slate-400">
                        <i class="fas fa-times text-[10px]"></i>
                      </button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-2">
                      <div>
                        <label class="text-[11px] text-slate-500 mb-0.5 block">Entrée</label>
                        <input
                          type="time"
                          x-model="editor.form.check_in"
                          class="w-full border border-gray-200 rounded-xl px-2 py-1 text-xs focus:ring-1 focus:ring-slate-100 focus:border-slate-300">
                      </div>
                      <div>
                        <label class="text-[11px] text-slate-500 mb-0.5 block">Sortie</label>
                        <input
                          type="time"
                          x-model="editor.form.check_out"
                          class="w-full border border-gray-200 rounded-xl px-2 py-1 text-xs focus:ring-1 focus:ring-slate-100 focus:border-slate-300">
                      </div>
                    </div>

                    <label class="text-[11px] text-slate-500 mb-0.5 block">Statut</label>
                    <select
                      x-model="editor.form.status"
                      class="w-full border border-gray-200 rounded-xl px-2 py-1.5 text-xs mb-3 focus:ring-1 focus:ring-slate-100 focus:border-slate-300">
                      <option value="PRESENT">PRESENT</option>
                      <option value="LATE">LATE</option>
                      <option value="ABSENT">ABSENT</option>
                      <option value="HALF_DAY">HALF_DAY</option>
                      <option value="LEAVE">LEAVE</option>
                    </select>

                    <div class="flex items-center justify-end gap-2">
                      <button
                        @click="closeEditor()"
                        class="px-3 py-1 rounded-full border border-gray-200 text-[11px] text-slate-600 hover:bg-gray-50">
                        Annuler
                      </button>
                      <button
                        @click="saveCell()"
                        class="px-3 py-1 rounded-full bg-slate-900 text-white text-[11px] font-semibold hover:bg-slate-800">
                        Enregistrer
                      </button>
                    </div>
                  </div>
                </div>
              </td>
            </template>
          </tr>
        </template>

        <!-- empty -->
        <tr x-show="!loading && !filteredEmployees.length">
          <td colspan="40" class="py-14 text-center">
            <div class="inline-flex flex-col items-center justify-center px-6 py-5 rounded-3xl border border-dashed border-gray-300 bg-gray-50/70">
              <i class="fas fa-users-slash text-gray-300 text-4xl mb-2"></i>
              <div class="text-sm font-medium text-slate-900">Aucun employé à afficher</div>
              <div class="text-xs text-slate-500 mt-1">
                Ajustez les filtres pour voir les pointages correspondants.
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal Bulk -->
  <div
    x-show="showBulkCheckIn"
    x-cloak
    class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-30 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl border border-gray-100 shadow-2xl p-6 w-full max-w-2xl">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h4 class="text-base font-semibold text-slate-900">Pointage collectif</h4>
          <p class="text-xs text-slate-500 mt-0.5">
            Sélectionnez les collaborateurs concernés et définissez l’heure d’arrivée.
          </p>
        </div>
        <button @click="showBulkCheckIn=false" class="p-2 rounded-full hover:bg-gray-50 text-slate-400">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-80 overflow-y-auto border border-gray-100 rounded-2xl p-2 bg-gray-50/60">
        <template x-for="e in filteredEmployees" :key="'bulk'+e.id">
          <label class="flex items-center gap-2 px-2 py-1.5 rounded-2xl bg-white hover:bg-gray-50 text-sm cursor-pointer border border-gray-100">
            <input type="checkbox" class="rounded border-slate-300" :value="e.id" x-model="selectedEmployees">
            <span class="text-xs font-medium text-slate-800 truncate" x-text="`${e.first_name} ${e.last_name}`"></span>
            <span class="text-[11px] text-slate-400 ml-auto" x-text="e.matricule"></span>
          </label>
        </template>
      </div>
      <div class="flex flex-wrap items-center gap-3 mt-4">
        <div class="flex items-center gap-2">
          <label class="text-xs font-medium text-slate-600">Heure d’arrivée</label>
          <input
            type="time"
            x-model="bulkTime"
            class="border border-gray-200 rounded-xl px-2 py-1.5 text-xs focus:ring-1 focus:ring-slate-100 focus:border-slate-300">
        </div>
        <button
          @click="bulkCheckIn"
          class="ml-auto inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-600 text-white text-xs font-semibold hover:bg-emerald-700">
          <i class="fas fa-check text-[11px]"></i>
          <span>Pointer l’arrivée</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function attendanceView(){
  return {
    // période
    selectedMonth: new Date().getMonth()+1,
    selectedYear: new Date().getFullYear(),
    months: [
      { value:1, label:'Janvier' },{ value:2, label:'Février' },{ value:3, label:'Mars' },
      { value:4, label:'Avril' },{ value:5, label:'Mai' },{ value:6, label:'Juin' },
      { value:7, label:'Juillet' },{ value:8, label:'Août' },{ value:9, label:'Septembre' },
      { value:10, label:'Octobre' },{ value:11, label:'Novembre' },{ value:12, label:'Décembre' }
    ],
    years: [2023, 2024, 2025, 2026],

    // data
    loading: false,
    calendarDays: [],
    attendances: [],
    attendanceStats: { present:0, absent:0, late:0, overtime:'0.0' },

    // référentiels/shared
    employees: [],
    departments: [],
    filteredEmployees: [],
    filterDept: '',
    filterActive: '',
    search: '',

    // bulk
    showBulkCheckIn:false,
    selectedEmployees: [],
    bulkTime: new Date().toTimeString().slice(0,5),

    // editor popover
    editor: { open:false, empId:null, date:null, form:{ check_in:'', check_out:'', status:'PRESENT' } },

    formatDate(d){ return new Date(d).toLocaleDateString('fr-FR'); },
    statusDot(s){
      return {
        'PRESENT':'bg-green-500',
        'ABSENT':'bg-red-500',
        'LATE':'bg-yellow-500',
        'HALF_DAY':'bg-blue-500',
        'LEAVE':'bg-purple-500'
      }[s] || 'bg-gray-300';
    },
    popoverPos(ev){ return 'transform:translateX(-50%);'; },

    buildDays(){
      const out=[]; const d=new Date(this.selectedYear, this.selectedMonth-1, 1);
      const todayISO = new Date().toISOString().slice(0,10);
      while(d.getMonth()===this.selectedMonth-1){
        const iso = d.toISOString().slice(0,10);
        out.push({
          date: iso,
          day: String(d.getDate()).padStart(2,'0'),
          label: ['Di','Lu','Ma','Me','Je','Ve','Sa'][d.getDay()],
          isWeekend: d.getDay()===0||d.getDay()===6,
          isToday: iso===todayISO
        });
        d.setDate(d.getDate()+1);
      }
      this.calendarDays = out;
    },

    attCell(empId, isoDate){
      return this.attendances.find(a => a.employee===empId && a.date===isoDate) || null;
    },

    openCellEditor(empId, isoDate){
      const existing = this.attCell(empId, isoDate);
      this.editor.open = true;
      this.editor.empId = empId;
      this.editor.date = isoDate;
      this.editor.form = {
        check_in: existing?.check_in || '',
        check_out: existing?.check_out || '',
        status: existing?.status || 'PRESENT'
      };
    },
    closeEditor(){
      this.editor = { open:false, empId:null, date:null, form:{check_in:'',check_out:'',status:'PRESENT'} };
    },
    isEditorOpen(empId, isoDate){
      return this.editor.open && this.editor.empId===empId && this.editor.date===isoDate;
    },

    async saveCell(){
      try{
        const existing = this.attCell(this.editor.empId, this.editor.date);
        const payload = {
          employee: this.editor.empId,
          date: this.editor.date,
          ...this.editor.form
        };
        if (existing){
          await this.apiCall(`/attendances/${existing.id}/`, { method:'PATCH', body: JSON.stringify(payload) });
        } else {
          await this.apiCall(`/attendances/`, { method:'POST', body: JSON.stringify(payload) });
        }
        await this.loadAttendances();
        this.closeEditor();
      }catch(e){ this.toast('Enregistrement impossible','error'); }
    },

    exportCSV(){
      const cols = ['matricule','nom','prenom','date','check_in','check_out','status'];
      const rows = [];
      for(const a of this.attendances){
        const emp = this.employees.find(e=>e.id===a.employee);
        rows.push([
          emp?.matricule||'',
          (emp?.last_name||'').replaceAll(';',','),
          (emp?.first_name||'').replaceAll(';',','),
          a.date,
          a.check_in||'',
          a.check_out||'',
          a.status||''
        ]);
      }
      const csv = [cols.join(';'), ...rows.map(r=>r.join(';'))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `attendance_${this.selectedYear}-${String(this.selectedMonth).padStart(2,'0')}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      this.toast('Export CSV généré','success');
    },

    async apiCall(path, options={}){
      const headers = { 'X-Tenant-Id': Conf.tenantId, 'Content-Type':'application/json' };
      if (Conf.token) headers['Authorization'] = `Bearer ${Conf.token}`;
      const res = await fetch(`${Conf.apiBase}${path.startsWith('/')?'':'/'}${path}`, { ...options, headers });
      if(!res.ok){
        let detail=''; try{ const j=await res.json(); detail=j.detail||j.error||''; }catch{}
        throw new Error(`${res.status} ${res.statusText}${detail?' - '+detail:''}`);
      }
      return res.status===204 ? null : res.json();
    },

    async loadRefs(){
      try{ const d=await this.apiCall('/departments/'); this.departments=d.results||d; }catch{}
      if (!this.employees?.length){
        try{
          const e=await this.apiCall('/employees/?page_size=1000&ordering=last_name');
          this.employees = e.results || e;
        }catch{}
      }
      this.applyFilters();
    },

    async loadAttendances(){
      this.loading = true;
      try{
        const data = await this.apiCall(`/attendances/?month=${this.selectedMonth}&year=${this.selectedYear}`);
        this.attendances = data.results || data;
        this.computeStats();
      }catch(e){ this.toast('Chargement du pointage impossible','error'); }
      finally{ this.loading=false; }
    },

    computeStats(){
      const p = this.attendances.filter(a=>a.status==='PRESENT').length;
      const a = this.attendances.filter(a=>a.status==='ABSENT').length;
      const l = this.attendances.filter(a=>a.status==='LATE').length;
      const ot = (this.attendances || []).reduce((s,x)=>s+(x.overtime_hours||0),0);
      this.attendanceStats = { present:p, absent:a, late:l, overtime: ot.toFixed(1) };
    },

    applyFilters(){
      const s = (this.search||'').toLowerCase().trim();
      this.filteredEmployees = (this.employees||[]).filter(e=>{
        const okDept = this.filterDept ? (e.department===this.filterDept || e.department_id===this.filterDept) : true;
        const okAct = this.filterActive==='' ? true : (String(!!e.is_active)===this.filterActive);
        const okText = !s || [e.first_name,e.last_name,e.matricule].filter(Boolean).join(' ').toLowerCase().includes(s);
        return okDept && okAct && okText;
      });
    },

    async bulkCheckIn(){
      if(!this.selectedEmployees.length){
        this.toast('Sélectionnez au moins un employé','warning');
        return;
      }
      try{
        await this.apiCall('/attendances/bulk_check_in/', {
          method:'POST',
          body: JSON.stringify({ employee_ids: this.selectedEmployees, time: this.bulkTime })
        });
        this.toast('Pointage collectif effectué','success');
        this.showBulkCheckIn=false; this.selectedEmployees=[];
        this.loadAttendances();
      }catch{ this.toast('Erreur pointage collectif','error'); }
    },

    reload(){ this.buildDays(); this.loadAttendances(); },
    prevMonth(){
      if(this.selectedMonth===1){ this.selectedMonth=12; this.selectedYear--; }
      else this.selectedMonth--;
      this.reload();
    },
    nextMonth(){
      if(this.selectedMonth===12){ this.selectedMonth=1; this.selectedYear++; }
      else this.selectedMonth++;
      this.reload();
    },
    goToday(){
      const t=new Date();
      this.selectedMonth=t.getMonth()+1;
      this.selectedYear=t.getFullYear();
      this.reload();
    },

    toast(msg,type='info'){
      if(window.dispatchEvent){
        window.dispatchEvent(new CustomEvent('toast',{detail:{msg,type}}));
      }
      console.log(`[${type}]`,msg);
    },

    async init(){
      this.buildDays();
      await this.loadRefs();
      await this.loadAttendances();
    }
  };
}
</script>

<style>
.skeleton{
  background:linear-gradient(90deg,#e5e7eb 25%,#f3f4f6 50%,#e5e7eb 75%);
  background-size:200% 100%;
  animation:loading 1.3s infinite;
}
@keyframes loading{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}
</style>