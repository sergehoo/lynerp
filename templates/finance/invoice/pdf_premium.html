{% load humanize %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Facture {{ invoice.number }}</title>
</head>
<body>

<!-- =========================
     HEADER (running element)
========================= -->
<header>
  <div class="brandline"></div>
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; padding:10px 0 8px;">
    <div style="min-width:0;">
      <div style="display:flex; align-items:center; gap:10px;">
        {% if tenant.logo_url %}
          <img class="logo" src="{{ tenant.logo_url.url }}" alt="Logo">
        {% endif %}
        <div style="min-width:0;">
          <div class="h2" style="font-size:13px;">{{ tenant.display_legal_name|default:tenant.name }}</div>
          <div class="tiny muted">
            {% if tenant.legal_form %}{{ tenant.legal_form }}{% endif %}
            {% if tenant.registration_number %} • RCCM: {{ tenant.registration_number }}{% endif %}
            {% if tenant.tax_id %} • NIF/TVA: {{ tenant.tax_id }}{% endif %}
          </div>
          <div class="tiny muted">{{ tenant.display_address }}</div>
          <div class="tiny muted">
            {% if tenant.contact_phone %}{{ tenant.contact_phone }}{% endif %}
            {% if tenant.contact_email %}{% if tenant.contact_phone %} • {% endif %}{{ tenant.contact_email }}{% endif %}
            {% if tenant.website %}{% if tenant.contact_email or tenant.contact_phone %} • {% endif %}{{ tenant.website }}{% endif %}
          </div>
        </div>
      </div>
    </div>

    <div style="text-align:right;">
      <div class="badge">{{ invoice.get_status_display }}</div>
      <div class="tiny muted" style="margin-top:6px;">Généré: {{ generated_at|date:"d/m/Y H:i" }}</div>
      <div class="tiny muted">Devise: {{ invoice.currency }}</div>
    </div>
  </div>
  <div class="hr"></div>
</header>

<!-- =========================
     FOOTER (running element)
========================= -->
<footer>
  <div class="footerline tiny muted">
    <div style="min-width:0;">
      {% if tenant.invoice_footer_note %}
        {{ tenant.invoice_footer_note }}
      {% else %}
        Document généré par {{ tenant.name }} • Conservez ce document pour vos archives.
      {% endif %}
    </div>
    <div class="nowrap">
      Page <span class="pageNumber"></span> / <span class="totalPages"></span>
    </div>
  </div>

  <!-- WeasyPrint page counters -->
  <style>
    .pageNumber:before { content: counter(page); }
    .totalPages:before { content: counter(pages); }
  </style>
</footer>

<!-- =========================
     CONTENT
========================= -->

<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; margin-top:6px;">
  <div class="card" style="flex:1;">
    <div class="h1">FACTURE</div>
    <div class="muted" style="margin-top:3px;">
      <span class="tiny">N°</span> <strong>{{ invoice.number }}</strong>
      <span class="muted"> • </span>
      <span class="tiny">Type</span> <strong>{{ invoice.get_type_display }}</strong>
    </div>
    <div class="muted tiny" style="margin-top:6px;">
      Émise: <strong>{{ invoice.issue_date|date:"d/m/Y" }}</strong>
      {% if invoice.due_date %} • Échéance: <strong>{{ invoice.due_date|date:"d/m/Y" }}</strong>{% endif %}
    </div>
  </div>

  <div class="card" style="width:190px;">
    <div class="h2">Signature (QR)</div>
    <div class="tiny muted" style="margin-top:2px;">Vérifier / ouvrir</div>
    <div style="margin-top:8px; display:flex; justify-content:flex-end;">
      <img class="qrcode" src="{{ qr_img }}" alt="QR">
    </div>
    <div class="tiny muted" style="margin-top:6px; word-break:break-all;">
      {{ verify_url }}
    </div>
  </div>
</div>

<div class="row" style="margin-top:12px;">
  <div class="col card">
    <div class="h2">Client</div>
    <div style="margin-top:6px; font-weight:800;">{{ partner.name }}</div>
    <div class="tiny muted">
      {% if partner.email %}{{ partner.email }}{% endif %}
      {% if partner.phone %}{% if partner.email %} • {% endif %}{{ partner.phone }}{% endif %}
    </div>
  </div>

  <div class="col card">
    <div class="h2">Émetteur</div>
    <div style="margin-top:6px; font-weight:800;">{{ tenant.display_legal_name|default:tenant.name }}</div>
    <div class="tiny muted">
      {% if tenant.tax_id %}NIF/TVA: {{ tenant.tax_id }}{% endif %}
      {% if tenant.registration_number %}{% if tenant.tax_id %} • {% endif %}RCCM: {{ tenant.registration_number }}{% endif %}
    </div>
    <div class="tiny muted">{{ tenant.display_address }}</div>
  </div>
</div>

<div style="height:12px;"></div>

<table class="table">
  <thead>
    <tr>
      <th>Libellé</th>
      <th class="right">Qté</th>
      <th class="right">PU</th>
      <th>Taxe</th>
      <th class="right">HT</th>
      <th class="right">TVA</th>
      <th class="right">TTC</th>
    </tr>
  </thead>
  <tbody>
    {% for l in lines %}
    <tr>
      <td>
        <div style="font-weight:700;">{{ l.label }}</div>
      </td>
      <td class="right">{{ l.quantity|floatformat:2 }}</td>
      <td class="right">{{ l.unit_price|floatformat:2 }}</td>
      <td>{% if l.tax %}{{ l.tax.name }} ({{ l.tax.rate }}%){% else %}—{% endif %}</td>
      <td class="right">{{ l.line_total|floatformat:2 }}</td>
      <td class="right">{{ l.tax_amount|floatformat:2 }}</td>
      <td class="right">{{ l.line_total|add:l.tax_amount|floatformat:2 }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="7" class="muted">Aucune ligne</td></tr>
    {% endfor %}
  </tbody>
</table>

<div style="display:flex; justify-content:flex-end; margin-top:12px;">
  <div style="width:340px;" class="totalbox">
    <div style="display:flex; justify-content:space-between; padding:6px 0;">
      <div class="muted">Sous-total (HT)</div>
      <div><strong>{{ subtotal|floatformat:2 }}</strong></div>
    </div>
    <div style="display:flex; justify-content:space-between; padding:6px 0;">
      <div class="muted">TVA</div>
      <div><strong>{{ tax|floatformat:2 }}</strong></div>
    </div>
    <div class="hr"></div>
    <div style="display:flex; justify-content:space-between; padding:6px 0; font-size:14px;">
      <div><strong>Total TTC</strong></div>
      <div><strong>{{ total|floatformat:2 }}</strong></div>
    </div>

    <div style="margin-top:8px; font-size:12px;">
      <div style="display:flex; justify-content:space-between; padding:4px 0;">
        <div class="muted">Payé</div>
        <div>{{ amount_paid|floatformat:2 }}</div>
      </div>
      <div style="display:flex; justify-content:space-between; padding:4px 0;">
        <div class="muted">Reste dû</div>
        <div><strong>{{ amount_due|floatformat:2 }}</strong></div>
      </div>
    </div>
  </div>
</div>

{% if invoice.notes %}
<div class="card" style="margin-top:12px;">
  <div class="h2">Notes</div>
  <div style="margin-top:6px; white-space:pre-line;">{{ invoice.notes }}</div>
</div>
{% endif %}

<!-- Optionnel: empreinte/signature technique (tiny) -->
<div class="tiny muted" style="margin-top:10px; word-break:break-all;">
  Signature: {{ signature_payload }}
</div>

</body>
</html>