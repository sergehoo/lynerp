{% load humanize %}
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Facture {{ invoice.number }}</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap');

  :root {
    --ink: #0D0D0D;
    --ink-muted: #555555;
    --ink-faint: #999999;
    --paper: #FAFAF8;
    --accent: #B8860B;
    --accent-light: #F5EDD6;
    --border: #E0DDD5;
    --border-strong: #C8C4BB;
    --red: #C0392B;
    --green: #1A6B3C;
    --white: #FFFFFF;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 210mm;
    min-height: 297mm;
    background: var(--paper);
    font-family: 'DM Sans', sans-serif;
    font-size: 9pt;
    color: var(--ink);
    line-height: 1.5;
  }

  .page {
    width: 210mm;
    min-height: 297mm;
    padding: 0;
    display: flex;
    flex-direction: column;
    background: var(--white);
    position: relative;
  }

  /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .header {
    background: var(--ink);
    color: var(--white);
    padding: 28px 32px 22px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 24px;
    align-items: start;
  }

  .header-brand {}

  .logo-wrap {
    margin-bottom: 10px;
  }
  .logo-wrap img {
    max-height: 44px;
    max-width: 160px;
    object-fit: contain;
    filter: brightness(0) invert(1);
  }

  .company-name {
    font-family: 'Playfair Display', serif;
    font-size: 17pt;
    font-weight: 700;
    letter-spacing: 0.02em;
    line-height: 1.1;
    color: var(--white);
  }

  .company-meta {
    margin-top: 4px;
    font-size: 7.5pt;
    color: rgba(255,255,255,0.6);
    font-weight: 300;
  }

  .company-meta span + span::before {
    content: ' â€¢ ';
    opacity: 0.5;
  }

  .company-contact {
    margin-top: 6px;
    font-size: 7.5pt;
    color: rgba(255,255,255,0.65);
    font-weight: 300;
  }

  .company-contact span + span::before {
    content: ' â€¢ ';
    opacity: 0.5;
  }

  .header-doc {
    text-align: right;
  }

  .doc-badge {
    display: inline-block;
    background: var(--accent);
    color: var(--white);
    font-family: 'Playfair Display', serif;
    font-size: 11pt;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 6px 14px 5px;
    border-radius: 2px;
    margin-bottom: 10px;
  }

  .doc-number {
    font-size: 9pt;
    font-weight: 600;
    color: rgba(255,255,255,0.9);
    letter-spacing: 0.04em;
  }

  .doc-type {
    font-size: 7.5pt;
    color: rgba(255,255,255,0.5);
    margin-top: 2px;
    font-weight: 300;
  }

  .doc-dates {
    margin-top: 8px;
    font-size: 7.5pt;
    color: rgba(255,255,255,0.6);
    font-weight: 300;
  }

  .doc-dates .label {
    text-transform: uppercase;
    font-size: 6pt;
    letter-spacing: 0.1em;
    opacity: 0.6;
    display: block;
  }

  .doc-dates .value {
    font-weight: 500;
    color: rgba(255,255,255,0.9);
  }

  .status-pill {
    display: inline-block;
    margin-top: 8px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 7pt;
    font-weight: 600;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    background: rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.85);
    border: 1px solid rgba(255,255,255,0.2);
  }

  /* â”€â”€ GOLD RULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .gold-rule {
    height: 3px;
    background: linear-gradient(90deg, var(--accent) 0%, #E8C85A 50%, var(--accent) 100%);
  }

  /* â”€â”€ SUBHEADER: Client + Emetteur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .parties {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    border-bottom: 1px solid var(--border);
  }

  .party {
    padding: 18px 32px 16px;
    position: relative;
  }

  .party:first-child {
    border-right: 1px solid var(--border);
  }

  .party-label {
    font-size: 6.5pt;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .party-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--accent-light);
  }

  .party-name {
    font-family: 'Playfair Display', serif;
    font-size: 11pt;
    font-weight: 600;
    color: var(--ink);
    margin-bottom: 3px;
  }

  .party-detail {
    font-size: 7.5pt;
    color: var(--ink-muted);
    line-height: 1.6;
  }

  /* â”€â”€ META BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .meta-bar {
    background: var(--accent-light);
    padding: 8px 32px;
    display: flex;
    gap: 32px;
    align-items: center;
    border-bottom: 1px solid #E8D8A8;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .meta-item .label {
    font-size: 6pt;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent);
    font-weight: 600;
  }

  .meta-item .value {
    font-size: 8pt;
    font-weight: 600;
    color: var(--ink);
  }

  /* â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrap {
    padding: 20px 32px 0;
    flex: 1;
  }

  .invoice-table {
    width: 100%;
    border-collapse: collapse;
  }

  .invoice-table thead tr {
    border-bottom: 2px solid var(--ink);
  }

  .invoice-table thead th {
    font-size: 6.5pt;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--ink-muted);
    padding: 0 6px 8px 6px;
    text-align: right;
  }

  .invoice-table thead th:first-child {
    text-align: left;
    padding-left: 0;
  }

  .invoice-table tbody tr {
    border-bottom: 1px solid var(--border);
  }

  .invoice-table tbody tr:last-child {
    border-bottom: none;
  }

  .invoice-table tbody td {
    padding: 9px 6px;
    font-size: 8.5pt;
    text-align: right;
    color: var(--ink);
    vertical-align: top;
  }

  .invoice-table tbody td:first-child {
    text-align: left;
    padding-left: 0;
    font-weight: 500;
  }

  .invoice-table tbody td.muted {
    color: var(--ink-muted);
    font-size: 8pt;
  }

  .empty-row td {
    text-align: center !important;
    padding: 24px 0 !important;
    color: var(--ink-faint);
    font-style: italic;
  }

  /* â”€â”€ TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .totals-wrap {
    padding: 0 32px 20px;
    display: flex;
    justify-content: flex-end;
  }

  .totals-box {
    width: 230px;
    margin-top: 4px;
  }

  .totals-line {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 8.5pt;
    border-bottom: 1px solid var(--border);
  }

  .totals-line:last-child {
    border-bottom: none;
  }

  .totals-line .label {
    color: var(--ink-muted);
  }

  .totals-line .amount {
    font-weight: 500;
  }

  .totals-line.grand {
    border-top: 2px solid var(--ink);
    border-bottom: none;
    padding-top: 8px;
    margin-top: 2px;
  }

  .totals-line.grand .label {
    font-family: 'Playfair Display', serif;
    font-size: 10pt;
    font-weight: 700;
    color: var(--ink);
  }

  .totals-line.grand .amount {
    font-family: 'Playfair Display', serif;
    font-size: 12pt;
    font-weight: 700;
    color: var(--ink);
  }

  .totals-line.paid .amount { color: var(--green); }
  .totals-line.due .label, .totals-line.due .amount { color: var(--red); font-weight: 700; }

  /* â”€â”€ NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .notes-wrap {
    margin: 0 32px 20px;
    padding: 12px 16px;
    background: #F7F5F0;
    border-left: 3px solid var(--accent);
    border-radius: 0 3px 3px 0;
  }

  .notes-label {
    font-size: 6.5pt;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .notes-text {
    font-size: 8pt;
    color: var(--ink-muted);
    line-height: 1.6;
  }

  /* â”€â”€ SIGNATURE / QR BLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .verification-section {
    margin: 0 32px 24px;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 24px;
    align-items: start;
    padding: 16px 20px;
    border: 1px solid var(--border);
    border-top: 2px solid var(--accent);
    border-radius: 0 0 4px 4px;
    background: #FDFCFA;
  }

  .qr-block {
    text-align: center;
  }

  .qr-placeholder {
    width: 72px;
    height: 72px;
    border: 1.5px solid var(--border-strong);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--white);
    overflow: hidden;
  }

  .qr-placeholder img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .qr-caption {
    font-size: 6.5pt;
    color: var(--ink-faint);
    margin-top: 4px;
    text-align: center;
  }

  .signature-block {
    font-size: 7.5pt;
    color: var(--ink-muted);
    line-height: 1.6;
  }

  .sig-label {
    font-size: 6.5pt;
    font-weight: 700;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .sig-url {
    margin-top: 5px;
    font-size: 7pt;
    word-break: break-all;
    color: var(--ink-faint);
    font-weight: 300;
  }

  .sig-hash {
    margin-top: 4px;
    font-size: 6.5pt;
    font-family: 'Courier New', monospace;
    color: var(--ink-faint);
    word-break: break-all;
  }

  /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .footer {
    background: var(--ink);
    color: rgba(255,255,255,0.5);
    padding: 10px 32px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 7pt;
    font-weight: 300;
    margin-top: auto;
  }

  .footer-note {
    flex: 1;
    padding-right: 20px;
  }

  .footer-meta {
    text-align: right;
    white-space: nowrap;
  }

  .footer-meta .gen-date {
    display: block;
    color: rgba(255,255,255,0.35);
    font-size: 6.5pt;
    margin-top: 2px;
  }

  .page-count {
    color: rgba(255,255,255,0.35);
    font-size: 6.5pt;
    margin-top: 2px;
  }

  /* â”€â”€ PRINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media print {
    html, body { background: white; }
    .page { box-shadow: none; }
  }
</style>
</head>
<body>
<div class="page">

  <!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="header">
    <div class="header-brand">
      {% if tenant.logo_url %}
      <div class="logo-wrap">
        <img src="{{ tenant.logo_url }}" alt="{{ tenant.name }}">
      </div>
          {% else  %}
          <div class="logo-wrap">
        <img src="https://afriqconsulting.com/afriq-consulting/assets/img/logo/logo-web-2.png">
      </div>
      {% endif %}
      <div class="company-name">{{ tenant.display_legal_name|default:tenant.name }}</div>
      <div class="company-meta">
        {% if tenant.legal_form %}<span>{{ tenant.legal_form }}</span>{% endif %}
        {% if tenant.registration_number %}<span>RCCM: {{ tenant.registration_number }}</span>{% endif %}
        {% if tenant.tax_id %}<span>NIF/TVA: {{ tenant.tax_id }}</span>{% endif %}
      </div>
      <div class="company-meta" style="margin-top:3px;">{{ tenant.display_address }}</div>
      <div class="company-contact">
        {% if tenant.contact_phone %}<span>{{ tenant.contact_phone }}</span>{% endif %}
        {% if tenant.contact_email %}<span>{{ tenant.contact_email }}</span>{% endif %}
        {% if tenant.website %}<span>{{ tenant.website }}</span>{% endif %}
      </div>
    </div>

    <div class="header-doc">
      <div class="doc-badge">Facture</div>
      <div class="doc-number">NÂ° {{ invoice.number }}</div>
      <div class="doc-type">{{ invoice.get_type_display }}</div>
      <div class="doc-dates" style="margin-top:10px;">
        <span class="label">Ã‰mission</span>
        <span class="value">{{ invoice.issue_date|date:"d/m/Y" }}</span>
      </div>
      {% if invoice.due_date %}
      <div class="doc-dates" style="margin-top:4px;">
        <span class="label">Ã‰chÃ©ance</span>
        <span class="value">{{ invoice.due_date|date:"d/m/Y" }}</span>
      </div>
      {% endif %}
      <div><span class="status-pill">{{ invoice.get_status_display }}</span></div>
    </div>
  </header>

  <div class="gold-rule"></div>

  <!-- â•â• PARTIES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="parties">
    <div class="party">
      <div class="party-label">Client</div>
      <div class="party-name">{{ partner.name }}</div>
      <div class="party-detail">
        {% if partner.email %}{{ partner.email }}{% endif %}
        {% if partner.phone %}{% if partner.email %} â€¢ {% endif %}{{ partner.phone }}{% endif %}
      </div>
    </div>
    <div class="party">
      <div class="party-label">Ã‰metteur</div>
      <div class="party-name">{{ tenant.display_legal_name|default:tenant.name }}</div>
      <div class="party-detail">
        {% if tenant.tax_id %}NIF/TVA: {{ tenant.tax_id }}{% endif %}
        {% if tenant.registration_number %}{% if tenant.tax_id %} â€¢ {% endif %}RCCM: {{ tenant.registration_number }}{% endif %}
      </div>
      <div class="party-detail">{{ tenant.display_address }}</div>
    </div>
  </div>

  <!-- â•â• META BAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="meta-bar">
    <div class="meta-item">
      <span class="label">Devise</span>
      <span class="value">{{ invoice.currency }}</span>
    </div>
    <div class="meta-item">
      <span class="label">GÃ©nÃ©rÃ© le</span>
      <span class="value">{{ generated_at|date:"d/m/Y H:i" }}</span>
    </div>
    <div class="meta-item">
      <span class="label">Type</span>
      <span class="value">{{ invoice.get_type_display }}</span>
    </div>
  </div>

  <!-- â•â• TABLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="table-wrap">
    <table class="invoice-table">
      <thead>
        <tr>
          <th style="width:36%">LibellÃ©</th>
          <th style="width:7%">QtÃ©</th>
          <th style="width:10%">PU</th>
          <th style="width:10%">Taxe</th>
          <th style="width:10%">HT</th>
          <th style="width:9%">TVA</th>
          <th style="width:11%">TTC</th>
        </tr>
      </thead>
      <tbody>
        {% for l in lines %}
        <tr>
          <td>{{ l.label }}</td>
          <td class="muted">{{ l.quantity|floatformat:2 }}</td>
          <td class="muted">{{ l.unit_price|floatformat:2 }}</td>
          <td class="muted">{% if l.tax %}{{ l.tax.name }}<br><span style="font-size:7pt;opacity:0.65;">{{ l.tax.rate }}%</span>{% else %}â€”{% endif %}</td>
          <td>{{ l.line_total|floatformat:2 }}</td>
          <td class="muted">{{ l.tax_amount|floatformat:2 }}</td>
          <td style="font-weight:600;">{{ l.line_total|add:l.tax_amount|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr class="empty-row">
          <td colspan="7">Aucune ligne</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- â•â• TOTALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="totals-wrap">
    <div class="totals-box">
      <div class="totals-line">
        <span class="label">Sous-total (HT)</span>
        <span class="amount">{{ subtotal|floatformat:2 }} {{ invoice.currency }}</span>
      </div>
      <div class="totals-line">
        <span class="label">TVA</span>
        <span class="amount">{{ tax|floatformat:2 }} {{ invoice.currency }}</span>
      </div>
      <div class="totals-line grand">
        <span class="label">Total TTC</span>
        <span class="amount">{{ total|floatformat:2 }} {{ invoice.currency }}</span>
      </div>
      <div class="totals-line paid">
        <span class="label">PayÃ©</span>
        <span class="amount">{{ amount_paid|floatformat:2 }} {{ invoice.currency }}</span>
      </div>
      <div class="totals-line due">
        <span class="label">Reste dÃ»</span>
        <span class="amount">{{ amount_due|floatformat:2 }} {{ invoice.currency }}</span>
      </div>
    </div>
  </div>

  <!-- â•â• NOTES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  {% if invoice.notes %}
  <div class="notes-wrap">
    <div class="notes-label">Notes</div>
    <div class="notes-text">{{ invoice.notes }}</div>
  </div>
  {% endif %}

  <!-- â•â• VERIFICATION / QR / SIGNATURE â•â•â•â•â•â•â•â•â•â• -->
  <div class="verification-section">
    <div class="qr-block">
      <div class="qr-placeholder">
        {# Remplacer par votre image QR code gÃ©nÃ©rÃ©e dynamiquement #}
        <svg viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg" style="width:60px;height:60px;opacity:0.25;">
          <rect x="4" y="4" width="26" height="26" rx="2" stroke="#0D0D0D" stroke-width="3" fill="none"/>
          <rect x="11" y="11" width="12" height="12" fill="#0D0D0D"/>
          <rect x="42" y="4" width="26" height="26" rx="2" stroke="#0D0D0D" stroke-width="3" fill="none"/>
          <rect x="49" y="11" width="12" height="12" fill="#0D0D0D"/>
          <rect x="4" y="42" width="26" height="26" rx="2" stroke="#0D0D0D" stroke-width="3" fill="none"/>
          <rect x="11" y="49" width="12" height="12" fill="#0D0D0D"/>
          <rect x="42" y="42" width="7" height="7" fill="#0D0D0D"/>
          <rect x="54" y="42" width="7" height="7" fill="#0D0D0D"/>
          <rect x="42" y="54" width="7" height="7" fill="#0D0D0D"/>
          <rect x="54" y="54" width="14" height="14" rx="1" fill="#0D0D0D"/>
        </svg>
      </div>
      <div class="qr-caption">Scanner pour<br>vÃ©rifier</div>
    </div>

    <div class="signature-block">
      <div class="sig-label">VÃ©rification &amp; Signature numÃ©rique</div>
      <div style="margin-top:4px;font-size:8pt;color:#555;">
        Ce document est signÃ© Ã©lectroniquement. Scannez le QR code ou visitez le lien ci-dessous pour authentifier son origine et sa validitÃ©.
      </div>
      {% if verify_url %}
      <div class="sig-url">ðŸ”— {{ verify_url }}</div>
      {% endif %}
      {% if signature_payload %}
      <div style="margin-top:6px;font-size:6.5pt;color:#999;letter-spacing:0.04em;text-transform:uppercase;font-weight:600;">Empreinte</div>
      <div class="sig-hash">{{ signature_payload }}</div>
      {% endif %}
    </div>
  </div>

  <!-- â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <footer class="footer">
    <div class="footer-note">
      {% if tenant.invoice_footer_note %}
        {{ tenant.invoice_footer_note }}
      {% else %}
        Document gÃ©nÃ©rÃ© par {{ tenant.name }} â€¢ Conservez ce document pour vos archives.
      {% endif %}
    </div>
    <div class="footer-meta">
      <span>{{ invoice.currency }} â€¢ {{ invoice.get_type_display }}</span>
      <span class="gen-date">GÃ©nÃ©rÃ© le {{ generated_at|date:"d/m/Y H:i" }}</span>
      <span class="page-count">Page <span class="page-num"></span></span>
    </div>
  </footer>

</div>
</body>
</html>