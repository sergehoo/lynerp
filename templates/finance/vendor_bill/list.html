{% extends "hr/base.html" %}
{% block page_content %}

<script>
  // Base URL sûre (pas de pk factice)
  const VENDOR_BILLS_BASE_URL   = "{% url 'finance:vendor_bills:list' %}";     // ex: "/finance/vendor-bills/"
  const VENDOR_BILLS_CREATE_URL = "{% url 'finance:vendor_bills:create' %}";
</script>

<div
  x-data="genericList({
    title:'Factures fournisseurs',
    subtitle:'Achats & dépenses, échéances, paiement',
    icon:'fa-solid fa-file-invoice',
    theme:'orange',
    endpoint:'/api/finance/vendor-bills/',
    createUrl: VENDOR_BILLS_CREATE_URL,
    baseDetailUrl: VENDOR_BILLS_BASE_URL,   // ✅ au lieu de detailUrlTpl
    columns:[
      {key:'number', label:'N°', mobile:true},
      {key:'vendor', label:'Fournisseur', mobile:true},
      {key:'bill_date', label:'Date', mobile:true},
      {key:'due_date', label:'Échéance', mobile:true},
      {key:'status', label:'Statut', mobile:true},
      {key:'total', label:'Total', align:'right', mobile:true},
    ]
  })"
  x-init="init()"
  class="space-y-6"
>
  {% include "finance/shared/list_skeleton.html" %}
</div>

{# Script commun — mais on corrige goDetail pour utiliser baseDetailUrl #}
{% include "finance/shared/list_skeleton_script.html" %}

<script>
/**
 * Patch "sans exceptions" pour la navigation détail :
 {#* - ne dépend plus de detailUrlTpl "{% url ... '0' %}"#}
 * - construit l'URL detail à partir de baseDetailUrl + uuid + '/'
 *
 * IMPORTANT: ce patch suppose que list_skeleton_script.html expose genericList()
 * et qu'il utilise une méthode goDetail(row). Si le nom diffère, dis-moi le nom
 * et je te l’adapte.
 */
(function(){
  if (typeof window.genericList !== "function") return;

  const _orig = window.genericList;

  window.genericList = function(cfg){
    const api = _orig(cfg);

    const toast = (msg, type='info') => {
      if (window.hrToast) return window.hrToast(msg, type);
      console[type === 'error' ? 'error' : 'log'](msg);
    };

    const normalizeBase = (u) => (u || '').endsWith('/') ? u : (u + '/');

    // on override goDetail proprement
    api.goDetail = function(row){
      if (!row?.id){
        toast("ID manquant pour ouvrir le détail", "error");
        return;
      }
      const base = normalizeBase(cfg.baseDetailUrl || '');
      if (!base){
        toast("baseDetailUrl non configuré", "error");
        return;
      }
      window.location.assign(`${base}${row.id}/`);
    };

    // on override goCreate pour utiliser createUrl directement
    api.goCreate = function(){
      if (cfg.createUrl && cfg.createUrl !== '#') window.location.assign(cfg.createUrl);
      else toast("createUrl non configuré", "error");
    };

    return api;
  };
})();
</script>

{% endblock %}