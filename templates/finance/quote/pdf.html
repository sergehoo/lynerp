{% load humanize %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Devis {{ quote.number }}</title>

  <style>
    @page { size:A4; margin: 26mm 14mm 22mm 14mm; }
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --soft:#f1f5f9;
      --brand:#4f46e5; --ok:#16a34a;
    }
    html,body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif; color:var(--ink); font-size:11px; }
    header{ position: running(doc-header); }
    footer{ position: running(doc-footer); }
    @page{
      @top-center{ content: element(doc-header) }
      @bottom-center{ content: element(doc-footer) }
    }

    .header-bar{ display:flex; justify-content:space-between; gap:12px; border-bottom:1px solid var(--line); padding-bottom:8mm; }
    .brand{ display:flex; gap:10px; align-items:flex-start; min-width:58%; }
    .logo{ width:46px;height:46px;border-radius:12px;background:var(--soft);border:1px solid var(--line);overflow:hidden;display:flex;align-items:center;justify-content:center; }
    .logo img{ width:100%;height:100%;object-fit:contain; }
    .brand-name{ font-weight:1000; font-size:14px; }
    .brand-meta{ font-size:10px;color:var(--muted);line-height:1.35;margin-top:2px; }
    .doc{ text-align:right; }
    .doc-title{ font-size:16px;font-weight:1000;color:var(--brand);letter-spacing:.6px; }
    .doc-sub{ font-size:10px;color:var(--muted); margin-top:2px; }
    .pill{ display:inline-block;padding:3px 9px;border-radius:999px;font-size:10px;font-weight:900;background:var(--soft);border:1px solid var(--line);color:var(--ink); }

    .content{ margin-top:2mm; }
    .top-grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:10px; margin:8mm 0 5mm 0; }
    .card{ border:1px solid var(--line); border-radius:14px; padding:10px 11px; background:#fff; }
    .card h3{ margin:0 0 6px 0; font-size:10px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.6px; }
    .big{ font-size:12.5px; font-weight:900; margin:2px 0 6px 0; }
    .muted{ color:var(--muted); }
    .kv{ line-height:1.55; }

    table{ width:100%; border-collapse:collapse; margin-top:5mm; }
    thead th{ font-size:9.5px; text-transform:uppercase; letter-spacing:.55px; color:var(--muted); text-align:left; border-bottom:1px solid var(--line); padding:9px 8px; background:#fbfdff; }
    tbody td{ font-size:10.5px; padding:9px 8px; border-bottom:1px solid var(--line); vertical-align:top; }
    .right{ text-align:right; }
    .desc{ font-weight:900; }
    tr{ page-break-inside:avoid; }

    .totals{ margin-top:5mm; display:flex; justify-content:flex-end; }
    .totals-box{ width:58%; border:1px solid var(--line); border-radius:14px; padding:10px 11px; background:#fff; }
    .row{ display:flex; justify-content:space-between; padding:4px 0; font-size:11px; }
    .row .label{ color:var(--muted); }
    .row.total{ border-top:1px solid var(--line); margin-top:8px; padding-top:10px; font-size:13px; font-weight:1000; }

    .footer-bar{ border-top:1px solid var(--line); padding-top:4mm; display:flex; justify-content:space-between; gap:10px; color:var(--muted); font-size:9.5px; }
    .footer-right{text-align:right;}
    .page:after{ content:"Page " counter(page) " / " counter(pages); }

    .mini-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:5mm; }
    .badge-ok{ display:inline-block; padding:2px 8px; border-radius:999px; background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; font-weight:900; font-size:10px; }
    .stamp-wrap{ display:flex; gap:10px; align-items:flex-end; justify-content:flex-end; margin-top:6mm; }
    .stamp{ width:90px;height:90px; border:1px dashed var(--line); border-radius:14px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .stamp img{ width:100%; height:100%; object-fit:contain; }
  </style>
</head>

<body>

<header>
  <div class="header-bar">
    <div class="brand">
      <div class="logo">
        {% if company.logo_url %}
          <img src="{{ company.logo_url }}" alt="Logo">
        {% else %}
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--brand);font-weight:1000;">
            {{ company.name|default:"C"|slice:":1" }}
          </div>
        {% endif %}
      </div>
      <div>
        <div class="brand-name">
          {{ company.name|default:"—" }}
          {% if company.trade_name and company.trade_name != company.name %}
            <span style="font-weight:700;color:var(--muted);font-size:11px;"> • {{ company.trade_name }}</span>
          {% endif %}
        </div>
        <div class="brand-meta">
          {% if company.legal_form %}{{ company.legal_form }}{% endif %}
          {% if company.registration_number %}{% if company.legal_form %} • {% endif %}RCCM: {{ company.registration_number }}{% endif %}
          {% if company.tax_id %}{% if company.legal_form or company.registration_number %}<br>{% endif %}NIF/TVA: {{ company.tax_id }}{% endif %}
          {% if company.tax_center %}{% if company.tax_id %} • {% endif %}Centre: {{ company.tax_center }}{% endif %}
          {% if company.address %}<br>{{ company.address }}{% endif %}
          {% if company.phone %}<br>{{ company.phone }}{% endif %}
          {% if company.email %}{% if company.phone %} • {% endif %}{{ company.email }}{% endif %}
          {% if company.website %}<br>{{ company.website }}{% endif %}
        </div>
      </div>
    </div>

    <div class="doc">
      <div class="doc-title">DEVIS</div>
      <div class="doc-sub">
        N° <strong>{{ quote.number|default:quote.id }}</strong>
        • <span class="pill">{{ quote.get_status_display|default:quote.status|default:"—" }}</span>
      </div>
      <div class="doc-sub">
        Émis le <strong>{{ quote.issue_date|date:"d/m/Y"|default:"—" }}</strong>
        {% if quote.valid_until %} • Valable jusqu’au <strong>{{ quote.valid_until|date:"d/m/Y" }}</strong>{% endif %}
      </div>
    </div>
  </div>
</header>

<footer>
  <div class="footer-bar">
    <div>
      <strong style="color:var(--ink);">{{ company.name|default:"—" }}</strong>
      {% if company.address %} • {{ company.address }}{% endif %}
      {% if company.phone %} • {{ company.phone }}{% endif %}
      {% if company.email %} • {{ company.email }}{% endif %}
      <div style="margin-top:2px;">
        Document généré le {% now "d/m/Y H:i" %} • <span class="page"></span>
      </div>
      {% if company.footer_note %}
        <div style="margin-top:2px;">{{ company.footer_note }}</div>
      {% endif %}
    </div>
    <div class="footer-right">
      <div style="font-weight:900;color:var(--ink);">Merci pour votre confiance.</div>
      {% if company.website %}<div>{{ company.website }}</div>{% endif %}
    </div>
  </div>
</footer>

<div class="content">

  <div class="top-grid">
    <div class="card">
      <h3>Client</h3>
      <div class="big">{{ quote.partner.name|default:"—" }}</div>
      <div class="kv">
        {% if quote.partner.address %}<div><span class="muted">Adresse:</span> {{ quote.partner.address }}</div>{% endif %}
        {% if quote.partner.phone %}<div><span class="muted">Téléphone:</span> {{ quote.partner.phone }}</div>{% endif %}
        {% if quote.partner.email %}<div><span class="muted">Email:</span> {{ quote.partner.email }}</div>{% endif %}
        {% if not quote.partner.address and not quote.partner.phone and not quote.partner.email %}
          <div class="muted">Aucune info de contact.</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h3>Informations</h3>
      <div class="kv">
        <div><span class="muted">Devise:</span> {{ quote.currency|default:"XOF" }}</div>
        <div><span class="muted">Lignes:</span> {{ lines|length }}</div>
        <div><span class="muted">Référence:</span> {{ quote.id }}</div>
        {% if tenant.payment_terms_days and tenant.payment_terms_days > 0 %}
          <div><span class="muted">Paiement:</span> {{ tenant.payment_terms_days }} jours</div>
        {% else %}
          <div><span class="muted">Paiement:</span> payable à réception</div>
        {% endif %}
      </div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Désignation</th>
        <th class="right">Qté</th>
        <th class="right">PU</th>
        <th class="right">HT</th>
        <th class="right">TVA</th>
        <th class="right">TTC</th>
      </tr>
    </thead>
    <tbody>
      {% for l in lines %}
      <tr>
        <td><div class="desc">{{ l.label|default:"—" }}</div></td>
        <td class="right">{{ l.quantity|default:0 }}</td>
        <td class="right">{{ l.unit_price|floatformat:0|intcomma }} {{ quote.currency|default:"XOF" }}</td>
        <td class="right">{{ l.line_total|floatformat:0|intcomma }} {{ quote.currency|default:"XOF" }}</td>
        <td class="right">{{ l.tax_amount|floatformat:0|intcomma }} {{ quote.currency|default:"XOF" }}</td>
        <td class="right">{{ l.line_total|add:l.tax_amount|floatformat:0|intcomma }} {{ quote.currency|default:"XOF" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="6" style="padding:14px;color:var(--muted);">Aucune ligne.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="totals">
    <div class="totals-box">
      <div class="row">
        <div class="label">Sous-total (HT)</div>
        <div><strong>{{ subtotal|floatformat:0|intcomma }}</strong> {{ quote.currency|default:"XOF" }}</div>
      </div>
      <div class="row">
        <div class="label">TVA</div>
        <div><strong>{{ tax_total|floatformat:0|intcomma }}</strong> {{ quote.currency|default:"XOF" }}</div>
      </div>
      <div class="row total">
        <div>Total TTC</div>
        <div>{{ total|floatformat:0|intcomma }} {{ quote.currency|default:"XOF" }}</div>
      </div>
    </div>
  </div>

  {% if company.bank or company.mobile_money %}
  <div class="mini-grid">
    {% if company.bank %}
    <div class="card">
      <h3>Coordonnées bancaires</h3>
      <div class="kv">
        {% for k,v in company.bank.items %}
          {% if v %}<div><span class="muted">{{ k|capfirst }}:</span> {{ v }}</div>{% endif %}
        {% empty %}
          <div class="muted">—</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    {% if company.mobile_money %}
    <div class="card">
      <h3>Mobile Money</h3>
      <div class="kv">
        {% for k,v in company.mobile_money.items %}
          {% if v %}<div><span class="muted">{{ k|capfirst }}:</span> {{ v }}</div>{% endif %}
        {% empty %}
          <div class="muted">—</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  {% if quote.notes %}
  <div class="card" style="margin-top:5mm;">
    <h3>Notes</h3>
    <div class="kv">{{ quote.notes|linebreaksbr }}</div>
  </div>
  {% endif %}

  {% if company.stamp_url or company.signature_url %}
  <div class="stamp-wrap">
    {% if company.signature_url %}
      <div style="text-align:right;">
        <div class="muted" style="font-size:10px;margin-bottom:4px;">Signature</div>
        <div class="stamp"><img src="{{ company.signature_url }}" alt="Signature"></div>
      </div>
    {% endif %}
    {% if company.stamp_url %}
      <div style="text-align:right;">
        <div class="muted" style="font-size:10px;margin-bottom:4px;">Tampon</div>
        <div class="stamp"><img src="{{ company.stamp_url }}" alt="Tampon"></div>
      </div>
    {% endif %}
  </div>
  {% endif %}

</div>
</body>
</html>