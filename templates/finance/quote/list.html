{# /Users/ogahserge/Documents/Lyneerp/templates/finance/quote/list.html #}
{% extends "hr/base.html" %}
{% block page_content %}
<div x-data="financeListPage({
  title: 'Devis',
  subtitle: 'Propositions commerciales, lignes, totaux, statut',
  icon: 'fa-solid fa-file-signature',
  theme: 'indigo',
  endpoint: '/finance/api/quotes/',
  createUrl: "{% url 'finance:quotes:create' %}",
{#  detailUrlTpl: "{% url 'finance:quotes:detail' '0' %}",#}

  columns: [
    {key:'number', label:'N¬∞', mobile:true},
    {key:'partner_name', label:'Client', mobile:true},
    {key:'issue_date', label:'√âmis le', mobile:true},
    {key:'status', label:'Statut', mobile:true},
    {key:'total', label:'Total', align:'right', mobile:true},
  ]
})" x-init="init()" class="space-y-6">

  <!-- Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div class="min-w-0">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold shadow-sm border border-white/60 dark:border-slate-700/70 bg-indigo-600 text-white">
          <i :class="cfg.icon + ' text-[11px] opacity-90'"></i><span>Finance ‚Ä¢ Devis</span>
        </span>
        <span class="text-xs text-slate-500 dark:text-slate-400 truncate" x-text="cfg.subtitle"></span>
      </div>
      <h2 class="mt-3 text-2xl font-semibold text-slate-900 dark:text-white tracking-tight truncate" x-text="cfg.title"></h2>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <button @click="goCreate()"
              class="h-10 px-4 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium shadow-soft flex items-center gap-2">
        <i class="fa-solid fa-plus text-xs"></i><span>Nouveau</span>
      </button>
      <button @click="refresh()"
              class="h-10 px-4 rounded-full border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm shadow-sm hover:bg-gray-50 dark:hover:bg-slate-800 flex items-center gap-2">
        <i class="fa-solid fa-rotate text-xs"></i><span>Actualiser</span>
      </button>
      <button @click="exportCsv()"
              class="h-10 px-4 rounded-full border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm shadow-sm hover:bg-gray-50 dark:hover:bg-slate-800 flex items-center gap-2">
        <i class="fa-solid fa-file-export text-xs"></i><span>Export</span>
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="rounded-3xl border border-gray-200/70 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm">
    <div class="p-4 sm:p-5 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between gap-3">
      <div class="font-semibold text-slate-900 dark:text-white flex items-center gap-2">
        <i class="fa-solid fa-sliders text-slate-400"></i><span>Filtres</span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="resetFilters()"
                class="px-3 py-2 rounded-full border border-gray-300 dark:border-slate-700 text-xs hover:bg-gray-50 dark:hover:bg-slate-800">
          R√©initialiser
        </button>
        <button @click="applyFilters()"
                class="px-4 py-2 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium">
          Appliquer
        </button>
      </div>
    </div>

    <div class="p-4 sm:p-5 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3">
      <div class="lg:col-span-2">
        <label class="text-xs font-medium text-slate-500">Recherche</label>
        <div class="mt-1 relative">
          <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
          <input x-model.debounce.300ms="filters.q" type="text" placeholder="N¬∞ devis, client‚Ä¶"
                 class="w-full pl-9 pr-3 py-2 rounded-2xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm outline-none focus:ring-2 focus:ring-indigo-200"/>
        </div>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-500">Statut</label>
        <select x-model="filters.status"
                class="mt-1 w-full rounded-2xl border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2">
          <option value="">Tous</option>
          <option value="DRAFT">Brouillon</option>
          <option value="SENT">Envoy√©</option>
          <option value="ACCEPTED">Accept√©</option>
          <option value="REJECTED">Rejet√©</option>
          <option value="CANCELLED">Annul√©</option>
        </select>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-500">Devise </label>
        <select x-model="filters.currency"
                class="mt-1 w-full rounded-2xl border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2">
          <option value="">Toutes</option>
          <option value="XOF">XOF</option>
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-500">Du</label>
        <input type="date" x-model="filters.date_from"
               class="mt-1 w-full rounded-2xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2"/>
      </div>

      <div>
        <label class="text-xs font-medium text-slate-500">Au</label>
        <input type="date" x-model="filters.date_to"
               class="mt-1 w-full rounded-2xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm px-3 py-2"/>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="rounded-3xl border border-gray-200/70 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm overflow-hidden">
    <div class="p-4 sm:p-5 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between gap-3">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 rounded-2xl grid place-items-center bg-indigo-100 text-indigo-800 border border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-900/40">
          <i class="fa-solid fa-table"></i>
        </div>
        <div>
          <div class="font-semibold text-slate-900 dark:text-white">Liste</div>
          <div class="text-xs text-slate-500 dark:text-slate-400" x-text="metaText"></div>
        </div>
      </div>
    </div>

    <!-- Desktop -->
    <div class="hidden lg:block">
      <table class="w-full text-sm">
        <thead class="bg-gray-50 dark:bg-slate-800/60 text-slate-500 dark:text-slate-300">
        <tr>
          <template x-for="c in cfg.columns" :key="c.key">
            <th class="font-semibold px-5 py-3"
                :class="(c.align==='right'?'text-right':'text-left')"
                x-text="c.label"></th>
          </template>
          <th class="text-right font-semibold px-5 py-3 w-44">Actions</th>
        </tr>
        </thead>

        <tbody class="divide-y divide-gray-100 dark:divide-slate-800">
        <template x-for="r in rows" :key="r.id">
          <tr class="hover:bg-gray-50/70 dark:hover:bg-slate-800/40 transition">
            <td class="px-5 py-4">
              <div class="font-semibold text-slate-900 dark:text-white" x-text="r.number || ('QT-' + r.id)"></div>
              <div class="text-xs text-slate-500 dark:text-slate-400" x-text="`${(r.lines_count||0)} ligne(s) ‚Ä¢ TVA ${formatMoney(r.tax_total, r.currency)} ‚Ä¢ HT ${formatMoney(r.subtotal, r.currency)}`"></div>
            </td>

            <td class="px-5 py-4">
              <div class="font-medium text-slate-700 dark:text-slate-200" x-text="r.partner_name || '-'"></div>
              <div class="text-xs text-slate-400" x-text="(r.notes||'').slice(0,60)"></div>
            </td>

            <td class="px-5 py-4 text-slate-700 dark:text-slate-200" x-text="fmtDate(r.issue_date)"></td>

            <td class="px-5 py-4">
              <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold"
                    :class="statusPill(r.status).cls">
                <span class="w-2 h-2 rounded-full" :class="statusPill(r.status).dot"></span>
                <span x-text="statusPill(r.status).label"></span>
              </span>
            </td>

            <td class="px-5 py-4 text-right">
              <div class="font-semibold text-slate-900 dark:text-white" x-text="formatMoney(r.total, r.currency)"></div>
              <div class="text-xs text-slate-400" x-text="r.currency || '‚Äî'"></div>
            </td>

            <td class="px-5 py-4 text-right">
              <div class="inline-flex items-center justify-end gap-2">
                <button @click="goDetail(r)"
                        class="h-9 px-3 rounded-full border border-gray-200 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-800 text-xs">
                  <i class="fa-solid fa-eye mr-1"></i> Voir
                </button>
                <button @click="exportOne(r)"
                        class="h-9 px-3 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs">
                  <i class="fa-solid fa-file-pdf mr-1"></i> PDF
                </button>
              </div>
            </td>
          </tr>
        </template>

        <tr x-show="!loading && rows.length===0" x-cloak>
          <td :colspan="cfg.columns.length+1" class="px-5 py-12 text-center">
            <div class="text-3xl mb-2">üìù</div>
            <div class="font-semibold text-slate-900 dark:text-white">Aucun devis</div>
            <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">Ajustez les filtres ou cr√©ez un devis.</div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Mobile -->
    <div class="lg:hidden divide-y divide-gray-100 dark:divide-slate-800">
      <template x-for="r in rows" :key="'m:'+r.id">
        <div class="p-4">
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-semibold text-slate-900 dark:text-white truncate" x-text="r.number || ('QT-' + r.id)"></div>
              <div class="text-xs text-slate-500 dark:text-slate-400 truncate" x-text="r.partner_name || '-'"></div>
              <div class="text-xs text-slate-400 truncate" x-text="`${(r.lines_count||0)} lignes ‚Ä¢ ${fmtDate(r.issue_date)}`"></div>
            </div>
            <div class="text-right">
              <div class="font-semibold text-slate-900 dark:text-white" x-text="formatMoney(r.total, r.currency)"></div>
              <div class="text-xs text-slate-400" x-text="r.currency || ''"></div>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-2">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold"
                  :class="statusPill(r.status).cls">
              <span class="w-2 h-2 rounded-full" :class="statusPill(r.status).dot"></span>
              <span x-text="statusPill(r.status).label"></span>
            </span>

            <button @click="goDetail(r)" class="px-3 py-2 rounded-full border border-gray-300 dark:border-slate-700 text-xs">
              <i class="fa-solid fa-eye mr-1"></i> Voir
            </button>
          </div>
        </div>
      </template>
    </div>

    <!-- Pagination -->
    <div class="p-4 sm:p-5 border-t border-gray-100 dark:border-slate-800 flex items-center justify-between gap-3">
      <div class="text-xs text-slate-500 dark:text-slate-400" x-text="pageText"></div>
      <div class="flex items-center gap-2">
        <button @click="prevPage()" :disabled="page<=1 || loading"
                class="h-10 px-4 rounded-full border border-gray-300 dark:border-slate-700 disabled:opacity-50 hover:bg-gray-50 dark:hover:bg-slate-800 text-sm">
          <i class="fa-solid fa-chevron-left mr-1"></i> Pr√©c√©dent
        </button>
        <div class="h-10 px-4 rounded-full border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-900 grid place-items-center text-sm">
          <span x-text="page"></span>
        </div>
        <button @click="nextPage()" :disabled="!hasNext || loading"
                class="h-10 px-4 rounded-full border border-gray-300 dark:border-slate-700 disabled:opacity-50 hover:bg-gray-50 dark:hover:bg-slate-800 text-sm">
          Suivant <i class="fa-solid fa-chevron-right ml-1"></i>
        </button>
      </div>
    </div>
  </div>

</div>

<script>
function financeListPage(cfg){
  return {
    cfg,
    loading:false,
    rows:[],
    page:1,
    pageSize:20,
    hasNext:false,

    // ‚úÖ filtres pour Quote
    filters:{ q:'', status:'', currency:'', date_from:'', date_to:'' },

    get metaText(){ return `${this.rows.length} devis ‚Ä¢ page ${this.page}`; },
    get pageText(){ return `Page ${this.page}${this.hasNext ? ' ‚Ä¢ autre page disponible' : ''}`; },

    statusPill(s){
      const m = {
        DRAFT:{label:'Brouillon', cls:'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200', dot:'bg-slate-400'},
        SENT:{label:'Envoy√©', cls:'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-200', dot:'bg-blue-500'},
        ACCEPTED:{label:'Accept√©', cls:'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200', dot:'bg-emerald-500'},
        REJECTED:{label:'Rejet√©', cls:'bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-200', dot:'bg-rose-500'},
        CANCELLED:{label:'Annul√©', cls:'bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-200', dot:'bg-amber-500'},
      };
      return m[s] || {label:(s||'‚Äî'), cls:'bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-200', dot:'bg-slate-400'};
    },

    fmtDate(s){
      if(!s) return '‚Äî';
      try { return new Date(s).toLocaleDateString('fr-FR'); }
      catch { return '‚Äî'; }
    },

    toNum(v){
      const n = Number(String(v ?? '0').replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    },

    computeTotals(quote){
      const lines = Array.isArray(quote?.lines) ? quote.lines : [];
      let subtotal = 0;
      let tax_total = 0;
      for(const ln of lines){
        subtotal += this.toNum(ln?.line_total);
        tax_total += this.toNum(ln?.tax_amount);
      }
      const total = subtotal + tax_total;
      return { subtotal, tax_total, total, lines_count: lines.length };
    },

    formatMoney(v, cur){
      const currency = cur || 'XOF';
      const n = this.toNum(v);
      try { return new Intl.NumberFormat('fr-FR',{style:'currency',currency}).format(n); }
      catch { return `${n.toLocaleString('fr-FR')} ${currency}`; }
    },

    buildQuery(){
      const p = new URLSearchParams();
      p.set('page', String(this.page));
      p.set('page_size', String(this.pageSize));

      // ‚úÖ ton API DRF utilise search_fields => param "search"
      if(this.filters.q) p.set('search', this.filters.q);

      // ‚úÖ filterset_fields suppos√©s: status, currency
      if(this.filters.status) p.set('status', this.filters.status);
      if(this.filters.currency) p.set('currency', this.filters.currency);

      // ‚úÖ si tu as ajout√© le filtre dates dans get_queryset (optionnel)
      if(this.filters.date_from) p.set('date_from', this.filters.date_from);
      if(this.filters.date_to) p.set('date_to', this.filters.date_to);

      return p.toString();
    },

    async fetchList(){
      this.loading = true;
      try{
        const headers = {'Accept':'application/json'};

        // tenant header (si ton backend le supporte)
        const tid = localStorage.getItem('lyneerp_tenant') || '';
        if(tid) headers['X-Tenant-Id'] = tid;

        // auth
        const token = localStorage.getItem('lyneerp_token') || localStorage.getItem('kc_access_token') || '';
        if(token) headers['Authorization'] = `Bearer ${token}`;

        const url = `${this.cfg.endpoint}?${this.buildQuery()}`;
        const res = await fetch(url, {headers});
        const data = await res.json().catch(()=>null);
        if(!res.ok) throw new Error(data?.detail || `Erreur ${res.status}`);

        const list = Array.isArray(data?.results) ? data.results : [];

        // ‚úÖ enrichissement: totaux calcul√©s depuis lines[]
        this.rows = list.map(q => {
          const t = this.computeTotals(q);
          return { ...q, ...t };
        });

        this.hasNext = !!data?.next;
      }catch(e){
        console.error(e);
        if(window.hrToast) window.hrToast(e.message || 'Erreur chargement', 'error');
      }finally{
        this.loading = false;
      }
    },

    init(){ this.fetchList(); },
    refresh(){ this.fetchList(); },

    resetFilters(){
      this.filters = {q:'',status:'',currency:'',date_from:'',date_to:''};
      this.page = 1;
      this.fetchList();
    },

    applyFilters(){
      this.page = 1;
      this.fetchList();
      if(window.hrToast) window.hrToast('Filtres appliqu√©s','success');
    },

    prevPage(){ if(this.page<=1) return; this.page--; this.fetchList(); },
    nextPage(){ if(!this.hasNext) return; this.page++; this.fetchList(); },

    exportCsv(){
      // ‚úÖ export adapt√© aux quotes + totaux
      const cols = ['number','partner_name','issue_date','status','currency','subtotal','tax_total','total','lines_count'];
      const out=[cols.join(',')];
      for(const r of this.rows){
        const row = cols.map(k => `"${String(r[k] ?? '').replaceAll('"','""')}"`).join(',');
        out.push(row);
      }
      const blob=new Blob([out.join('\n')],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`quotes_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    },

    goCreate(){ if(this.cfg.createUrl && this.cfg.createUrl !== '#') window.location.assign(this.cfg.createUrl); },

    goDetail(row){
      if(!row) return;
      const tpl = this.cfg.detailUrlTpl || '';
      if(!tpl || tpl==='#') return;
      window.location.assign(tpl.replace('0', row.id));
    },

    exportOne(row){
      // ton API renvoie pdf_file: null ou chemin
      const url = row?.pdf_url || row?.pdf_file || '';
      if(url) return window.open(url,'_blank');
      if(window.hrToast) window.hrToast('PDF indisponible', 'warning');
    }
  }
}
</script>
{% endblock %}