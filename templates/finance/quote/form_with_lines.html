{# templates/finance/quote/form_with_lines.html #}
{% extends "hr/base.html" %}
{% load static humanize %}
{% block page_content %}

<style>
  /* petit helper pour éviter add_class */
  .fld{width:100%; border-radius: 16px; border:1px solid rgba(148,163,184,.45); background: transparent; padding:.55rem .8rem; font-size:.9rem;}
  .fld:focus{outline:none; box-shadow: 0 0 0 3px rgba(99,102,241,.18); border-color: rgba(99,102,241,.6);}
  .fld-area{min-height:110px;}
</style>

<div class="space-y-6" x-data="quoteFormPage()" x-init="init()">

  <!-- Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div class="min-w-0">
      <div class="flex items-center gap-2">
        <a href="{% url 'finance:quotes:list' %}"
           class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold shadow-sm border border-white/60 dark:border-slate-700/70 bg-indigo-600 text-white">
          <i class="fa-solid fa-file-signature text-[11px] opacity-90"></i>
          <span>Finance • Devis</span>
        </a>
        <span class="text-xs text-slate-500 dark:text-slate-400 truncate">Création / Modification</span>
      </div>

      <h2 class="mt-3 text-2xl font-semibold text-slate-900 dark:text-white tracking-tight truncate">
        <span x-text="title"></span>
      </h2>

      <div class="mt-2 text-xs text-slate-500 dark:text-slate-400">
        Renseignez les informations, ajoutez des lignes, puis enregistrez.
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <button type="button"
              @click="addLine()"
              class="h-10 px-4 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium shadow-soft inline-flex items-center gap-2">
        <i class="fa-solid fa-plus text-xs"></i><span>Ajouter une ligne</span>
      </button>

      <button type="button"
              @click="recompute()"
              class="h-10 px-4 rounded-full border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm shadow-sm hover:bg-gray-50 dark:hover:bg-slate-800 inline-flex items-center gap-2">
        <i class="fa-solid fa-calculator text-xs"></i><span>Recalculer</span>
      </button>

      <a href="{% url 'finance:quotes:list' %}"
         class="h-10 px-4 rounded-full border border-gray-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm shadow-sm hover:bg-gray-50 dark:hover:bg-slate-800 inline-flex items-center gap-2">
        <i class="fa-solid fa-arrow-left text-xs"></i><span>Retour</span>
      </a>
    </div>
  </div>

  <form method="post" novalidate class="space-y-4">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="rounded-2xl border border-rose-200 bg-rose-50 text-rose-800 p-4 text-sm">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    {% if formset.non_form_errors %}
      <div class="rounded-2xl border border-rose-200 bg-rose-50 text-rose-800 p-4 text-sm">
        {{ formset.non_form_errors }}
      </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- Card: Informations devis -->
      <div class="lg:col-span-2 rounded-3xl border border-gray-200/70 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm overflow-hidden">
        <div class="p-4 sm:p-5 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between">
          <div class="font-semibold text-slate-900 dark:text-white flex items-center gap-2">
            <i class="fa-solid fa-pen-nib text-slate-400"></i><span>Informations</span>
          </div>
          <span class="text-xs text-slate-500 dark:text-slate-400" x-text="metaText"></span>
        </div>

        <div class="p-4 sm:p-5 grid grid-cols-1 md:grid-cols-2 gap-4">

          <div>
            <label class="text-xs font-medium text-slate-500">Numéro</label>
            <div class="mt-1">
              {{ form.number }}
              {% if form.number.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.number.errors }}</div>{% endif %}
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500">Statut</label>
            <div class="mt-1">
              {{ form.status }}
              {% if form.status.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.status.errors }}</div>{% endif %}
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="text-xs font-medium text-slate-500">Client</label>
            <div class="mt-1">
              {{ form.partner }}
              {% if form.partner.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.partner.errors }}</div>{% endif %}
            </div>
            <div class="text-xs text-slate-400 mt-1">Sélectionnez un client existant.</div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500">Date d’émission</label>
            <div class="mt-1">
              {{ form.issue_date }}
              {% if form.issue_date.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.issue_date.errors }}</div>{% endif %}
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500">Valable jusqu’au</label>
            <div class="mt-1">
              {{ form.valid_until }}
              {% if form.valid_until.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.valid_until.errors }}</div>{% endif %}
            </div>
          </div>

          <div>
            <label class="text-xs font-medium text-slate-500">Devise</label>
            <div class="mt-1">
              {{ form.currency }}
              {% if form.currency.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.currency.errors }}</div>{% endif %}
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="text-xs font-medium text-slate-500">Notes</label>
            <div class="mt-1">
              {{ form.notes }}
              {% if form.notes.errors %}<div class="text-xs text-rose-600 mt-1">{{ form.notes.errors }}</div>{% endif %}
            </div>
          </div>

        </div>
      </div>

      <!-- Card: Totaux -->
      <div class="rounded-3xl border border-gray-200/70 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm overflow-hidden">
        <div class="p-4 sm:p-5 border-b border-gray-100 dark:border-slate-800">
          <div class="font-semibold text-slate-900 dark:text-white flex items-center gap-2">
            <i class="fa-solid fa-receipt text-slate-400"></i><span>Totaux</span>
          </div>
        </div>

        <div class="p-4 sm:p-5 space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-500 dark:text-slate-400">Sous-total (HT)</span>
            <span class="text-sm font-semibold text-slate-900 dark:text-white" x-text="money(totals.subtotal)"></span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-500 dark:text-slate-400">TVA</span>
            <span class="text-sm font-semibold text-slate-900 dark:text-white" x-text="money(totals.tax_total)"></span>
          </div>
          <div class="pt-3 border-t border-gray-100 dark:border-slate-800 flex items-center justify-between">
            <span class="text-sm font-semibold text-slate-700 dark:text-slate-200">Total TTC</span>
            <span class="text-lg font-semibold text-slate-900 dark:text-white" x-text="money(totals.total)"></span>
          </div>
          <div class="text-xs text-slate-500 dark:text-slate-400">
            <span x-text="totals.lines_count"></span> ligne(s)
          </div>
        </div>
      </div>
    </div>

    <!-- Lines -->
    <div class="rounded-3xl border border-gray-200/70 dark:border-slate-800 bg-white dark:bg-slate-900 shadow-sm overflow-hidden">
      <div class="p-4 sm:p-5 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <div class="w-10 h-10 rounded-2xl grid place-items-center bg-indigo-100 text-indigo-800 border border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-900/40">
            <i class="fa-solid fa-list"></i>
          </div>
          <div>
            <div class="font-semibold text-slate-900 dark:text-white">Lignes</div>
            <div class="text-xs text-slate-500 dark:text-slate-400" x-text="linesMeta"></div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <input x-model.debounce.200ms="q"
                 class="h-10 px-4 rounded-full border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
                 placeholder="Filtrer…"/>
          <button type="button"
                  @click="addLine()"
                  class="h-10 px-4 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium shadow-soft inline-flex items-center gap-2">
            <i class="fa-solid fa-plus text-xs"></i><span>Ajouter</span>
          </button>
        </div>
      </div>

      <div class="p-4 sm:p-5">
        {{ formset.management_form }}

        <div class="hidden lg:block">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 dark:bg-slate-800/60 text-slate-500 dark:text-slate-300">
              <tr>
                <th class="font-semibold px-4 py-3 text-left">Désignation</th>
                <th class="font-semibold px-4 py-3 text-right w-28">Qté</th>
                <th class="font-semibold px-4 py-3 text-right w-40">PU</th>
                <th class="font-semibold px-4 py-3 text-right w-32">TVA</th>
                <th class="font-semibold px-4 py-3 text-right w-44">HT</th>
                <th class="font-semibold px-4 py-3 text-right w-44">TTC</th>
                <th class="font-semibold px-4 py-3 text-right w-24"></th>
              </tr>
            </thead>

            <tbody class="divide-y divide-gray-100 dark:divide-slate-800">
              {% for f in formset.forms %}
                <tr class="align-top js-row">
                  {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}

                  <td class="px-4 py-3">
                    {% if f.label %}{{ f.label }}{% elif f.description %}{{ f.description }}{% endif %}
                    {% if f.product %}<div class="mt-2">{{ f.product }}</div>{% endif %}
                  </td>

                  <td class="px-4 py-3 text-right">
                    {% if f.quantity %}{{ f.quantity }}{% elif f.qty %}{{ f.qty }}{% endif %}
                  </td>

                  <td class="px-4 py-3 text-right">
                    {% if f.unit_price %}{{ f.unit_price }}{% endif %}
                  </td>

                  <td class="px-4 py-3 text-right">
                    {% if f.tax %}{{ f.tax }}{% elif f.tax_rate %}{{ f.tax_rate }}{% endif %}
                  </td>

                  <td class="px-4 py-3 text-right">
                    <div class="font-semibold text-slate-900 dark:text-white js-ln-ht">—</div>
                  </td>

                  <td class="px-4 py-3 text-right">
                    <div class="font-semibold text-slate-900 dark:text-white js-ln-ttc">—</div>
                  </td>

                  <td class="px-4 py-3 text-right">
                    {% if f.DELETE %}
                      <label class="inline-flex items-center gap-2 text-xs text-rose-700 dark:text-rose-200 cursor-pointer">
                        {{ f.DELETE }} <span>Suppr.</span>
                      </label>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="lg:hidden space-y-3">
          {% for f in formset.forms %}
            <div class="rounded-2xl border border-gray-200 dark:border-slate-800 p-4 js-card">
              {% for hidden in f.hidden_fields %}{{ hidden }}{% endfor %}

              <div class="space-y-3">
                <div>
                  <div class="text-xs font-medium text-slate-500">Désignation</div>
                  <div class="mt-1">
                    {% if f.label %}{{ f.label }}{% elif f.description %}{{ f.description }}{% endif %}
                  </div>
                  {% if f.product %}<div class="mt-2">{{ f.product }}</div>{% endif %}
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <div class="text-xs font-medium text-slate-500">Qté</div>
                    <div class="mt-1">
                      {% if f.quantity %}{{ f.quantity }}{% elif f.qty %}{{ f.qty }}{% endif %}
                    </div>
                  </div>
                  <div>
                    <div class="text-xs font-medium text-slate-500">PU</div>
                    <div class="mt-1">{% if f.unit_price %}{{ f.unit_price }}{% endif %}</div>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3 items-end">
                  <div>
                    <div class="text-xs font-medium text-slate-500">TVA</div>
                    <div class="mt-1">{% if f.tax %}{{ f.tax }}{% elif f.tax_rate %}{{ f.tax_rate }}{% endif %}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs font-medium text-slate-500">TTC</div>
                    <div class="font-semibold text-slate-900 dark:text-white js-ln-ttc">—</div>
                  </div>
                </div>

                <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-slate-800">
                  <div class="text-xs text-slate-500">HT: <span class="font-semibold text-slate-900 dark:text-white js-ln-ht">—</span></div>
                  {% if f.DELETE %}
                    <label class="inline-flex items-center gap-2 text-xs text-rose-700 dark:text-rose-200 cursor-pointer">
                      {{ f.DELETE }} <span>Supprimer</span>
                    </label>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

      </div>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
      <div class="text-xs text-slate-500 dark:text-slate-400">
        Total recalculé automatiquement quand vous modifiez Qté / PU / TVA.
      </div>

      <div class="flex items-center gap-2 justify-end">
        <button type="submit"
                class="h-11 px-5 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold shadow-soft inline-flex items-center gap-2">
          <i class="fa-solid fa-check text-xs"></i><span>Enregistrer</span>
        </button>
      </div>
    </div>
  </form>
</div>

<script>
function quoteFormPage(){
  return {
    q: '',
    currency: 'XOF',
    totals: {subtotal:0, tax_total:0, total:0, lines_count:0},

    init(){
      this.applyClasses();
      this.currency = (document.querySelector('[name="currency"]')?.value) || this.currency;

      document.addEventListener('input', (e) => {
        const el = e.target;
        if(!el) return;
        if(el.matches('input,select,textarea')){
          if(el.name === 'currency') this.currency = el.value || this.currency;
          this.recompute();
        }
      });

      this.recompute();
    },

    applyClasses(){
      // Apply base classes to all form controls without needing add_class
      const controls = document.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]), select, textarea');
      controls.forEach(el => {
        el.classList.add('fld');
        if(el.tagName === 'TEXTAREA') el.classList.add('fld-area');
      });

      // tag line inputs for JS calculations
      const rows = document.querySelectorAll('.js-row, .js-card');
      rows.forEach(container => {
        // best-effort: detect by name endings from formset
        const qty = container.querySelector('input[name$="-quantity"], input[name$="-qty"]');
        const unit = container.querySelector('input[name$="-unit_price"]');
        const taxrate = container.querySelector('input[name$="-tax_rate"]');
        const label = container.querySelector('input[name$="-label"], input[name$="-description"], textarea[name$="-description"]');

        if(qty) qty.classList.add('js-ln-qty');
        if(unit) unit.classList.add('js-ln-unit');
        if(taxrate) taxrate.classList.add('js-ln-taxrate');
        if(label) label.classList.add('js-ln-label');

        const tax = container.querySelector('select[name$="-tax"]');
        if(tax) tax.classList.add('js-ln-tax');
      });
    },

    get title(){
      const n = document.querySelector('[name="number"]')?.value || '';
      return n ? `Devis ${n}` : 'Nouveau devis';
    },

    get metaText(){
      return `${this.totals.lines_count} ligne(s) • ${this.money(this.totals.total)}`;
    },

    get linesMeta(){
      return `HT ${this.money(this.totals.subtotal)} • TVA ${this.money(this.totals.tax_total)} • TTC ${this.money(this.totals.total)}`;
    },

    toNum(v){
      const n = Number(String(v ?? '0').replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    },

    money(v){
      const currency = this.currency || 'XOF';
      const n = this.toNum(v);
      try { return new Intl.NumberFormat('fr-FR',{style:'currency',currency}).format(n); }
      catch { return `${n.toLocaleString('fr-FR')} ${currency}`; }
    },

    _isDeleted(container){
      const del = container.querySelector('input[type="checkbox"][name$="-DELETE"]');
      return del ? !!del.checked : false;
    },

    _vals(container){
      const qty = container.querySelector('.js-ln-qty');
      const unit = container.querySelector('.js-ln-unit');
      const taxrate = container.querySelector('.js-ln-taxrate');

      const q = this.toNum(qty?.value);
      const pu = this.toNum(unit?.value);
      const rate = this.toNum(taxrate?.value); // si tu utilises un FK tax, alors rate=0 ici

      const ht = q * pu;
      const tva = ht * (rate/100);
      const ttc = ht + tva;
      return {ht,tva,ttc};
    },

    recompute(){
      let subtotal=0, tax_total=0, total=0, count=0;

      const containers = document.querySelectorAll('.js-row, .js-card');
      containers.forEach(c => {
        if(this._isDeleted(c)) return;
        const v = this._vals(c);
        subtotal += v.ht; tax_total += v.tva; total += v.ttc; count += 1;

        const htEl = c.querySelector('.js-ln-ht');
        const ttcEl = c.querySelector('.js-ln-ttc');
        if(htEl) htEl.textContent = this.money(v.ht);
        if(ttcEl) ttcEl.textContent = this.money(v.ttc);
      });

      this.totals = {subtotal, tax_total, total, lines_count: count};
    },

    addLine(){
      // Ajouter une ligne dynamiquement : nécessite un empty_form/template.
      // Ici on garde simple (sinon on casse le formset). Ajoute une ligne côté serveur.
      if(window.hrToast) window.hrToast("Ajout dynamique désactivé (formset). Ajoute une ligne puis recharge, ou je te génère le template empty_form propre.", "info");
    },
  }
}
</script>

{% endblock %}