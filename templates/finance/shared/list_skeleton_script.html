<script>
function genericList(cfg){
  return {
    cfg,
    loading:false,
    currency:'XOF',
    rows:[],
    page:1,
    pageSize:20,
    hasNext:false,
    filters:{ q:'', status:'', date_from:'', date_to:'' },

    get metaText(){ return `${this.rows.length} ligne(s) • page ${this.page}`; },
    get pageText(){ return `Page ${this.page}${this.hasNext ? ' • autre page disponible' : ''}`; },

    fmtDate(s){ if(!s) return '—'; try{return new Date(s).toLocaleDateString('fr-FR');}catch{return '—'}; },
    formatMoney(v){
      const n=Number(v||0);
      try { return new Intl.NumberFormat('fr-FR',{style:'currency',currency:this.currency}).format(n); }
      catch { return `${n.toLocaleString('fr-FR')} ${this.currency}`; }
    },

    renderCell(row, key){
      if(!key) return '—';
      const r = row || {};
      const direct = r[key];
      if (direct !== undefined && direct !== null && direct !== '') return this._stringify(key, direct);

      // Fallbacks intelligents
      const map = {
        number: r.number || r.code || r.reference || r.name,
        reference: r.reference || r.code || r.number,
        vendor: r.vendor_name || r.vendor?.name || r.supplier_name || r.partner_name,
        customer: r.customer_name || r.customer?.name || r.partner_name,
        employee: r.employee_name || r.employee?.name || r.user?.username,
        journal: r.journal_code || r.journal?.code || r.journal?.name,
        period: r.period_name || r.period?.name,
        pair: r.pair || ((r.base_currency && r.quote_currency) ? `${r.base_currency}/${r.quote_currency}` : ''),
        bank: r.bank_name || r.bank?.name,
        method: r.method || r.payment_method,
        status: r.status || r.state,
        total: r.total_amount || r.total,
        amount: r.amount || r.total_amount || r.total,
        debit: r.debit || r.total_debit,
        credit: r.credit || r.total_credit,
        date: r.date || r.issued_at || r.created_at,
        bill_date: r.bill_date || r.date || r.issued_at,
        due_date: r.due_date,
        scheduled_date: r.scheduled_date || r.date,
        rate: r.rate,
        balance: r.balance || r.current_balance,
        is_active: (r.is_active === true) ? 'Oui' : (r.is_active === false ? 'Non' : (r.active === true ? 'Oui' : (r.active === false ? 'Non' : '—'))),
        is_open: (r.is_open === true) ? 'Oui' : (r.is_open === false ? 'Non' : '—'),
        is_current: (r.is_current === true) ? 'Oui' : (r.is_current === false ? 'Non' : '—'),
        last_sync: r.last_sync || r.last_synced_at,
        accounts_count: r.accounts_count ?? r.accounts?.length,
        by: r.by || r.closed_by || r.user?.username,
        scope: r.scope || r.type,
      };

      const v = map[key];
      if (v === undefined || v === null || v === '') return '—';
      return this._stringify(key, v);
    },

    _stringify(key, v){
      if (key.includes('date') || key.endsWith('_at') || key === 'as_of') return this.fmtDate(v);
      if (key === 'total' || key === 'amount' || key === 'balance' || key === 'debit' || key === 'credit') return this.formatMoney(v);
      if (typeof v === 'object') return (v.name || v.code || JSON.stringify(v));
      return String(v);
    },

    buildQuery(){
      const p=new URLSearchParams();
      p.set('page', String(this.page));
      p.set('page_size', String(this.pageSize));
      if(this.filters.q) p.set('search', this.filters.q);
      if(this.filters.status) p.set('status', this.filters.status);
      if(this.filters.date_from) p.set('date_from', this.filters.date_from);
      if(this.filters.date_to) p.set('date_to', this.filters.date_to);
      return p.toString();
    },

    async fetchList(){
      this.loading=true;
      try{
        const headers={'Accept':'application/json'};
        const tid=localStorage.getItem('lyneerp_tenant')||'';
        if(tid) headers['X-Tenant-Id']=tid;
        const token=localStorage.getItem('lyneerp_token')||localStorage.getItem('kc_access_token')||'';
        if(token) headers['Authorization']=`Bearer ${token}`;

        const url = `${this.cfg.endpoint}?${this.buildQuery()}`;
        const res = await fetch(url, {headers});
        const data = await res.json().catch(()=>null);
        if(!res.ok) throw new Error(data?.detail || `Erreur ${res.status}`);

        const list = data?.results || data || [];
        this.rows = Array.isArray(list) ? list : [];
        this.hasNext = !!data?.next;
        this.currency = data?.currency || this.rows?.[0]?.currency || this.currency;
      }catch(e){
        if(window.hrToast) window.hrToast(e.message || 'Erreur chargement', 'error');
      }finally{
        this.loading=false;
      }
    },

    init(){ this.fetchList(); },
    refresh(){ this.fetchList(); },
    resetFilters(){ this.filters={q:'',status:'',date_from:'',date_to:''}; this.page=1; this.fetchList(); },
    applyFilters(){ this.page=1; this.fetchList(); if(window.hrToast) window.hrToast('Filtres appliqués','success'); },

    prevPage(){ if(this.page<=1) return; this.page--; this.fetchList(); },
    nextPage(){ if(!this.hasNext) return; this.page++; this.fetchList(); },

    exportCsv(){
      const cols = (this.cfg.columns||[]).map(c=>c.key);
      const out=[cols.join(',')];
      for(const r of this.rows){
        const line = cols.map(k => `"${(this.renderCell(r,k)??'').toString().replaceAll('"','""')}"`).join(',');
        out.push(line);
      }
      const blob=new Blob([out.join('\n')],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`${(this.cfg.title||'export').toLowerCase().replaceAll(' ','_')}_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    },

    goCreate(){ if(this.cfg.createUrl && this.cfg.createUrl !== '#') window.location.assign(this.cfg.createUrl); },
    goDetail(row){
      if(!row) return;
      const tpl=this.cfg.detailUrlTpl||'';
      if(!tpl || tpl==='#') return;
      window.location.assign(tpl.replace('0', row.id));
    },
  }
}
</script>