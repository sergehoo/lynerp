{% extends "hr/base.html" %}
{% block page_content %}

<script>
  // URL sûre (pas de pk factice)
  const BANK_TRANSACTIONS_BASE_URL = "{% url 'finance:bank_transactions:list' %}";
</script>

<div x-data="genericList({
  title:'Transactions bancaires',
  subtitle:'Mouvements importés, catégorisation, rapprochement',
  icon:'fa-solid fa-money-bill-transfer',
  theme:'orange',
  endpoint:'/api/finance/bank-transactions/',
  createUrl:"#",
  baseDetailUrl: BANK_TRANSACTIONS_BASE_URL,  /* ✅ remplace detailUrlTpl */
  columns:[
    {key:'date', label:'Date', mobile:true},
    {key:'bank', label:'Banque', mobile:true},
    {key:'label', label:'Libellé', mobile:true},
    {key:'status', label:'Statut', mobile:true},
    {key:'amount', label:'Montant', align:'right', mobile:true},
    {key:'balance', label:'Solde', align:'right', mobile:false},
  ]
})" x-init="init()" class="space-y-6">
  {% include "finance/shared/list_skeleton.html" %}
</div>

{% include "finance/shared/list_skeleton_script.html" %}

<script>
/**
 * UUID-safe navigation patch (à centraliser idéalement dans list_skeleton_script.html)
 */
(function(){
  if (typeof window.genericList !== "function") return;

  const _orig = window.genericList;

  window.genericList = function(cfg){
    const api = _orig(cfg);

    const toast = (msg, type='info') => {
      if (window.hrToast) return window.hrToast(msg, type);
      console[type === 'error' ? 'error' : 'log'](msg);
    };

    const normalizeBase = (u) => (u || '').endsWith('/') ? u : (u + '/');

    api.goDetail = function(row){
      if (!row?.id){
        toast("ID manquant pour ouvrir le détail", "error");
        return;
      }
      const base = normalizeBase(cfg.baseDetailUrl || '');
      if (!base){
        toast("baseDetailUrl non configuré", "error");
        return;
      }
      window.location.assign(`${base}${row.id}/`);
    };

    // createUrl est "#": pas de création, on bloque proprement
    api.goCreate = function(){
      toast("Création indisponible pour les transactions bancaires", "info");
    };

    return api;
  };
})();
</script>

{% endblock %}